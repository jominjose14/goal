(()=>{function Ge(o){let t=e.context,n=.03*i.height,r=.05*i.height,s=t.measureText(o).width,c=1.25*r,a=(i.width-s)/2,d=(i.height+c-n)/2,m=(i.width-s)/2-n,h=(i.height-c)/2-n,S=s+2*n,le=c+2*n,Y=.03*i.height;t.fillStyle="hsla(0, 0%, 20%, 0.95)",t.beginPath(),t.moveTo(m+Y,h),t.arcTo(m+S,h,m+S,h+le,Y),t.arcTo(m+S,h+le,m,h+le,Y),t.arcTo(m,h+le,m,h,Y),t.arcTo(m,h,m+S,h,Y),t.closePath(),t.fill(),t.beginPath(),t.font=`${r}px "Protest Riot", "Trebuchet MS", sans-serif`,t.textAlign="start",t.textBaseline="alphabetic",t.fillStyle="hsla(0, 0%, 100%, 0.25)",t.fillText(o,a,d),t.closePath()}function f(o,t,n){return Math.max(o,Math.min(t,n))}function Fe(){let o=navigator.userAgent;return/Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/.test(o)}function u(o){o.classList.remove("hidden")}function p(o){o.classList.add("hidden")}function K(){for(let o of document.querySelectorAll(".menu"))p(o)}function V(){u(A),A.showModal(),A.blur()}function b(){p(A),A.close()}function G(o){clearTimeout(e.toastTimeoutId),p($),$.querySelector(".toast-msg").textContent=o,$.style.right-=$.width,u($),e.toastTimeoutId=setTimeout(()=>p($),qe)}function L(o){return o[0].toUpperCase()+o.substring(1)}function R(o){return o=Math.floor(o*ve),o}function I(o){return o/ve}function we(o){return isNaN(o.textContent)?0:f(0,parseInt(o.textContent),999)}function Ce(o){let t=o.textContent;isNaN(t)&&(t=-1),o.textContent=(parseInt(t)+1).toString(),Ue(o)}function Te(o,t){let n=o.textContent;isNaN(n)&&(n=0),o.textContent=t.toString(),parseInt(n)!==t&&Ue(o)}function Ue(o){o.classList.remove("strobing-score"),o.offsetWidth,o.classList.add("strobing-score")}function W(o){o.closest("dialog").close()}var P=class o{#o;#t;#s;#e;#n;constructor(t,n,r){if(!t||typeof t!="string"){console.error(`Invalid css selector ${t}`);return}if(n==null||typeof n!="string"){console.error(`Invalid initial value passed for initialization of text selector ${t}`);return}if(r==null||!Array.isArray(r)||r.length===0){console.error(`Invalid array of valid values passed for initialization of text selector ${t}`);return}if(this.#n=r.indexOf(n),this.#n===-1){console.error(`Error during initialization of text selector ${t}: invalid initial value ${n}, because array of valid values does not include initial value`);return}this.#o=t,this.#t=document.querySelectorAll(t),this.#s=r,this.#e=r;for(let s of this.#t)s.textContent=L(n),s.dataset.values=r.join(","),s.onclick=()=>o.onClick(this)}static onClick(t){t.#n=(t.#n+1)%t.#e.length;for(let n of t.#t)n.textContent=L(t.#e[t.#n])}getValue(){return this.#e[this.#n]}updateSelectableValues(t){if(t==null||!Array.isArray(t)||t.length===0){console.error(`Invalid array of values passed to update selectable values of text selector ${this.#o}`);return}for(let n of t)if(!this.#s.includes(n)){console.error(`Invalid value ${n} passed to update selectable values of text selector ${this.#o}`);return}this.#e=t;for(let n of this.#t)n.textContent=L(this.#e[0])}};var z=class o{#o;$domNodes;#t;selectableValues;currIdx;static onClick(t){t.currIdx=(t.currIdx+1)%t.selectableValues.length;for(let n of t.$domNodes){let r=`striker${t.selectableValues[t.currIdx]}`,s=n.querySelector("circle");s.classList.remove(s.classList.item(0)),s.classList.add(r)}}constructor(t,n){if(!t||typeof t!="string"){console.error("Invalid css selector");return}if(n==null||typeof n!="number"||T<=n){console.error("Invalid initial value passed in for text selector initialization");return}this.#o=t,this.$domNodes=document.querySelectorAll(t);let r=[];for(let s=0;s<T;s++)r[s]=s;this.#t=r,this.selectableValues=r,this.currIdx=n;for(let s of this.$domNodes)s.onclick=()=>o.onClick(this)}getValue(){return this.selectableValues[this.currIdx]}updateSelectableValues(t){if(t==null||!Array.isArray(t)||t.length===0){console.error(`Invalid array of values passed to update selectable values of striker selector ${this.#o}`);return}for(let n of t)if(T<=n){console.error(`Invalid value ${n} passed to update selectable values of striker selector ${this.#o}`);return}this.selectableValues=t;for(let n of this.$domNodes){let r=`striker${this.selectableValues[0]}`,s=n.querySelector("circle");s.classList.remove(s.classList.item(0)),s.classList.add(r)}}};var l=!1,je=Fe(),J=new URL(window.location.href).host,F=10,Me=10,T=4;var At=3,ve=Math.pow(10,At),He=60;var be=6e4,w={clientError:{code:3001,reason:"Client-side error"},serverInactivity:{code:3002,reason:"Server inactivity timeout"},wrongChannel:{code:3003,reason:"Wrong channel"},rejectedUsername:{code:3004,reason:"Username rejected by server"}},v=document.querySelector(".menu.home"),Xe=document.querySelector(".menu.settings"),ue=document.querySelector(".menu.offline"),g=document.querySelector(".menu.online"),B=document.querySelector(".menu.host"),C=document.querySelector(".menu.join"),U=document.querySelector(".menu.rotate-screen"),N=document.getElementById("master-volume-slider"),de=document.getElementById("music-volume-slider"),me=document.getElementById("sfx-volume-slider"),y=document.querySelector(".menu.pause"),Q=document.querySelector(".message"),Z=document.querySelector(".scores"),q=document.getElementById("left-score"),j=document.getElementById("right-score"),he=[document.querySelector(".menu.home .mute-toggle-btn"),document.querySelector(".menu.pause .mute-toggle-btn")],pe=[document.querySelector(".menu.home .fullscreen-toggle-btn"),document.querySelector(".menu.pause .fullscreen-toggle-btn")],ao=document.querySelector(".fps-display"),A=document.querySelector(".loading-spinner"),$=document.querySelector(".toast"),i=document.getElementById("board"),M=.008,O=.014,Ye=320/900,Ke=580/900,We=.015,ze=.0225,Je="hsla(0, 0%, 100%, 1)",Re=60,ee=1,Qe=.999,Ze=.999,et=10,tt=150,qe=3e3,te=1,fe=.9,ge=.8,Vt=["dark","light"],oe=["left","right"],Ie=["easy","medium","hard"],$t=["one","two"],ot=["human","ai","remote"],nt=["human","ai"],st=[{name:"G",color:"hsla(190, 100%, 50%, 1)"},{name:"O",color:"hsla(120, 100%, 50%, 1)"},{name:"A",color:"hsla(53, 100%, 50%, 1)"},{name:"L",color:"hsla(35, 100%, 50%, 1)"}],e={remoteState:{channel:"state",userName:"",isHost:!1,team:"",striker:0,playerXPos:0,playerYPos:0,playerXVel:0,playerYVel:0,puckXPos:0,puckYPos:0,puckXVel:0,puckYVel:0,leftScore:0,rightScore:0},connTimeoutMetrics:{prevMsgTimestamp:0,intervalId:-1},webSocketConn:null,userName:null,isOnlineGame:!1,isHost:!1,context:i.getContext("2d"),prevCanvasDim:{width:i.width,height:i.height},fpsMetrics:{canvasFpsCounter:0,prevFrameTimestamp:0},stuckPuckMetrics:{startTimestamp:0,prevCheckTimestamp:0,secondsCounter:0,stuckDuration:0,wasPuckOnLeftSide:!1},fps:60,isGoal:!0,isPaused:!1,isGameOver:!0,mainPlayer:null,players:[],puck:null,pointingDevice:{x:0,y:0},prevMasterGainValue:te,toastTimeoutId:-1},it=new P("#create-room-player-type-selector","human",nt),rt=new P("#join-room-player-type-selector","human",nt),ne=new P("#offline-team-selector","left",oe),at=new P("#create-room-team-selector","left",oe),Ne=new P("#join-room-team-selector","left",oe),ye=new P(".difficulty-selector","medium",Ie),ct=new P(".players-per-team-selector","two",$t),co=new P(".theme-selector","dark",Vt),lt=new z("#create-room-striker-selector",0),Oe=new z("#join-room-striker-selector",0);var x=class{#o;#t;#s;#e;#n;#r;#i;#a;#l=0;#u=0;#c;prevCollisionTimestamp=0;constructor(t,n,r,s){this.#o=t,this.resetRadius(),this.#s=n,this.#e=r,this.#n=s,this.#r=ye.getValue(),this.#c=Ze}get name(){return this.#o}set name(t){if(F<t.length){l&&console.error(`Cannot set player ${this.name}'s name to invalid value ${t}. Min length is 1 and max length is ${F}`);return}this.#o=t}get radius(){return this.#t}get strikerIdx(){return this.#s}set strikerIdx(t){if(t<0||T<=t){l&&console.error(`Cannot set player ${this.name}'s strikerId to invalid value ${t}. Min value is 0 and max value is ${T-1}`);return}this.#s=t}get team(){return this.#e}set team(t){if(t=t.toLowerCase(),!oe.includes(t)){l&&console.error(`Cannot set player ${this.name}'s team to invalid value ${t}`);return}this.#e=t}get type(){return this.#n}set type(t){if(t=t.toLowerCase(),!ot.includes(t)){l&&console.error(`Cannot set player ${this.name}'s type to invalid value ${t}`);return}this.#n=t}get intelligence(){return this.#r}set intelligence(t){if(t=t.toLowerCase(),!Ie.includes(t)){l&&console.error(`Cannot set player ${this.name}'s intelligence to invalid value ${t}`);return}this.#r=t}get xPos(){return this.#i}set xPos(t){if(!isNaN(t))if(this.#e==="left"){let n=M*i.width+this.#t,r=i.width/2-this.#t;this.#i=f(n,t,r)}else{let n=i.width/2+this.#t,r=i.width*(1-M)-this.#t;this.#i=f(n,t,r)}}get yPos(){return this.#a}set yPos(t){if(isNaN(t))return;let n=O*i.height+this.#t,r=i.height*(1-O)-this.#t;this.#a=f(n,t,r)}get xVel(){return this.#l}set xVel(t){if(isNaN(t))return;let n=Math.abs(t),r=2*e.fps/60;this.#l=Math.sign(t)*Math.min(n,e.fps/r)}get yVel(){return this.#u}set yVel(t){if(isNaN(t))return;let n=Math.abs(t),r=2*e.fps/60;this.#u=Math.sign(t)*Math.min(n,e.fps/r)}addToBoard(){e.players.push(this)}removeFromBoard(){let t=e.players.indexOf(this);t>-1&&e.players.splice(t,1)}resetRadius(){this.#t=ze*i.width}adaptToScreen(){this.xPos=i.width*this.xPos/e.prevCanvasDim.width,this.yPos=i.height*this.yPos/e.prevCanvasDim.height,this.resetRadius()}reset(){this.resetRadius(),this.#e==="left"?this.xPos=.05*i.width:this.xPos=.95*i.width,this.yPos=i.height/2,this.xVel=0,this.yVel=0}updatePosByAcceleratingTo(t,n){let r=t-this.xPos,s=n-this.yPos,c=.35;this.xVel=c*r,this.yVel=c*s,this.xPos+=this.xVel,this.yPos+=this.yVel}easyAiUpdate(){if(e.puck.xPos===i.width/2&&e.puck.yPos===i.height/2)return;if(this.#e==="right"&&e.puck.xPos+e.puck.radius<i.width/2||this.#e==="left"&&i.width/2<e.puck.xPos+e.puck.radius){this.xVel*=.99,this.yVel*=.99;return}if(this.#e==="right"&&-1<Math.sign(e.puck.xVel)||this.#e==="left"&&Math.sign(e.puck.xVel)<1){let s=e.puck.yPos-this.yPos;Math.abs(s)<=.8*(this.radius+e.puck.radius)?this.yVel*=.99:this.yVel=.2*s}this.xPos=this.#e==="right"?.9*i.width:.1*i.width,this.yPos+=this.yVel;let r=10*60/e.fps;this.xVel=(this.team==="right"?-1:1)*Math.max(r,Math.abs(this.xVel))}mediumAiUpdate(){if(e.puck.xPos===i.width/2&&e.puck.yPos===i.height/2)return;let t=this.#e==="right"&&e.puck.xPos+e.puck.radius<i.width/2||this.#e==="left"&&i.width/2<e.puck.xPos+e.puck.radius,n=this.#e==="right"&&this.xPos<e.puck.xPos||this.#e==="left"&&e.puck.xPos<this.xPos,r=this.#e==="right"&&Math.sign(e.puck.xVel)===-1||this.#e==="left"&&Math.sign(e.puck.xVel)===1,s=10*e.fps/60;if(t||n){let c=t?.05:.1;if(this.#e==="right"){let a=i.width*(1-M)-this.radius-this.xPos;this.xVel=c*a}else if(this.#e==="left"){let a=i.width*M+this.radius-this.xPos;this.xVel=c*a}this.yVel=c*(i.height/2-this.yPos)}else if(r&&s<Math.abs(e.puck.xVel))this.xVel*=.99,this.yVel*=.99;else{let c=e.puck.xPos-this.xPos,a=e.puck.yPos-this.yPos,d=.0075,m,h=Math.random();h<.5?m=.35:.5<=h&&h<=.8?m=.2:m=.1,this.xVel+=d*c,this.yVel=m*a}this.xPos+=this.xVel,this.yPos+=this.yVel}hardAiUpdate(){if(e.isGoal)return;let t=this.team==="right"?.9*i.width:.1*i.width,n=i.height/2-e.puck.yPos,r=(i.height*(1-2*O)-2*this.radius)/2,s=e.puck.yPos+e.puck.radius*n/r;this.updatePosByAcceleratingTo(t,s),this.xVel=(this.team==="right"?-1:1)*Math.max(10*60/e.fps,Math.abs(this.xVel)),this.yVel=(e.puck.yPos<this.yPos?-1:1)*Math.max(10*60/e.fps,Math.abs(this.yVel))}update(){if(this.type==="ai")switch(this.intelligence){case"easy":this.easyAiUpdate();break;case"medium":this.mediumAiUpdate();break;case"hard":this.hardAiUpdate()}else this.type==="human"&&(this.xVel*=this.#c,this.yVel*=this.#c,this.updatePosByAcceleratingTo(e.pointingDevice.x,e.pointingDevice.y));this.draw()}draw(){let t=e.context;t.beginPath(),t.arc(this.#i,this.#a,this.#t,0,2*Math.PI,!1),t.fillStyle="hsla(0, 0%, 100%, 1)",t.fill(),t.closePath(),t.beginPath(),t.arc(this.#i,this.#a,.8*this.#t,0,2*Math.PI,!1),t.fillStyle=st[this.#s].color,t.fill(),t.closePath()}};var H=new(window.AudioContext||window.webkitAudioContext),E=H.createGain(),se=H.createGain(),ie=H.createGain(),ut={bgm:"audio/bgm.mp3",buttonPress:"audio/button-press.mp3",boardHit:"audio/board-hit.mp3",playerHit:"audio/player-hit.mp3",goal:"audio/goal.mp3"};se.gain.value=fe;ie.gain.value=ge;E.gain.value=te;se.connect(E);ie.connect(E);E.connect(H.destination);var dt=new Map;function Lt(o,t){fetch(t).then(n=>n.arrayBuffer()).then(n=>H.decodeAudioData(n)).then(n=>{dt.set(o,n)}).catch(n=>console.error(`Error loading sound ${o}. Reason: `,n))}function mt(){for(let o of Object.keys(ut))Lt(o,ut[o])}function k(o,t){let n=H.createBufferSource();return n.buffer=dt.get(o),n.buffer===null?!1:(o==="bgm"?n.connect(se):n.connect(ie),n.loop=t,n.start(0),!0)}var Ee={fullscreen:null,muted:null,rotateScreen:null,settings:null,unmuted:null,windowed:null};function Bt(){for(let o of Object.keys(Ee))Ee[o]=document.getElementById(`svg-template-${o}`)}function Dt(){document.querySelectorAll(".mute-toggle-btn").forEach(o=>o.appendChild(_("unmuted"))),document.querySelectorAll(".fullscreen-toggle-btn").forEach(o=>o.appendChild(_("fullscreen"))),document.querySelectorAll(".settings-btn").forEach(o=>o.appendChild(_("settings"))),document.querySelectorAll("dialog.rotate-screen").forEach(o=>o.insertBefore(_("rotateScreen"),o.firstChild))}function ht(){Bt(),Dt()}function _(o){let t=Ee[o].content.cloneNode(!0),n=t.querySelector("*");return n.dataset.type=o,t}function pt(){p(v),g.querySelector(".error-msg").textContent="",u(g),document.getElementById("user-name").focus()}function ft(){p(v),u(ue)}function _e(){k("bgm",!0)&&document.removeEventListener("click",_e)}function gt(){for(let t of he){let n=t.querySelector("svg");n.dataset.type==="unmuted"?(t.innerHTML="",t.appendChild(_("muted")),N.disabled=!0,N.style.cursor="not-allowed"):n.dataset.type==="muted"&&(t.innerHTML="",t.appendChild(_("unmuted")),N.disabled=!1,N.style.cursor="grab")}let o=E.gain.value;E.gain.value=E.gain.value===0?e.prevMasterGainValue:0,e.prevMasterGainValue=o}function Ae(){for(let o of pe)document.fullscreenElement?document.exitFullscreen&&(o.innerHTML="",o.appendChild(_("fullscreen"))):(o.innerHTML="",o.appendChild(_("windowed")));document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}function yt(){p(v),u(Xe)}function xt(o){e.webSocketConn!==null&&(e.webSocketConn.close(),D());let t=o.closest(".menu");p(t),u(v)}function Ve(o){o===void 0&&window.innerWidth<window.innerHeight||o!==void 0&&o.target.type.includes("portrait")?(u(U),U.showModal(),U.blur()):(o===void 0&&window.innerHeight<window.innerWidth||o!==void 0&&o.target.type.includes("landscape"))&&(p(U),W(U))}function xe(o){o.id==="master-volume-slider"?E.gain.value=f(0,o.value/100,1):o.id==="music-volume-slider"?se.gain.value=f(0,o.value/100,1):o.id==="sfx-volume-slider"&&(ie.gain.value=f(0,o.value/100,1))}async function kt(){g.querySelector(".error-msg").textContent="",V(),await Le(),b(),e.webSocketConn!==null&&(p(g),u(B),document.getElementById("create-room-name").focus())}async function St(){g.querySelector(".error-msg").textContent="",V(),await Le(),b(),e.webSocketConn!==null&&(p(g),C.querySelector(".error-msg").textContent="",u(C),V(),await ke(),b())}async function Pt(){let o=B.querySelector(".error-msg");o.textContent="";let n=document.getElementById("create-room-name").value.trim(),r=at.getValue(),s=lt.getValue(),c=it.getValue();V(),await Rt(n,r,s,c),b()}async function wt(){let o=C.querySelector(".error-msg");o.textContent="";let t=document.querySelector(".join-room-list > .join-room-item.selected");if(t===null){o.textContent="Please select a room";return}let n=t.textContent.trim(),r=Ne.getValue(),s=Oe.getValue(),c=rt.getValue();V(),await It(n,r,s,c),b()}function re(o){o.key!=="p"&&o.key!=="P"||(e.isPaused?$e({target:y}):(k("buttonPress",!1),e.isPaused=!0,u(y),y.showModal(),document.activeElement.blur()))}function ae(){k("buttonPress",!1),e.isPaused=!0,u(y),y.showModal(),document.activeElement.blur()}function $e(o){W(o.target),p(y),e.isPaused=!1,Be()}function Ct(){e.isOnlineGame?e.webSocketConn.close():X()}function Tt(o){let t=o.offsetX!==void 0?o.offsetX:o.layerX,n=o.offsetY!==void 0?o.offsetY:o.layerY;e.pointingDevice.x=t,e.pointingDevice.y=n}function vt(o){let t=o.targetTouches[0].clientX-o.target.getBoundingClientRect().left,n=o.targetTouches[0].clientY-o.target.getBoundingClientRect().top;e.pointingDevice.x=t,e.pointingDevice.y=n}function Mt(){requestAnimationFrame(Se)}function bt(o){let t=document.querySelector(".join-room-list > .join-room-item.selected");t!==null&&t.classList.remove("selected"),o.classList.add("selected"),Ne.updateSelectableValues(o.dataset.teams.split(","));let r=o.dataset.strikers.split(",").map(s=>parseInt(s));Oe.updateSelectableValues(r)}function Le(){return new Promise(o=>{if(e.webSocketConn!==null){o();return}let t=document.getElementById("user-name"),n=g.querySelector(".error-msg");if(n.textContent="",t.value===""){n.textContent="User name cannot be empty",D(),o();return}else if(F<t.value.length){n.textContent=`User name cannot be more than ${F} characters`,D(),o();return}e.webSocketConn=new WebSocket(`ws://${J}/user`),e.webSocketConn.onopen=()=>{l&&console.log("Web socket connection established"),e.webSocketConn.send(JSON.stringify({channel:"handshake",userName:t.value.trim()})),l&&console.log("Sent web socket message on 'handshake' channel")},e.webSocketConn.onmessage=r=>{l&&console.log("Received web socket message during handshake");let s=JSON.parse(r.data);if(s.channel!=="handshake"){l&&console.error("Received web socket message from invalid channel during handshake"),e.webSocketConn.close(w.wrongChannel.code,w.wrongChannel.reason);return}if(l&&console.log("Received web socket message on 'handshake' channel"),s.isSuccess){e.userName=t.value.trim(),e.webSocketConn.onmessage=null,o();return}else{n.textContent=L(s.message),e.webSocketConn.close(w.rejectedUsername.code,w.rejectedUsername.reason);return}},e.webSocketConn!==null&&(e.webSocketConn.onerror=()=>{l&&console.error("Error during web socket communication"),n.textContent="Error while communicating with server",e.webSocketConn.close(w.clientError.code,w.clientError.reason)}),e.webSocketConn!==null&&(e.webSocketConn.onclose=()=>{e.userName===null?(l&&console.log("Web socket connection closed"),n.textContent===""&&(n.textContent="Can't connect to server"),D(),o()):l&&console.log("Web socket connection closed due to user clicking home button")})})}function Nt(o,t,n){e.isOnlineGame=!0,e.isPaused=!1,e.fps=He,Gt(),K(),u(i),u(Q),u(Z),document.addEventListener("keypress",r=>re(r)),document.addEventListener("dblclick",ae),e.mainPlayer.name=e.userName,e.mainPlayer.team=o,e.mainPlayer.strikerIdx=t,e.mainPlayer.type=n,e.webSocketConn.onmessage=r=>{e.connTimeoutMetrics.prevMsgTimestamp=window.performance.now();let s=JSON.parse(r.data);switch(s.channel){case"memberLeft":{l&&console.log("Received web socket message on 'memberLeft' channel");let c=null;for(let a of e.players)if(!(a.name!==s.userName||a===e.mainPlayer)){c=a;break}c!==null&&(c.removeFromBoard(),G(`Player ${c.name} left the room`))}break;case"reassignHost":e.isHost=!0,G("You are now the host");break;case"state":{l&&console.log(`Received web socket message on 'state' channel. Remote state originated from remote user ${s.userName}`);let c=!1;for(let a of e.players)if(!(a.name!==s.userName||a===e.mainPlayer)){c=!0,a.xPos=I(s.playerXPos)*i.width,a.yPos=I(s.playerYPos)*i.height,a.xVel=I(s.playerXVel)*i.width,a.yVel=I(s.playerYVel)*i.height,s.isHost&&(e.puck.xPos=I(s.puckXPos)*i.width,e.puck.yPos=I(s.puckYPos)*i.height,e.puck.xVel=I(s.puckXVel)*i.width,e.puck.yVel=I(s.puckYVel)*i.height,Te(q,s.leftScore),Te(j,s.rightScore));break}if(!c&&s.userName!==e.userName){if(e.players.length===T){console.error(`Server is trying to add a new player when room is full; current room count is ${T}`);return}new x(s.userName,s.striker,s.team,"remote").addToBoard(),G(`Player ${s.userName} joined`)}}break;default:l&&console.error(`Received web socket message from invalid channel named '${s.channel}'`)}},e.webSocketConn.onerror=r=>{l&&console.error("Error during web socket communication. Reason: ",r),e.webSocketConn.close(w.clientError.code,w.clientError.reason)},e.webSocketConn.onclose=()=>{l&&console.log("Web socket connection closed"),X()},Pe()}async function Rt(o,t,n,r){let s=B.querySelector(".error-msg"),c=l?"http":"https",a=null;if(o===""){s.textContent="Room name cannot be empty";return}else if(Me<o.length){s.textContent=`Room name cannot be more than ${Me} characters`;return}try{a=await fetch(`${c}://${J}/room`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomName:o,userName:e.userName,team:t,striker:n})})}catch(d){console.error("Error occurred while creating room. Reason: ",d),s.textContent="Can't connect to server";return}if(a!==null&&a.ok)e.isHost=!0,Nt(t,n,r);else if(a!==null){let d=await a.text();s.textContent=L(d)}else s.textContent="Something went wrong"}async function ke(){let o=C.querySelector(".error-msg"),t=l?"http":"https",n=null;try{n=await fetch(`${t}://${J}/rooms`)}catch(r){console.error("Failed to fetch joinable rooms list. Reason: ",r),o.textContent="Failed to fetch rooms";return}if(n!==null&&n.ok){let r=await n.json(),s=C.querySelector(".join-room-list");if(o.textContent="",s.innerHTML="",r.length===0)s.innerHTML='<div class="no-rooms-msg">Please create a room to play</div>',s.style.justifyContent="center",o.textContent="No rooms available";else{s.style.justifyContent="start";for(let c=0;c<r.length;c++){let a=r[c],d=document.createElement("button");d.classList.add("menu-btn","join-room-item"),d.textContent=a.roomName,d.dataset.idx=c.toString(),d.dataset.name=a.roomName;let m=[];a.canJoinLeftTeam&&m.push("left"),a.canJoinRightTeam&&m.push("right"),d.dataset.teams=m.join(","),d.dataset.strikers=a.availableStrikers.join(","),d.onclick=()=>{k("buttonPress",!1),bt(d)},s.appendChild(d)}}}else o.textContent="Something went wrong"}async function It(o,t,n,r){let s=C.querySelector(".error-msg");s.textContent="";let c=l?"http":"https",a=null;try{a=await fetch(`${c}://${J}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomName:o,userName:e.userName,team:t,striker:n})})}catch(d){console.error("Error occurred while joining room. Reason: ",d),s.textContent="Can't connect to server";return}a!==null&&a.ok?(e.isHost=!1,Nt(t,n,r)):a!==null?s.textContent=await a.text():s.textContent="Something went wrong"}function Ot(){if(e.webSocketConn===null){l&&console.error("Cannot send remote state to server as web socket connection does not exist"),X();return}else if(e.webSocketConn.readyState!==WebSocket.OPEN){l&&console.error("Cannot send remote state to server as web socket connection is not in the open state"),X();return}e.remoteState.userName=e.userName,e.remoteState.isHost=e.isHost,e.remoteState.team=e.mainPlayer.team,e.remoteState.striker=e.mainPlayer.strikerIdx,e.remoteState.playerXPos=R(e.mainPlayer.xPos/i.width),e.remoteState.playerYPos=R(e.mainPlayer.yPos/i.height),e.remoteState.playerXVel=R(e.mainPlayer.xVel/i.width),e.remoteState.playerYVel=R(e.mainPlayer.yVel/i.height),e.isHost?(e.remoteState.puckXPos=R(e.puck.xPos/i.width),e.remoteState.puckYPos=R(e.puck.yPos/i.height),e.remoteState.puckXVel=R(e.puck.xVel/i.width),e.remoteState.puckYVel=R(e.puck.yVel/i.height),e.remoteState.leftScore=we(q),e.remoteState.rightScore=we(j)):(e.remoteState.puckXPos=void 0,e.remoteState.puckYPos=void 0,e.remoteState.puckXVel=void 0,e.remoteState.puckYVel=void 0,e.remoteState.leftScore=void 0,e.remoteState.rightScore=void 0),e.webSocketConn.send(JSON.stringify(e.remoteState))}function Gt(){e.connTimeoutMetrics.prevMsgTimestamp=window.performance.now(),e.connTimeoutMetrics.intervalId=setInterval(Ft,be/2)}function Ft(){if(!e.isOnlineGame||e.webSocketConn===null)return;let o=window.performance.now()-e.connTimeoutMetrics.prevMsgTimestamp;be<o&&e.webSocketConn.close(w.serverInactivity.code,w.serverInactivity.reason)}function Ut(){clearInterval(e.connTimeoutMetrics.intervalId),e.connTimeoutMetrics.intervalId=-1,e.connTimeoutMetrics.prevMsgTimestamp=1/0}function D(){Ut(),e.webSocketConn=null,e.userName=null,e.mainPlayer.name="You",e.mainPlayer.team="left",e.mainPlayer.strikerIdx=0,e.isOnlineGame=!1,e.isHost=!1}function Be(){De(),e.fpsMetrics.prevFrameTimestamp=window.performance.now(),requestAnimationFrame(Et)}function Et(){let o=!e.isGameOver&&(e.isOnlineGame||!e.isPaused);if(!o)return;let t=1e3/e.fps,n=window.performance.now(),r=n-e.fpsMetrics.prevFrameTimestamp;if(t<=r){if(e.fpsMetrics.prevFrameTimestamp=n-r%t,e.context.clearRect(0,0,i.width,i.height),e.players.length===1)Ge("Waiting for other players to join");else{e.puck.update();for(let s of e.players)s.update()}e.isOnlineGame&&Ot(),l&&e.fpsMetrics.canvasFpsCounter++}qt(),e.isGoal||Kt(),o=!e.isGameOver&&(e.isOnlineGame||!e.isPaused),o&&requestAnimationFrame(Et)}function _t(){e.isOnlineGame=!1,e.isPaused=!1,e.fps=Re,K(),u(i),u(Q),u(Z),document.addEventListener("keypress",s=>re(s)),document.addEventListener("dblclick",ae),e.mainPlayer.team=ne.getValue(),e.mainPlayer.reset();let o=ne.getValue(),t=o==="left"?"right":"left",n=ye.getValue(),r=ct.getValue();if(r==="one"){let s=new x("Tom",1,t,"ai");s.reset(),s.addToBoard(),s.intelligence=n}else if(r==="two"){let s=new x("Tom",1,o,"ai");s.reset(),s.addToBoard();let c=new x("Laura",2,t,"ai");c.reset(),c.addToBoard();let a=new x("Sophie",3,t,"ai");a.reset(),a.addToBoard(),n==="easy"?(s.intelligence="medium",c.intelligence="easy",a.intelligence="medium"):n==="medium"?(s.intelligence="easy",c.intelligence="easy",a.intelligence="medium"):n==="hard"&&(s.intelligence="easy",c.intelligence="medium",a.intelligence="hard")}Pe()}function Pe(){e.isGameOver=!0,e.puck.reset();for(let o of e.players)o.reset();e.isGameOver=!1,e.isGoal=!1,Be()}function qt(){Ht(),!e.isGoal&&(jt(),Xt())}function jt(){let o=M*i.width+e.puck.radius,t=i.width*(1-M)-e.puck.radius,n=O*i.height+e.puck.radius,r=i.height*(1-O)-e.puck.radius,s=Ye*i.height+2*e.puck.radius,c=Ke*i.height-2*e.puck.radius;if((e.puck.xPos<o||t<e.puck.xPos)&&s<e.puck.yPos&&e.puck.yPos<c||isNaN(e.puck.xPos)){Yt();return}let a=!1;(e.puck.xPos<=o||t<=e.puck.xPos)&&(e.puck.xVel*=-1,a=!0),(e.puck.yPos<=n||r<=e.puck.yPos)&&(e.puck.yVel*=-1,a=!0),a&&k("boardHit",!1),e.puck.xPos<o&&(e.puck.xPos=o+1),t<e.puck.xPos&&(e.puck.xPos=t-1),e.puck.yPos<n&&(e.puck.yPos=n+1),r<e.puck.yPos&&(e.puck.yPos=r-1)}function Ht(){for(let o of e.players){if(o.type!=="ai")continue;let t=i.width/2+o.radius,n=i.width*(1-M)-o.radius;o.team==="left"&&(t=i.width*M+o.radius,n=i.width/2-o.radius);let r=O*i.height+o.radius,s=i.height*(1-O)-o.radius;(o.xPos<=t||n<=o.xPos)&&(o.xVel=0,o.xPos=o.xPos<=t?t+1:n-1),(o.yPos<=r||s<=o.yPos)&&(o.yVel=0,o.yPos=o.yPos<=r?r+1:s-1)}}function Xt(){let o=!1;for(let t of e.players){let n=e.puck.xPos-t.xPos,r=e.puck.yPos-t.yPos,s=Math.sqrt(n*n+r*r),c=e.puck.radius+t.radius,a=s<=c,m=window.performance.now()-t.prevCollisionTimestamp<tt;if(!a||m)continue;o=!0,t.prevCollisionTimestamp=window.performance.now();let h=n/s,S=r/s;e.puck.xVel=2*(t.xVel*h+t.yVel*S)*h-(e.puck.xVel*h+e.puck.yVel*S)*h,e.puck.yVel=2*(t.xVel*h+t.yVel*S)*S-(e.puck.xVel*h+e.puck.yVel*S)*S,e.puck.xPos=t.xPos+n*c/s,e.puck.yPos=t.yPos+r*c/s,t.xPos+=t.xVel,t.yPos+=t.yVel}o&&k("playerHit",!1)}function Yt(){let o=7*e.fps/60;e.puck.xVel=Math.sign(e.puck.xVel)*Math.max(o,e.puck.xVel),e.puck.yVel=0,e.isGoal=!0,k("goal",!1),e.puck.xPos<i.width/2?Ce(j):Ce(q),setTimeout(Pe,2e3)}function Kt(){let o=e.stuckPuckMetrics.prevCheckTimestamp-e.stuckPuckMetrics.startTimestamp,t=e.stuckPuckMetrics.secondsCounter<=Math.floor(o/1e3),n=e.puck.xPos<i.width/2;e.puck.xPos===i.width/2||e.stuckPuckMetrics.wasPuckOnLeftSide!==n?e.stuckPuckMetrics.stuckDuration=0:t&&e.stuckPuckMetrics.stuckDuration++,t&&e.stuckPuckMetrics.secondsCounter++,e.stuckPuckMetrics.prevCheckTimestamp=window.performance.now(),e.stuckPuckMetrics.wasPuckOnLeftSide=n}function De(){e.stuckPuckMetrics.startTimestamp=window.performance.now(),e.stuckPuckMetrics.prevCheckTimestamp=window.performance.now(),e.stuckPuckMetrics.secondsCounter=0,e.stuckPuckMetrics.stuckDuration=0,e.stuckPuckMetrics.wasPuckOnLeftSide=!1}function Se(){let o=window.visualViewport.width/window.visualViewport.height,t=window.visualViewport.height/window.visualViewport.width,n=16/9;if(Math.abs(o-n)<=.1||Math.abs(t-n)<.1)i.width=window.visualViewport.width,i.height=window.visualViewport.height;else if(Math.abs(o-n)>.1){let r=window.visualViewport.height*16/9;i.width=r,i.height=window.visualViewport.height}else i.width=window.visualViewport.height,i.height=window.visualViewport.width;e.context=i.getContext("2d"),e.puck.adaptToScreen();for(let r of e.players)r.adaptToScreen();e.prevCanvasDim.width=i.width,e.prevCanvasDim.height=i.height}function X(){e.isOnlineGame&&(G("Disconnected"),D()),W(y),e.isPaused=!1,e.isGameOver=!0,e.fps=Re,e.players=[e.mainPlayer],e.mainPlayer.name="You",e.mainPlayer.type="human",document.removeEventListener("keypress",re),document.removeEventListener("dblclick",ae),q.textContent="0",j.textContent="0",p(i),p(Q),p(Z),K(),u(v)}var ce=class{#o;#t;#s;#e;#n;#r;#i;constructor(t,n){this.reset(),this.#t=Je,this.xVel=t,this.yVel=n,this.#i=Qe}get radius(){return this.#o}get xPos(){return this.#s}set xPos(t){isNaN(t)||(this.#s=f(-i.width-2*this.#o,t,i.width+2*this.#o))}get yPos(){return this.#e}set yPos(t){isNaN(t)||(this.#e=f(-i.height-2*this.#o,t,i.height+2*this.#o))}get xVel(){return this.#n}set xVel(t){if(isNaN(t))return;let n=Math.abs(t);n<ee&&(t=Math.sign(t)*ee);let r=3*e.fps/60;this.#n=Math.sign(t)*Math.min(n,e.fps/r)}get yVel(){return this.#r}set yVel(t){if(isNaN(t))return;let n=Math.abs(t);n<ee&&(t=Math.sign(t)*ee);let r=3*e.fps/60;this.#r=Math.sign(t)*Math.min(n,e.fps/r)}resetRadius(){this.#o=We*i.width}adaptToScreen(){this.xPos=i.width*this.xPos/e.prevCanvasDim.width,this.yPos=i.height*this.yPos/e.prevCanvasDim.height,this.resetRadius()}reset(){this.resetRadius(),this.xPos=i.width/2,this.yPos=i.height/2,this.xVel=0,this.yVel=0}update(){(!e.isOnlineGame||e.isOnlineGame&&e.isHost)&&(this.xVel*=this.#i,this.yVel*=this.#i,this.xPos+=this.xVel,this.yPos+=this.yVel,et<=e.stuckPuckMetrics.stuckDuration&&(this.reset(),De())),this.draw()}draw(){let t=e.context;t.beginPath(),t.arc(this.#s,this.#e,this.#o,0,2*Math.PI,!1),t.fillStyle=this.#t,t.fill(),t.closePath()}};document.addEventListener("DOMContentLoaded",Wt);function Wt(){mt(),Ve(),ht(),Jt(),zt(),e.mainPlayer=new x("You",0,ne.getValue(),"human"),e.mainPlayer.reset(),e.mainPlayer.addToBoard(),e.puck=new ce(0,0),je?i.addEventListener("touchmove",o=>vt(o)):i.addEventListener("mousemove",o=>Tt(o)),window.addEventListener("resize",Mt),Se(),l&&void 0,A.classList.remove("opaque-loading-spinner"),b()}function zt(){N.value=te*100,de.value=fe*100,me.value=ge*100}function Jt(){window.screen.orientation.addEventListener("change",t=>Ve(t)),document.addEventListener("click",_e),document.querySelectorAll("button").forEach(t=>t.addEventListener("click",()=>{k("buttonPress",!1)})),v.querySelector(".online-game-btn").onclick=pt,v.querySelector(".offline-game-btn").onclick=ft;for(let t of he)t.onclick=gt;window.addEventListener("keydown",t=>{t.key==="F11"&&(t.preventDefault(),Ae())});for(let t of pe)t.onclick=Ae;let o=document.querySelector(".settings-btn");o.onclick=yt;for(let t of document.querySelectorAll(".menu .home-btn"))t.onclick=n=>xt(n.target);N.oninput=()=>xe(N),de.oninput=()=>xe(de),me.oninput=()=>xe(me),ue.querySelector(".start-offline-game-btn").onclick=_t,g.querySelector(".host-menu-btn").onclick=kt,g.querySelector(".join-menu-btn").onclick=St,B.querySelector(".create-room-btn").onclick=Pt,C.querySelector(".join-room-btn").onclick=wt,C.querySelector(".refresh-btn").onclick=async()=>{V(),await ke(),b()},y.querySelector(".resume-btn").onclick=$e,y.querySelector(".exit-btn").onclick=Ct}})();
