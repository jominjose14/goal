(()=>{var W=new URL(window.location.href).host,D=10,ke=10,A=4;var Se=6e4,Ot=3,we=Math.pow(10,Ot),V={serverInactivity:{code:3001,reason:"Server inactivity timeout"},wrongChannel:{code:3002,reason:"Wrong channel"},rejectedUsername:{code:3003,reason:"Username rejected by server"}},v=document.querySelector(".menu.home"),De=document.querySelector(".menu.settings"),ce=document.querySelector(".menu.offline"),y=document.querySelector(".menu.online"),L=document.querySelector(".menu.host"),w=document.querySelector(".menu.join"),U=document.querySelector(".menu.rotate-screen"),b=document.getElementById("master-volume-slider"),le=document.getElementById("music-volume-slider"),ue=document.getElementById("sfx-volume-slider"),P=document.querySelector(".menu.pause"),J=document.querySelector(".message"),z=document.querySelector(".scores"),G=document.getElementById("left-score"),F=document.getElementById("right-score"),de=[document.querySelector(".menu.home .mute-toggle-btn"),document.querySelector(".menu.pause .mute-toggle-btn")],me=[document.querySelector(".menu.home .fullscreen-toggle-btn"),document.querySelector(".menu.pause .fullscreen-toggle-btn")],Ft=document.querySelector(".fps-display"),q=document.querySelector(".loading-spinner"),$=document.querySelector(".toast"),s=document.getElementById("board"),x=.008,C=.014,Ue=.015,Ge=.0225,Fe="hsla(0, 0%, 100%, 1)",T=60,Ce=1e3/T,Me=3*(T/60)*16,ve=3*(T/60)*9,Q=1,qe=.999;var Te=2.5;var je=10,Xe=250,Ye=3e3,Z=1,he=.9,fe=.8;var j=["left","right"],pe=["easy","medium","hard"],He=["one","two"],Ke=["main","ai","remote"],ee=[];for(let o=0;o<A;o++)ee.push(o);var We=["images/striker-0.svg","images/striker-1.svg","images/striker-2.svg","images/striker-3.svg"],Je=[{name:"G",color:"hsla(190, 100%, 50%, 1)"},{name:"O",color:"hsla(120, 100%, 50%, 1)"},{name:"A",color:"hsla(53, 100%, 50%, 1)"},{name:"L",color:"hsla(35, 100%, 50%, 1)"}],e={remoteState:{channel:"state",userName:"",isHost:!1,team:"",striker:0,playerXPos:0,playerYPos:0,playerXVel:0,playerYVel:0,puckXPos:0,puckYPos:0,puckXVel:0,puckYVel:0,leftScore:0,rightScore:0},connTimeoutMetrics:{prevMsgTimestamp:0,intervalId:-1},webSocketConn:null,userName:null,isOnlineGame:!1,isHost:!1,context:s.getContext("2d"),prevCanvasDim:{width:s.width,height:s.height},fpsMetrics:{canvasFpsCounter:0,prevFrameTimestamp:0},stuckPuckMetrics:{startTimestamp:0,prevCheckTimestamp:0,secondsCounter:0,stuckDuration:0,wasPuckOnLeftSide:!1},isGoal:!0,isPaused:!1,isGameOver:!0,mainPlayer:null,allPlayers:[],nonMainPlayers:[],puck:null,strikerIdx:"0",offlineTeam:"left",difficulty:"medium",playersPerTeam:"two",prevMasterGainValue:Z,toastTimeoutId:-1};function ze(o){let t=e.context,n=.03*s.height,i=.05*s.height,r=t.measureText(o).width,a=1.25*i,c=(s.width-r)/2,u=(s.height+a-n)/2,d=(s.width-r)/2-n,h=(s.height-a)/2-n,g=r+2*n,S=a+2*n,K=.03*s.height;t.fillStyle="hsla(0, 0%, 20%, 0.95)",t.beginPath(),t.moveTo(d+K,h),t.arcTo(d+g,h,d+g,h+S,K),t.arcTo(d+g,h+S,d,h+S,K),t.arcTo(d,h+S,d,h,K),t.arcTo(d,h,d+g,h,K),t.closePath(),t.fill(),t.beginPath(),t.font=`${i}px "Protest Riot", "Trebuchet MS", sans-serif`,t.textAlign="start",t.textBaseline="alphabetic",t.fillStyle="hsla(0, 0%, 100%, 0.25)",t.fillText(o,c,u),t.closePath()}function f(o,t,n){return Math.max(o,Math.min(t,n))}function Qe(){let o=navigator.userAgent;return/Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/.test(o)}function m(o){o.classList.remove("hidden")}function p(o){o.classList.add("hidden")}function te(){for(let o of document.querySelectorAll(".menu"))p(o)}function N(){m(q),q.showModal(),q.blur()}function O(){p(q),q.close()}function X(o){clearTimeout(e.toastTimeoutId),p($),$.querySelector(".toast-msg").textContent=o,$.style.right-=$.width,m($),e.toastTimeoutId=setTimeout(()=>p($),Ye)}function I(o){return o[0].toUpperCase()+o.substring(1)}function E(o){return o=Math.floor(o*we),o}function R(o){return o/we}function Ie(o){return isNaN(o.textContent)?0:f(0,parseInt(o.textContent),999)}function be(o){let t=o.textContent;isNaN(t)&&(t=-1),o.textContent=(parseInt(t)+1).toString(),Ze(o)}function Ee(o,t){let n=o.textContent;isNaN(n)&&(n=0),o.textContent=t.toString(),parseInt(n)!==t&&Ze(o)}function Ze(o){o.classList.remove("strobing-score"),o.offsetWidth,o.classList.add("strobing-score")}function Re(o){o.textContent=o.dataset.values.split(",").at(-1),o.click()}function _e(o){o.dataset.value=o.dataset.values.split(",").at(-1),o.click()}function et(o){o.dataset.values=j.join(","),Re(o)}function tt(o){o.dataset.values=ee.join(","),_e(o)}function oe(o){o.closest("dialog").close()}var k=class{#o;#e;#s;#t;#i;#r;#n;#a;#l=0;#u=0;#c=null;prevCollisionTimestamp=0;constructor(t,n,i,r){this.#o=t,this.resetRadius(),this.#s=n,this.#t=i,this.#i=r,this.#r=e.difficulty}get name(){return this.#o}set name(t){if(D<t.length){console.error(`Cannot set player ${this.name}'s name to invalid value ${t}. Min length is 1 and max length is ${D}`);return}this.#o=t}get radius(){return this.#e}get strikerIdx(){return this.#s}set strikerIdx(t){if(t<0||A<=t){console.error(`Cannot set player ${this.name}'s strikerId to invalid value ${t}. Min value is 0 and max value is ${A-1}`);return}this.#s=t}get team(){return this.#t}set team(t){if(t=t.toLowerCase(),!j.includes(t)){console.error(`Cannot set player ${this.name}'s team to invalid value ${t}`);return}this.#t=t}get type(){return this.#i}set type(t){if(t=t.toLowerCase(),!Ke.includes(t)){console.error(`Cannot set player ${this.name}'s type to invalid value ${t}`);return}this.#i=t}get intelligence(){return this.#r}set intelligence(t){if(t=t.toLowerCase(),!pe.includes(t)){console.error(`Cannot set player ${this.name}'s intelligence to invalid value ${t}`);return}this.#r=t}get xPos(){return this.#n}set xPos(t){if(!isNaN(t))if(this.#t==="left"){let n=x*s.width+this.#e,i=s.width/2-this.#e;this.#n=f(n,t,i)}else{let n=s.width/2+this.#e,i=s.width*(1-x)-this.#e;this.#n=f(n,t,i)}}get yPos(){return this.#a}set yPos(t){if(isNaN(t))return;let n=C*s.height+this.#e,i=s.height*(1-C)-this.#e;this.#a=f(n,t,i)}get xVel(){return this.#l}set xVel(t){isNaN(t)||(this.#l=f(-s.width,t,s.width))}get yVel(){return this.#u}set yVel(t){isNaN(t)||(this.#u=f(-s.height,t,s.height))}addToBoard(){e.allPlayers.push(this),this.#i!=="main"&&e.nonMainPlayers.push(this)}removeFromBoard(){let t=e.nonMainPlayers.indexOf(this);t>-1&&e.nonMainPlayers.splice(t,1),t=e.allPlayers.indexOf(this),t>-1&&e.allPlayers.splice(t,1)}resetRadius(){this.#e=Ge*s.width}adaptToScreen(){this.xPos=s.width*this.xPos/e.prevCanvasDim.width,this.yPos=s.height*this.yPos/e.prevCanvasDim.height,this.resetRadius()}reset(){this.resetRadius(),this.#t==="left"?this.xPos=.05*s.width:this.xPos=.95*s.width,this.yPos=s.height/2,this.xVel=0,this.yVel=0}updatePosViaUserInput(t,n){if(this.#t==="left"){let h=x*s.width+this.#e,g=s.width/2-this.#e;t=f(h,t,g)}else{let h=s.width/2+this.#e,g=s.width*(1-x)-this.#e;t=f(h,t,g)}let i=C*s.height+this.#e,r=s.height*(1-C)-this.#e;n=f(i,n,r),this.#c==null&&(this.#c=window.performance.now(),this.xPos=t,this.yPos=n);let a=window.performance.now(),c=Math.max(1,a-this.#c),u=t-this.xPos,d=n-this.yPos;this.xVel=Te*u/c,this.yVel=Te*d/c,this.#c=Date.now(),this.xPos=t,this.yPos=n}onAiCollideWithBounds(){let t=s.width/2+this.#e,n=s.width*(1-x)-this.#e;this.#t==="left"&&(t=s.width*x+this.#e,n=s.width/2-this.#e);let i=C*s.height+this.#e,r=s.height*(1-C)-this.#e;(this.xPos<=t||n<=this.xPos)&&(this.xVel=0,this.xPos=this.xPos<=t?t+1:n-1),(this.yPos<=i||r<=this.yPos)&&(this.yVel=0,this.yPos=this.yPos<=i?i+1:r-1)}easyAiUpdate(){if(e.puck.xPos===s.width/2&&e.puck.yPos===s.height/2)return;if(this.#t==="right"&&e.puck.xPos+e.puck.radius<s.width/2||this.#t==="left"&&s.width/2<e.puck.xPos+e.puck.radius){this.xVel*=.99,this.yVel*=.99;return}if(this.#t==="right"&&-1<Math.sign(e.puck.xVel)||this.#t==="left"&&Math.sign(e.puck.xVel)<1){let r=e.puck.yPos-this.yPos;Math.abs(r)<=.8*(this.radius+e.puck.radius)?this.yVel*=.99:this.yVel=.2*r}this.xPos=this.#t==="right"?.9*s.width:.1*s.width,this.yPos+=this.yVel;let i=10*60/T;this.xVel=(this.team==="right"?-1:1)*Math.max(i,Math.abs(this.xVel))}mediumAiUpdate(){if(e.puck.xPos===s.width/2&&e.puck.yPos===s.height/2)return;let t=this.#t==="right"&&e.puck.xPos+e.puck.radius<s.width/2||this.#t==="left"&&s.width/2<e.puck.xPos+e.puck.radius,n=this.#t==="right"&&this.xPos<e.puck.xPos||this.#t==="left"&&e.puck.xPos<this.xPos,i=this.#t==="right"&&Math.sign(e.puck.xVel)===-1||this.#t==="left"&&Math.sign(e.puck.xVel)===1,r=10*T/60;if(t||n){let a=t?.05:.1;if(this.#t==="right"){let c=s.width*(1-x)-this.radius-this.xPos;this.xVel=a*c}else if(this.#t==="left"){let c=s.width*x+this.radius-this.xPos;this.xVel=a*c}this.yVel=a*(s.height/2-this.yPos)}else if(i&&r<Math.abs(e.puck.xVel))this.xVel*=.99,this.yVel*=.99;else{let a=e.puck.xPos-this.xPos,c=e.puck.yPos-this.yPos,u=.0075,d,h=Math.random();h<.5?d=.35:.5<=h&&h<=.8?d=.2:d=.1,this.xVel+=u*a,this.yVel=d*c}this.xPos+=this.xVel,this.yPos+=this.yVel}hardAiUpdate(){if(e.isGoal)return;let t=this.team==="right"?.9*s.width:.1*s.width,n=s.height/2-e.puck.yPos,i=(s.height*(1-2*C)-2*this.radius)/2,r=e.puck.yPos+e.puck.radius*n/i;this.updatePosViaUserInput(t,r),this.xVel=(this.team==="right"?-1:1)*Math.max(10*60/T,Math.abs(this.xVel)),this.yVel=(e.puck.yPos<this.yPos?-1:1)*Math.max(10*60/T,Math.abs(this.yVel))}update(){if(this.type==="ai")switch(this.onAiCollideWithBounds(),this.#r){case"easy":this.easyAiUpdate();break;case"medium":this.mediumAiUpdate();break;case"hard":this.hardAiUpdate()}this.draw()}draw(){let t=e.context;t.beginPath(),t.arc(this.#n,this.#a,this.#e,0,2*Math.PI,!1),t.fillStyle="hsla(0, 0%, 100%, 1)",t.fill(),t.closePath(),t.beginPath(),t.arc(this.#n,this.#a,.8*this.#e,0,2*Math.PI,!1),t.fillStyle=Je[this.#s].color,t.fill(),t.closePath()}};var Y=new(window.AudioContext||window.webkitAudioContext),_=Y.createGain(),ne=Y.createGain(),se=Y.createGain(),ot={bgm:"audio/bgm.mp3",buttonPress:"audio/button-press.mp3",boardHit:"audio/board-hit.mp3",playerHit:"audio/player-hit.mp3",goal:"audio/goal.mp3"};ne.gain.value=he;se.gain.value=fe;_.gain.value=Z;ne.connect(_);se.connect(_);_.connect(Y.destination);var nt=new Map;function At(o,t){fetch(t).then(n=>n.arrayBuffer()).then(n=>Y.decodeAudioData(n)).then(n=>{nt.set(o,n)}).catch(n=>console.error(`Error loading sound ${o}. Reason: `,n))}function st(){for(let o of Object.keys(ot))At(o,ot[o])}function M(o,t){let n=Y.createBufferSource();return n.buffer=nt.get(o),n.buffer===null?!1:(o==="bgm"?n.connect(ne):n.connect(se),n.loop=t,n.start(0),!0)}function it(){p(v),y.querySelector(".error-msg").textContent="",m(y),document.getElementById("user-name").focus()}function rt(){p(v),m(ce)}function Ne(){M("bgm",!0)&&document.removeEventListener("click",Ne)}function at(){for(let t of de){let n=t.querySelector("img");n.src.includes("unmuted")?(n.src=n.src.replace("unmuted.svg","muted.svg"),b.disabled=!0,b.style.cursor="not-allowed"):(n.src=n.src.replace("muted.svg","unmuted.svg"),b.disabled=!1,b.style.cursor="grab")}let o=_.gain.value;_.gain.value=_.gain.value===0?e.prevMasterGainValue:0,e.prevMasterGainValue=o}function Oe(){for(let o of me){let t=o.querySelector("img");document.fullscreenElement?document.exitFullscreen&&(t.src=t.src.replace("windowed.svg","fullscreen.svg")):t.src=t.src.replace("fullscreen.svg","windowed.svg")}document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}function ct(){p(v),m(De)}function lt(o){e.webSocketConn!==null&&(e.webSocketConn.close(),B());let t=o.closest(".menu");p(t),m(v)}function ut(o){let t=o.dataset.values.split(","),n=o.textContent.trim().toLowerCase();for(let i=0;i<t.length;i++)if(t[i]===n){o.textContent=I(t[(i+1)%t.length]);break}}function dt(o){let t=o.dataset.values.split(","),n=o.dataset.value;for(let i=0;i<t.length;i++)if(t[i]===n){o.dataset.value=t[(i+1)%t.length];break}}function Ae(o){o===void 0&&window.innerWidth<window.innerHeight||o!==void 0&&o.target.type.includes("portrait")?(m(U),U.showModal(),U.blur()):(o===void 0&&window.innerHeight<window.innerWidth||o!==void 0&&o.target.type.includes("landscape"))&&(p(U),oe(U))}function mt(){e.offlineTeam=document.getElementById("offline-team-selector").textContent.toLowerCase()}function ht(){e.difficulty=document.getElementById("difficulty-selector").textContent.toLowerCase()}function ft(){e.playersPerTeam=document.getElementById("players-per-team-selector").textContent.toLowerCase()}function pt(){e.theme=document.getElementById("theme-selector").textContent.toLowerCase()}function ge(o){o.id==="master-volume-slider"?_.gain.value=f(0,o.value/100,1):o.id==="music-volume-slider"?ne.gain.value=f(0,o.value/100,1):o.id==="sfx-volume-slider"&&(se.gain.value=f(0,o.value/100,1))}function gt(o){let t=o.querySelector("img");t.src=We[parseInt(o.dataset.value)]}async function xt(){y.querySelector(".error-msg").textContent="",N(),await Le(),O(),e.webSocketConn!==null&&(p(y),m(L),document.getElementById("create-room-name").focus())}async function yt(){y.querySelector(".error-msg").textContent="",N(),await Le(),O(),e.webSocketConn!==null&&(p(y),w.querySelector(".error-msg").textContent="",m(w),N(),await xe(),O())}async function Pt(){let o=L.querySelector(".error-msg");o.textContent="";let n=document.getElementById("create-room-name").value.trim(),r=document.getElementById("create-room-team-selector").textContent.toLowerCase(),a=document.getElementById("create-room-striker-selector"),c=parseInt(a.dataset.value);N(),await Tt(n,r,c),O()}async function kt(){let o=w.querySelector(".error-msg");o.textContent="";let t=document.querySelector(".join-room-list > .join-room-item.selected");if(t===null){o.textContent="Please select a room";return}let n=t.textContent.trim(),r=document.getElementById("join-room-team-selector").textContent.toLowerCase(),a=document.getElementById("join-room-striker-selector"),c=parseInt(a.dataset.value);N(),await It(n,r,c),O()}function ie(o){o.key!=="p"&&o.key!=="P"||(e.isPaused?Ve({target:P}):(M("buttonPress",!1),e.isPaused=!0,m(P),P.showModal(),document.activeElement.blur()))}function re(){M("buttonPress",!1),e.isPaused=!0,m(P),P.showModal(),document.activeElement.blur()}function Ve(o){oe(o.target),p(P),e.isPaused=!1,$e()}function St(){e.isOnlineGame?e.webSocketConn.close():H()}function wt(o){let t=o.offsetX!==void 0?o.offsetX:o.layerX,n=o.offsetY!==void 0?o.offsetY:o.layerY;requestAnimationFrame(()=>e.mainPlayer.updatePosViaUserInput(t,n))}function Ct(o){let t=o.targetTouches[0].clientX-o.target.getBoundingClientRect().left,n=o.targetTouches[0].clientY-o.target.getBoundingClientRect().top;requestAnimationFrame(()=>e.mainPlayer.updatePosViaUserInput(t,n))}function Mt(){requestAnimationFrame(ye)}function vt(o){let t=document.querySelector(".join-room-list > .join-room-item.selected"),n=document.getElementById("join-room-team-selector"),i=document.getElementById("join-room-striker-selector");t!==null&&t.classList.remove("selected"),o.classList.add("selected"),n.dataset.values=o.dataset.teams,Re(n),i.dataset.values=o.dataset.strikers,_e(i)}function Le(){return new Promise(o=>{if(e.webSocketConn!==null){o();return}let t=document.getElementById("user-name"),n=y.querySelector(".error-msg");if(n.textContent="",t.value===""){n.textContent="User name cannot be empty",B(),o();return}else if(D<t.value.length){n.textContent=`User name cannot be more than ${D} characters`,B(),o();return}e.webSocketConn=new WebSocket(`ws://${W}/user`),e.webSocketConn.onopen=()=>{console.log("Web socket connection established"),e.webSocketConn.send(JSON.stringify({channel:"handshake",userName:t.value.trim()})),console.log("Sent web socket message on 'handshake' channel")},e.webSocketConn.onmessage=i=>{console.log("Received web socket message during handshake");let r=JSON.parse(i.data);if(r.channel!=="handshake"){console.error("Received web socket message from invalid channel during handshake"),e.webSocketConn.close(V.wrongChannel.code,V.wrongChannel.reason);return}if(console.log("Received web socket message on 'handshake' channel"),r.isSuccess){e.userName=t.value.trim(),e.webSocketConn.onmessage=null,o();return}else{n.textContent=I(r.message),e.webSocketConn.close(V.rejectedUsername.code,V.rejectedUsername.reason);return}},e.webSocketConn!==null&&(e.webSocketConn.onerror=()=>{console.error("Error during web socket communication"),n.textContent="Error while communicating with server",e.webSocketConn.close(1002)}),e.webSocketConn!==null&&(e.webSocketConn.onclose=()=>{e.userName===null?(console.log("Web socket connection closed"),n.textContent===""&&(n.textContent="Can't connect to server"),B(),o()):console.log("Web socket connection closed due to user clicking home button")})})}function bt(o,t){e.isOnlineGame=!0,e.isPaused=!1,Vt(),te(),m(s),m(J),m(z),document.addEventListener("keypress",n=>ie(n)),document.addEventListener("dblclick",re),e.mainPlayer.name=e.userName,e.mainPlayer.team=o,e.mainPlayer.strikerIdx=t,e.webSocketConn.onmessage=n=>{e.connTimeoutMetrics.prevMsgTimestamp=window.performance.now();let i=JSON.parse(n.data);switch(i.channel){case"memberLeft":{console.log("Received web socket message on 'memberLeft' channel");let r=null;for(let a of e.nonMainPlayers)if(a.name===i.userName){r=a;break}r!==null&&(r.removeFromBoard(),X(`Player ${r.name} left the room`))}break;case"reassignHost":e.isHost=!0,X("You are now the host");break;case"state":{console.log(`Received web socket message on 'state' channel. Remote state originated from remote user ${i.userName}`);let r=!1;for(let a of e.nonMainPlayers)if(a.name===i.userName){r=!0,a.xPos=R(i.playerXPos)*s.width,a.yPos=R(i.playerYPos)*s.height,a.xVel=R(i.playerXVel)*s.width,a.yVel=R(i.playerYVel)*s.height,i.isHost&&(e.puck.xPos=R(i.puckXPos)*s.width,e.puck.yPos=R(i.puckYPos)*s.height,e.puck.xVel=R(i.puckXVel)*s.width,e.puck.yVel=R(i.puckYVel)*s.height,Ee(G,i.leftScore),Ee(F,i.rightScore));break}if(!r&&i.userName!==e.userName){if(e.allPlayers.length===A){console.error(`Server is trying to add a new player when room is full; current room count is ${A}`);return}new k(i.userName,i.striker,i.team,"remote").addToBoard(),X(`Player ${i.userName} joined`)}}break;default:console.error(`Received web socket message from invalid channel named '${i.channel}'`)}},e.webSocketConn.onerror=n=>{console.error("Error during web socket communication. Reason: ",n),e.webSocketConn.close(1002)},e.webSocketConn.onclose=()=>{console.log("Web socket connection closed"),H()},Pe()}async function Tt(o,t,n){let i=L.querySelector(".error-msg"),r="http",a=null;if(o===""){i.textContent="Room name cannot be empty";return}else if(ke<o.length){i.textContent=`Room name cannot be more than ${ke} characters`;return}try{a=await fetch(`${r}://${W}/room`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomName:o,userName:e.userName,team:t,striker:n})})}catch(c){console.error("Error occurred while creating room. Reason: ",c),i.textContent="Can't connect to server";return}if(a!==null&&a.ok)e.isHost=!0,bt(t,n);else if(a!==null){let c=await a.text();i.textContent=I(c)}else i.textContent="Something went wrong"}async function xe(){let o=w.querySelector(".error-msg"),t="http",n=null;try{n=await fetch(`${t}://${W}/rooms`)}catch(i){console.error("Failed to fetch joinable rooms list. Reason: ",i),o.textContent="Failed to fetch rooms";return}if(n!==null&&n.ok){let i=await n.json(),r=w.querySelector(".join-room-list");if(o.textContent="",r.innerHTML="",i.length===0)r.innerHTML='<div class="no-rooms-msg">Please create a room to play</div>',r.style.justifyContent="center",o.textContent="No rooms available";else{r.style.justifyContent="start";for(let a=0;a<i.length;a++){let c=i[a],u=document.createElement("button");u.classList.add("menu-btn","join-room-item"),u.textContent=c.roomName,u.dataset.idx=a,u.dataset.name=c.roomName;let d=[];c.canJoinLeftTeam&&d.push("Left"),c.canJoinRightTeam&&d.push("Right"),u.dataset.teams=d.join(","),u.dataset.strikers=c.availableStrikers.join(","),u.onclick=()=>vt(u),r.appendChild(u)}}}else o.textContent="Something went wrong";et(document.getElementById("join-room-team-selector")),tt(document.getElementById("join-room-striker-selector"))}async function It(o,t,n){let i=w.querySelector(".error-msg");i.textContent="";let r="http",a=null;try{a=await fetch(`${r}://${W}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomName:o,userName:e.userName,team:t,striker:n})})}catch(c){console.error("Error occurred while joining room. Reason: ",c),i.textContent="Can't connect to server";return}a!==null&&a.ok?(e.isHost=!1,bt(t,n)):a!==null?i.textContent=await a.text():i.textContent="Something went wrong"}function Et(){if(e.webSocketConn===null){console.error("Cannot send remote state to server as web socket connection does not exist"),H();return}else if(e.webSocketConn.readyState!==WebSocket.OPEN){console.error("Cannot send remote state to server as web socket connection is not in the open state"),H();return}e.remoteState.userName=e.userName,e.remoteState.isHost=e.isHost,e.remoteState.team=e.mainPlayer.team,e.remoteState.striker=e.mainPlayer.strikerIdx,e.remoteState.playerXPos=E(e.mainPlayer.xPos/s.width),e.remoteState.playerYPos=E(e.mainPlayer.yPos/s.height),e.remoteState.playerXVel=E(e.mainPlayer.xVel/s.width),e.remoteState.playerYVel=E(e.mainPlayer.yVel/s.height),e.isHost?(e.remoteState.puckXPos=E(e.puck.xPos/s.width),e.remoteState.puckYPos=E(e.puck.yPos/s.height),e.remoteState.puckXVel=E(e.puck.xVel/s.width),e.remoteState.puckYVel=E(e.puck.yVel/s.height),e.remoteState.leftScore=Ie(G),e.remoteState.rightScore=Ie(F)):(e.remoteState.puckXPos=void 0,e.remoteState.puckYPos=void 0,e.remoteState.puckXVel=void 0,e.remoteState.puckYVel=void 0,e.remoteState.leftScore=void 0,e.remoteState.rightScore=void 0),e.webSocketConn.send(JSON.stringify(e.remoteState))}function Vt(){e.connTimeoutMetrics.prevMsgTimestamp=window.performance.now(),e.connTimeoutMetrics.intervalId=setInterval(Lt,Se/2)}function Lt(){if(!e.isOnlineGame||e.webSocketConn===null)return;let o=window.performance.now()-e.connTimeoutMetrics.prevMsgTimestamp;Se<o&&e.webSocketConn.close(V.serverInactivity.code,V.serverInactivity.reason)}function $t(){clearInterval(e.connTimeoutMetrics.intervalId),e.connTimeoutMetrics.intervalId=-1,e.connTimeoutMetrics.prevMsgTimestamp=1/0}function B(){$t(),e.webSocketConn=null,e.userName=null,e.mainPlayer.name="You",e.mainPlayer.team="left",e.mainPlayer.strikerIdx=0,e.isOnlineGame=!1,e.isHost=!1}function $e(){Be(),e.fpsMetrics.prevFrameTimestamp=window.performance.now(),requestAnimationFrame(Rt)}function Rt(){!e.isGameOver&&(e.isOnlineGame||!e.isPaused)&&requestAnimationFrame(Rt),e.isGoal||Bt();let o=window.performance.now(),t=o-e.fpsMetrics.prevFrameTimestamp;if(!(t<Ce)){if(e.fpsMetrics.prevFrameTimestamp=o-t%Ce,e.isOnlineGame&&Et(),e.context.clearRect(0,0,s.width,s.height),e.nonMainPlayers.length===0){ze("Waiting for other players to join");return}e.puck.update();for(let n of e.allPlayers)n.update();e.fpsMetrics.canvasFpsCounter++}}function _t(){e.isOnlineGame=!1,e.isPaused=!1,te(),m(s),m(J),m(z),document.addEventListener("keypress",n=>ie(n)),document.addEventListener("dblclick",re),e.mainPlayer.team=e.offlineTeam.toLowerCase(),e.mainPlayer.reset();let o=e.offlineTeam.toLowerCase(),t=o==="left"?"right":"left";if(e.playersPerTeam==="one"){let n=new k("Tom",1,t,"ai");n.reset(),n.addToBoard(),n.intelligence=e.difficulty}else if(e.playersPerTeam==="two"){let n=new k("Tom",1,o,"ai");n.reset(),n.addToBoard();let i=new k("Laura",2,t,"ai");i.reset(),i.addToBoard();let r=new k("Sophie",3,t,"ai");r.reset(),r.addToBoard(),e.difficulty==="easy"?(n.intelligence="medium",i.intelligence="easy",r.intelligence="medium"):e.difficulty==="medium"?(n.intelligence="easy",i.intelligence="easy",r.intelligence="medium"):e.difficulty==="hard"&&(n.intelligence="easy",i.intelligence="medium",r.intelligence="hard")}Pe()}function Pe(){e.isGameOver=!0,e.puck.reset();for(let o of e.allPlayers)o.reset();e.isGameOver=!1,e.isGoal=!1,$e()}function Nt(){let o=7*T/60;e.puck.xVel=Math.sign(e.puck.xVel)*Math.max(o,e.puck.xVel),e.puck.yVel=0,e.isGoal=!0,M("goal",!1),e.puck.xPos<s.width/2?be(F):be(G),setTimeout(Pe,2e3)}function Bt(){let o=e.stuckPuckMetrics.prevCheckTimestamp-e.stuckPuckMetrics.startTimestamp,t=e.stuckPuckMetrics.secondsCounter<=Math.floor(o/1e3),n=e.puck.xPos<s.width/2;e.puck.xPos===s.width/2||e.stuckPuckMetrics.wasPuckOnLeftSide!==n?e.stuckPuckMetrics.stuckDuration=0:t&&e.stuckPuckMetrics.stuckDuration++,t&&e.stuckPuckMetrics.secondsCounter++,e.stuckPuckMetrics.prevCheckTimestamp=window.performance.now(),e.stuckPuckMetrics.wasPuckOnLeftSide=n}function Be(){e.stuckPuckMetrics.startTimestamp=window.performance.now(),e.stuckPuckMetrics.prevCheckTimestamp=window.performance.now(),e.stuckPuckMetrics.secondsCounter=0,e.stuckPuckMetrics.stuckDuration=0,e.stuckPuckMetrics.wasPuckOnLeftSide=!1}function ye(){let o=window.visualViewport.width/window.visualViewport.height,t=window.visualViewport.height/window.visualViewport.width,n=16/9;if(Math.abs(o-n)<=.1||Math.abs(t-n)<.1)s.width=window.visualViewport.width,s.height=window.visualViewport.height;else if(Math.abs(o-n)>.1){let i=window.visualViewport.height*16/9;s.width=i,s.height=window.visualViewport.height}else s.width=window.visualViewport.height,s.height=window.visualViewport.width;e.context=s.getContext("2d"),e.puck.adaptToScreen();for(let i of e.allPlayers)i.adaptToScreen();e.prevCanvasDim.width=s.width,e.prevCanvasDim.height=s.height}function H(){e.isOnlineGame&&(X("Disconnected"),B()),oe(P),e.isPaused=!1,e.isGameOver=!0,e.allPlayers=[e.mainPlayer],e.nonMainPlayers=[],e.mainPlayer.name="You",document.removeEventListener("keypress",ie),document.removeEventListener("dblclick",re),G.textContent="0",F.textContent="0",p(s),p(J),p(z),te(),m(v)}var ae=class{#o;#e;#s;#t;#i;#r;#n;constructor(t,n){this.reset(),this.#e=Fe,this.xVel=t,this.yVel=n,this.#n=qe}get radius(){return this.#o}get xPos(){return this.#s}set xPos(t){isNaN(t)||(this.#s=f(-s.width-2*this.#o,t,s.width+2*this.#o))}get yPos(){return this.#t}set yPos(t){isNaN(t)||(this.#t=f(-s.height-2*this.#o,t,s.height+2*this.#o))}get xVel(){return this.#i}set xVel(t){isNaN(t)||(Math.abs(t)<Q&&(t=Math.sign(t)*Q),this.#i=f(-s.width/Me,t,s.width/Me))}get yVel(){return this.#r}set yVel(t){isNaN(t)||(Math.abs(t)<Q&&(t=Math.sign(t)*Q),this.#r=f(-s.height/ve,t,s.height/ve))}resetRadius(){this.#o=Ue*s.width}adaptToScreen(){this.xPos=s.width*this.xPos/e.prevCanvasDim.width,this.yPos=s.height*this.yPos/e.prevCanvasDim.height,this.resetRadius()}reset(){this.resetRadius(),this.xPos=s.width/2,this.yPos=s.height/2,this.xVel=0,this.yVel=0}draw(){let t=e.context;t.beginPath(),t.arc(this.#s,this.#t,this.#o,0,2*Math.PI,!1),t.fillStyle=this.#e,t.fill(),t.closePath()}update(){(!e.isOnlineGame||e.isOnlineGame&&e.isHost)&&(this.xVel*=this.#n,this.yVel*=this.#n,e.isGoal||this.reactToCollisions(),this.xPos+=this.xVel,this.yPos+=this.yVel,je<=e.stuckPuckMetrics.stuckDuration&&(this.reset(),Be())),this.draw()}reactToCollisions(){this.handleBoardCollisions(),this.handlePlayerCollisions()}handleBoardCollisions(){let t=x*s.width+this.#o,n=s.width*(1-x)-this.#o,i=C*s.height+this.#o,r=s.height*(1-C)-this.#o,a=320/900*s.height+2*this.#o,c=580/900*s.height-2*this.#o;if((this.xPos<t||n<this.xPos)&&a<this.yPos&&this.yPos<c||isNaN(this.xPos)){Nt();return}let u=!1;(this.xPos<=t||n<=this.xPos)&&(this.xVel*=-1,u=!0),(this.yPos<=i||r<=this.yPos)&&(this.yVel*=-1,u=!0),u&&M("boardHit",!1),this.xPos<t&&(this.xPos=t+1),n<this.xPos&&(this.xPos=n-1),this.yPos<i&&(this.yPos=i+1),r<this.yPos&&(this.yPos=r-1)}handlePlayerCollisions(){let t=!1;for(let n of e.allPlayers){let i=this.xPos-n.xPos,r=this.yPos-n.yPos,a=Math.sqrt(i*i+r*r),c=this.radius+n.radius,u=a<=c,h=window.performance.now()-n.prevCollisionTimestamp<Xe;if(!u||h)continue;t=!0,n.prevCollisionTimestamp=window.performance.now();let g=i/a,S=r/a;this.xVel=2*(n.xVel*g+n.yVel*S)*g-(this.xVel*g+this.yVel*S)*g,this.yVel=2*(n.xVel*g+n.yVel*S)*S-(this.xVel*g+this.yVel*S)*S,this.xPos=n.xPos+i*c/a,this.yPos=n.yPos+r*c/a}t&&M("playerHit",!1)}};Dt();function Dt(){st(),Ae(),Gt(),Ut(),e.mainPlayer=new k("You",0,e.offlineTeam,"main"),e.mainPlayer.reset(),e.mainPlayer.addToBoard(),e.puck=new ae(0,0),Qe()?s.addEventListener("touchmove",o=>Ct(o)):s.addEventListener("mousemove",o=>wt(o)),window.addEventListener("resize",Mt),ye()}function Ut(){for(let o of document.querySelectorAll(".team-selector"))o.textContent=I(e.offlineTeam),o.dataset.values=j.join(",");for(let o of document.querySelectorAll(".difficulty-selector"))o.textContent=I(e.difficulty),o.dataset.values=pe.join(",");for(let o of document.querySelectorAll(".striker-selector"))o.dataset.value=e.strikerIdx,o.dataset.values=ee.join(",");for(let o of document.querySelectorAll(".players-per-team-selector"))o.textContent=I(e.playersPerTeam),o.dataset.values=He.join(",");b.value=Z*100,le.value=he*100,ue.value=fe*100}function Gt(){window.screen.orientation.addEventListener("change",t=>Ae(t)),document.addEventListener("click",Ne),document.querySelectorAll("button").forEach(t=>t.addEventListener("click",()=>{M("buttonPress",!1)})),v.querySelector(".online-game-btn").onclick=it,v.querySelector(".offline-game-btn").onclick=rt;for(let t of de)t.onclick=at;window.addEventListener("keydown",t=>{t.key==="F11"&&(t.preventDefault(),Oe())});for(let t of me)t.onclick=Oe;let o=document.querySelector(".settings-btn");o.onclick=ct;for(let t of document.querySelectorAll(".menu .home-btn"))t.onclick=n=>lt(n.target);for(let t of document.querySelectorAll(".menu .selector"))t.addEventListener("click",n=>{ut(n.target),n.target.id==="offline-team-selector"?mt():n.target.id==="difficulty-selector"?ht():n.target.id==="players-per-team-selector"?ft():n.target.id==="theme-selector"&&pt(),n.target.textContent=I(n.target.textContent)});for(let t of document.querySelectorAll(".img-selector"))t.addEventListener("click",n=>{let i=n.target.closest(".img-selector");dt(i),(i.id==="create-room-striker-selector"||i.id==="join-room-striker-selector")&&gt(i)});b.oninput=()=>ge(b),le.oninput=()=>ge(le),ue.oninput=()=>ge(ue),ce.querySelector(".start-offline-game-btn").onclick=_t,y.querySelector(".host-menu-btn").onclick=xt,y.querySelector(".join-menu-btn").onclick=yt,L.querySelector(".create-room-btn").onclick=Pt,w.querySelector(".join-room-btn").onclick=kt,w.querySelector(".refresh-btn").onclick=async()=>{N(),await xe(),O()},P.querySelector(".resume-btn").onclick=Ve,P.querySelector(".exit-btn").onclick=St}})();
