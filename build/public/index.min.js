(()=>{function De(o){let t=e.context,n=.03*s.height,r=.05*s.height,i=t.measureText(o).width,c=1.25*r,a=(s.width-i)/2,d=(s.height+c-n)/2,m=(s.width-i)/2-n,h=(s.height-c)/2-n,P=i+2*n,ce=c+2*n,H=.03*s.height;t.fillStyle="hsla(0, 0%, 20%, 0.95)",t.beginPath(),t.moveTo(m+H,h),t.arcTo(m+P,h,m+P,h+ce,H),t.arcTo(m+P,h+ce,m,h+ce,H),t.arcTo(m,h+ce,m,h,H),t.arcTo(m,h,m+P,h,H),t.closePath(),t.fill(),t.beginPath(),t.font=`${r}px "Protest Riot", "Trebuchet MS", sans-serif`,t.textAlign="start",t.textBaseline="alphabetic",t.fillStyle="hsla(0, 0%, 100%, 0.25)",t.fillText(o,a,d),t.closePath()}function f(o,t,n){return Math.max(o,Math.min(t,n))}function Ge(){let o=navigator.userAgent;return/Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/.test(o)}function u(o){o.classList.remove("hidden")}function p(o){o.classList.add("hidden")}function Y(){for(let o of document.querySelectorAll(".menu"))p(o)}function O(){u(B),B.showModal(),B.blur()}function A(){p(B),B.close()}function D(o){clearTimeout(e.toastTimeoutId),p(_),_.querySelector(".toast-msg").textContent=o,_.style.right-=_.width,u(_),e.toastTimeoutId=setTimeout(()=>p(_),Fe)}function E(o){return o[0].toUpperCase()+o.substring(1)}function M(o){return o=Math.floor(o*Te),o}function b(o){return o/Te}function we(o){return isNaN(o.textContent)?0:f(0,parseInt(o.textContent),999)}function Ce(o){let t=o.textContent;isNaN(t)&&(t=-1),o.textContent=(parseInt(t)+1).toString(),Ue(o)}function ve(o,t){let n=o.textContent;isNaN(n)&&(n=0),o.textContent=t.toString(),parseInt(n)!==t&&Ue(o)}function Ue(o){o.classList.remove("strobing-score"),o.offsetWidth,o.classList.add("strobing-score")}function K(o){o.closest("dialog").close()}var S=class o{#o;#t;#s;#e;#n;constructor(t,n,r){if(!t||typeof t!="string"){console.error(`Invalid css selector ${t}`);return}if(n==null||typeof n!="string"){console.error(`Invalid initial value passed for initialization of text selector ${t}`);return}if(r==null||!Array.isArray(r)||r.length===0){console.error(`Invalid array of valid values passed for initialization of text selector ${t}`);return}if(this.#n=r.indexOf(n),this.#n===-1){console.error(`Error during initialization of text selector ${t}: invalid initial value ${n}, because array of valid values does not include initial value`);return}this.#o=t,this.#t=document.querySelectorAll(t),this.#s=r,this.#e=r;for(let i of this.#t)i.textContent=E(n),i.dataset.values=r.join(","),i.onclick=()=>o.onClick(this)}static onClick(t){t.#n=(t.#n+1)%t.#e.length;for(let n of t.#t)n.textContent=E(t.#e[t.#n])}getValue(){return this.#e[this.#n]}updateSelectableValues(t){if(t==null||!Array.isArray(t)||t.length===0){console.error(`Invalid array of values passed to update selectable values of text selector ${this.#o}`);return}for(let n of t)if(!this.#s.includes(n)){console.error(`Invalid value ${n} passed to update selectable values of text selector ${this.#o}`);return}this.#e=t;for(let n of this.#t)n.textContent=E(this.#e[0])}};var W=class o{#o;#t;#s;#e;#n;constructor(t,n){if(!t||typeof t!="string"){console.error("Invalid css selector");return}if(n==null||typeof n!="number"||C<=n){console.error("Invalid initial value passed in for text selector initialization");return}this.#o=t,this.#t=document.querySelectorAll(t);let r=[];for(let i=0;i<C;i++)r[i]=i;this.#s=r,this.#e=r,this.#n=n;for(let i of this.#t)i.onclick=()=>o.onClick(this)}static onClick(t){t.#n=(t.#n+1)%t.#e.length;for(let n of t.#t){let r=n.querySelector("img");r.src=le[t.#e[t.#n]]}}getValue(){return this.#e[this.#n]}updateSelectableValues(t){if(t==null||!Array.isArray(t)||t.length===0){console.error(`Invalid array of values passed to update selectable values of striker selector ${this.#o}`);return}for(let n of t)if(C<=n){console.error(`Invalid value ${n} passed to update selectable values of striker selector ${this.#o}`);return}this.#e=t;for(let n of this.#t){let r=n.querySelector("img");r.src=le[this.#e[0]]}}};var l=!0,qe=Ge(),z=new URL(window.location.href).host,G=10,Me=10,C=4;var be=6e4,Ot=3,Te=Math.pow(10,Ot),$={serverInactivity:{code:3001,reason:"Server inactivity timeout"},wrongChannel:{code:3002,reason:"Wrong channel"},rejectedUsername:{code:3003,reason:"Username rejected by server"}},v=document.querySelector(".menu.home"),je=document.querySelector(".menu.settings"),ue=document.querySelector(".menu.offline"),g=document.querySelector(".menu.online"),V=document.querySelector(".menu.host"),w=document.querySelector(".menu.join"),U=document.querySelector(".menu.rotate-screen"),R=document.getElementById("master-volume-slider"),de=document.getElementById("music-volume-slider"),me=document.getElementById("sfx-volume-slider"),y=document.querySelector(".menu.pause"),J=document.querySelector(".message"),Q=document.querySelector(".scores"),F=document.getElementById("left-score"),q=document.getElementById("right-score"),he=[document.querySelector(".menu.home .mute-toggle-btn"),document.querySelector(".menu.pause .mute-toggle-btn")],pe=[document.querySelector(".menu.home .fullscreen-toggle-btn"),document.querySelector(".menu.pause .fullscreen-toggle-btn")],Re=document.querySelector(".fps-display"),B=document.querySelector(".loading-spinner"),_=document.querySelector(".toast"),s=document.getElementById("board"),T=.008,I=.014,Xe=320/900,He=580/900,Ye=.015,Ke=.0225,We="hsla(0, 0%, 100%, 1)",Z=1,ze=.999,Je=.999,Qe=10,Ze=200,Fe=3e3,ee=1,fe=.9,ge=.8,At=["dark","light"],te=["left","right"],Ie=["easy","medium","hard"],_t=["one","two"],et=["human","ai","remote"],tt=["human","ai"],le=["images/striker-0.svg","images/striker-1.svg","images/striker-2.svg","images/striker-3.svg"],ot=[{name:"G",color:"hsla(190, 100%, 50%, 1)"},{name:"O",color:"hsla(120, 100%, 50%, 1)"},{name:"A",color:"hsla(53, 100%, 50%, 1)"},{name:"L",color:"hsla(35, 100%, 50%, 1)"}],e={remoteState:{channel:"state",userName:"",isHost:!1,team:"",striker:0,playerXPos:0,playerYPos:0,playerXVel:0,playerYVel:0,puckXPos:0,puckYPos:0,puckXVel:0,puckYVel:0,leftScore:0,rightScore:0},connTimeoutMetrics:{prevMsgTimestamp:0,intervalId:-1},webSocketConn:null,userName:null,isOnlineGame:!1,isHost:!1,context:s.getContext("2d"),prevCanvasDim:{width:s.width,height:s.height},fpsMetrics:{canvasFpsCounter:0,prevFrameTimestamp:0},stuckPuckMetrics:{startTimestamp:0,prevCheckTimestamp:0,secondsCounter:0,stuckDuration:0,wasPuckOnLeftSide:!1},fps:60,isGoal:!0,isPaused:!1,isGameOver:!0,mainPlayer:null,players:[],puck:null,pointingDevice:{x:0,y:0},prevMasterGainValue:ee,toastTimeoutId:-1},nt=new S("#create-room-player-type-selector","human",tt),st=new S("#join-room-player-type-selector","human",tt),oe=new S("#offline-team-selector","left",te),it=new S("#create-room-team-selector","left",te),Ne=new S("#join-room-team-selector","left",te),ye=new S(".difficulty-selector","medium",Ie),rt=new S(".players-per-team-selector","two",_t),no=new S(".theme-selector","dark",At),at=new W("#create-room-striker-selector",0),Oe=new W("#join-room-striker-selector",0);var x=class{#o;#t;#s;#e;#n;#r;#i;#a;#l=0;#u=0;#c;prevCollisionTimestamp=0;constructor(t,n,r,i){this.#o=t,this.resetRadius(),this.#s=n,this.#e=r,this.#n=i,this.#r=ye.getValue(),this.#c=Je}get name(){return this.#o}set name(t){if(G<t.length){l&&console.error(`Cannot set player ${this.name}'s name to invalid value ${t}. Min length is 1 and max length is ${G}`);return}this.#o=t}get radius(){return this.#t}get strikerIdx(){return this.#s}set strikerIdx(t){if(t<0||C<=t){l&&console.error(`Cannot set player ${this.name}'s strikerId to invalid value ${t}. Min value is 0 and max value is ${C-1}`);return}this.#s=t}get team(){return this.#e}set team(t){if(t=t.toLowerCase(),!te.includes(t)){l&&console.error(`Cannot set player ${this.name}'s team to invalid value ${t}`);return}this.#e=t}get type(){return this.#n}set type(t){if(t=t.toLowerCase(),!et.includes(t)){l&&console.error(`Cannot set player ${this.name}'s type to invalid value ${t}`);return}this.#n=t}get intelligence(){return this.#r}set intelligence(t){if(t=t.toLowerCase(),!Ie.includes(t)){l&&console.error(`Cannot set player ${this.name}'s intelligence to invalid value ${t}`);return}this.#r=t}get xPos(){return this.#i}set xPos(t){if(!isNaN(t))if(this.#e==="left"){let n=T*s.width+this.#t,r=s.width/2-this.#t;this.#i=f(n,t,r)}else{let n=s.width/2+this.#t,r=s.width*(1-T)-this.#t;this.#i=f(n,t,r)}}get yPos(){return this.#a}set yPos(t){if(isNaN(t))return;let n=I*s.height+this.#t,r=s.height*(1-I)-this.#t;this.#a=f(n,t,r)}get xVel(){return this.#l}set xVel(t){if(isNaN(t))return;let n=Math.abs(t),r=2*e.fps/60;this.#l=Math.sign(t)*Math.min(n,e.fps/r)}get yVel(){return this.#u}set yVel(t){if(isNaN(t))return;let n=Math.abs(t),r=2*e.fps/60;this.#u=Math.sign(t)*Math.min(n,e.fps/r)}addToBoard(){e.players.push(this)}removeFromBoard(){let t=e.players.indexOf(this);t>-1&&e.players.splice(t,1)}resetRadius(){this.#t=Ke*s.width}adaptToScreen(){this.xPos=s.width*this.xPos/e.prevCanvasDim.width,this.yPos=s.height*this.yPos/e.prevCanvasDim.height,this.resetRadius()}reset(){this.resetRadius(),this.#e==="left"?this.xPos=.05*s.width:this.xPos=.95*s.width,this.yPos=s.height/2,this.xVel=0,this.yVel=0}updatePosByAcceleratingTo(t,n){let r=t-this.xPos,i=n-this.yPos,c=.35;this.xVel=c*r,this.yVel=c*i,this.xPos+=this.xVel,this.yPos+=this.yVel}easyAiUpdate(){if(e.puck.xPos===s.width/2&&e.puck.yPos===s.height/2)return;if(this.#e==="right"&&e.puck.xPos+e.puck.radius<s.width/2||this.#e==="left"&&s.width/2<e.puck.xPos+e.puck.radius){this.xVel*=.99,this.yVel*=.99;return}if(this.#e==="right"&&-1<Math.sign(e.puck.xVel)||this.#e==="left"&&Math.sign(e.puck.xVel)<1){let i=e.puck.yPos-this.yPos;Math.abs(i)<=.8*(this.radius+e.puck.radius)?this.yVel*=.99:this.yVel=.2*i}this.xPos=this.#e==="right"?.9*s.width:.1*s.width,this.yPos+=this.yVel;let r=10*60/e.fps;this.xVel=(this.team==="right"?-1:1)*Math.max(r,Math.abs(this.xVel))}mediumAiUpdate(){if(e.puck.xPos===s.width/2&&e.puck.yPos===s.height/2)return;let t=this.#e==="right"&&e.puck.xPos+e.puck.radius<s.width/2||this.#e==="left"&&s.width/2<e.puck.xPos+e.puck.radius,n=this.#e==="right"&&this.xPos<e.puck.xPos||this.#e==="left"&&e.puck.xPos<this.xPos,r=this.#e==="right"&&Math.sign(e.puck.xVel)===-1||this.#e==="left"&&Math.sign(e.puck.xVel)===1,i=10*e.fps/60;if(t||n){let c=t?.05:.1;if(this.#e==="right"){let a=s.width*(1-T)-this.radius-this.xPos;this.xVel=c*a}else if(this.#e==="left"){let a=s.width*T+this.radius-this.xPos;this.xVel=c*a}this.yVel=c*(s.height/2-this.yPos)}else if(r&&i<Math.abs(e.puck.xVel))this.xVel*=.99,this.yVel*=.99;else{let c=e.puck.xPos-this.xPos,a=e.puck.yPos-this.yPos,d=.0075,m,h=Math.random();h<.5?m=.35:.5<=h&&h<=.8?m=.2:m=.1,this.xVel+=d*c,this.yVel=m*a}this.xPos+=this.xVel,this.yPos+=this.yVel}hardAiUpdate(){if(e.isGoal)return;let t=this.team==="right"?.9*s.width:.1*s.width,n=s.height/2-e.puck.yPos,r=(s.height*(1-2*I)-2*this.radius)/2,i=e.puck.yPos+e.puck.radius*n/r;this.updatePosByAcceleratingTo(t,i),this.xVel=(this.team==="right"?-1:1)*Math.max(10*60/e.fps,Math.abs(this.xVel)),this.yVel=(e.puck.yPos<this.yPos?-1:1)*Math.max(10*60/e.fps,Math.abs(this.yVel))}update(){if(this.type==="ai")switch(this.intelligence){case"easy":this.easyAiUpdate();break;case"medium":this.mediumAiUpdate();break;case"hard":this.hardAiUpdate()}else this.type==="human"&&(this.xVel*=this.#c,this.yVel*=this.#c,this.updatePosByAcceleratingTo(e.pointingDevice.x,e.pointingDevice.y));this.draw()}draw(){let t=e.context;t.beginPath(),t.arc(this.#i,this.#a,this.#t,0,2*Math.PI,!1),t.fillStyle="hsla(0, 0%, 100%, 1)",t.fill(),t.closePath(),t.beginPath(),t.arc(this.#i,this.#a,.8*this.#t,0,2*Math.PI,!1),t.fillStyle=ot[this.#s].color,t.fill(),t.closePath()}};var j=new(window.AudioContext||window.webkitAudioContext),N=j.createGain(),ne=j.createGain(),se=j.createGain(),ct={bgm:"audio/bgm.mp3",buttonPress:"audio/button-press.mp3",boardHit:"audio/board-hit.mp3",playerHit:"audio/player-hit.mp3",goal:"audio/goal.mp3"};ne.gain.value=fe;se.gain.value=ge;N.gain.value=ee;ne.connect(N);se.connect(N);N.connect(j.destination);var lt=new Map;function Et(o,t){fetch(t).then(n=>n.arrayBuffer()).then(n=>j.decodeAudioData(n)).then(n=>{lt.set(o,n)}).catch(n=>console.error(`Error loading sound ${o}. Reason: `,n))}function ut(){for(let o of Object.keys(ct))Et(o,ct[o])}function k(o,t){let n=j.createBufferSource();return n.buffer=lt.get(o),n.buffer===null?!1:(o==="bgm"?n.connect(ne):n.connect(se),n.loop=t,n.start(0),!0)}function dt(){p(v),g.querySelector(".error-msg").textContent="",u(g),document.getElementById("user-name").focus()}function mt(){p(v),u(ue)}function Ae(){k("bgm",!0)&&document.removeEventListener("click",Ae)}function ht(){for(let t of he){let n=t.querySelector("img");n.src.includes("unmuted")?(n.src=n.src.replace("unmuted.svg","muted.svg"),R.disabled=!0,R.style.cursor="not-allowed"):(n.src=n.src.replace("muted.svg","unmuted.svg"),R.disabled=!1,R.style.cursor="grab")}let o=N.gain.value;N.gain.value=N.gain.value===0?e.prevMasterGainValue:0,e.prevMasterGainValue=o}function _e(){for(let o of pe){let t=o.querySelector("img");document.fullscreenElement?document.exitFullscreen&&(t.src=t.src.replace("windowed.svg","fullscreen.svg")):t.src=t.src.replace("fullscreen.svg","windowed.svg")}document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}function pt(){p(v),u(je)}function ft(o){e.webSocketConn!==null&&(e.webSocketConn.close(),L());let t=o.closest(".menu");p(t),u(v)}function Ee(o){o===void 0&&window.innerWidth<window.innerHeight||o!==void 0&&o.target.type.includes("portrait")?(u(U),U.showModal(),U.blur()):(o===void 0&&window.innerHeight<window.innerWidth||o!==void 0&&o.target.type.includes("landscape"))&&(p(U),K(U))}function xe(o){o.id==="master-volume-slider"?N.gain.value=f(0,o.value/100,1):o.id==="music-volume-slider"?ne.gain.value=f(0,o.value/100,1):o.id==="sfx-volume-slider"&&(se.gain.value=f(0,o.value/100,1))}async function gt(){g.querySelector(".error-msg").textContent="",O(),await Ve(),A(),e.webSocketConn!==null&&(p(g),u(V),document.getElementById("create-room-name").focus())}async function yt(){g.querySelector(".error-msg").textContent="",O(),await Ve(),A(),e.webSocketConn!==null&&(p(g),w.querySelector(".error-msg").textContent="",u(w),O(),await ke(),A())}async function xt(){let o=V.querySelector(".error-msg");o.textContent="";let n=document.getElementById("create-room-name").value.trim(),r=it.getValue(),i=at.getValue(),c=nt.getValue();O(),await Tt(n,r,i,c),A()}async function kt(){let o=w.querySelector(".error-msg");o.textContent="";let t=document.querySelector(".join-room-list > .join-room-item.selected");if(t===null){o.textContent="Please select a room";return}let n=t.textContent.trim(),r=Ne.getValue(),i=Oe.getValue(),c=st.getValue();O(),await Mt(n,r,i,c),A()}function ie(o){o.key!=="p"&&o.key!=="P"||(e.isPaused?$e({target:y}):(k("buttonPress",!1),e.isPaused=!0,u(y),y.showModal(),document.activeElement.blur()))}function re(){k("buttonPress",!1),e.isPaused=!0,u(y),y.showModal(),document.activeElement.blur()}function $e(o){K(o.target),p(y),e.isPaused=!1,Le()}function Pt(){e.isOnlineGame?e.webSocketConn.close():X()}function St(o){let t=o.offsetX!==void 0?o.offsetX:o.layerX,n=o.offsetY!==void 0?o.offsetY:o.layerY;e.pointingDevice.x=t,e.pointingDevice.y=n}function wt(o){let t=o.targetTouches[0].clientX-o.target.getBoundingClientRect().left,n=o.targetTouches[0].clientY-o.target.getBoundingClientRect().top;e.pointingDevice.x=t,e.pointingDevice.y=n}function Ct(){requestAnimationFrame(Pe)}function vt(o){let t=document.querySelector(".join-room-list > .join-room-item.selected");t!==null&&t.classList.remove("selected"),o.classList.add("selected"),Ne.updateSelectableValues(o.dataset.teams.split(","));let r=o.dataset.strikers.split(",").map(i=>parseInt(i));Oe.updateSelectableValues(r)}function Ve(){return new Promise(o=>{if(e.webSocketConn!==null){o();return}let t=document.getElementById("user-name"),n=g.querySelector(".error-msg");if(n.textContent="",t.value===""){n.textContent="User name cannot be empty",L(),o();return}else if(G<t.value.length){n.textContent=`User name cannot be more than ${G} characters`,L(),o();return}e.webSocketConn=new WebSocket(`ws://${z}/user`),e.webSocketConn.onopen=()=>{l&&console.log("Web socket connection established"),e.webSocketConn.send(JSON.stringify({channel:"handshake",userName:t.value.trim()})),l&&console.log("Sent web socket message on 'handshake' channel")},e.webSocketConn.onmessage=r=>{l&&console.log("Received web socket message during handshake");let i=JSON.parse(r.data);if(i.channel!=="handshake"){l&&console.error("Received web socket message from invalid channel during handshake"),e.webSocketConn.close($.wrongChannel.code,$.wrongChannel.reason);return}if(l&&console.log("Received web socket message on 'handshake' channel"),i.isSuccess){e.userName=t.value.trim(),e.webSocketConn.onmessage=null,o();return}else{n.textContent=E(i.message),e.webSocketConn.close($.rejectedUsername.code,$.rejectedUsername.reason);return}},e.webSocketConn!==null&&(e.webSocketConn.onerror=()=>{l&&console.error("Error during web socket communication"),n.textContent="Error while communicating with server",e.webSocketConn.close(1002)}),e.webSocketConn!==null&&(e.webSocketConn.onclose=()=>{e.userName===null?(l&&console.log("Web socket connection closed"),n.textContent===""&&(n.textContent="Can't connect to server"),L(),o()):l&&console.log("Web socket connection closed due to user clicking home button")})})}function bt(o,t,n){e.isOnlineGame=!0,e.isPaused=!1,e.fps=30,$t(),Y(),u(s),u(J),u(Q),document.addEventListener("keypress",r=>ie(r)),document.addEventListener("dblclick",re),e.mainPlayer.name=e.userName,e.mainPlayer.team=o,e.mainPlayer.strikerIdx=t,e.mainPlayer.type=n,e.webSocketConn.onmessage=r=>{e.connTimeoutMetrics.prevMsgTimestamp=window.performance.now();let i=JSON.parse(r.data);switch(i.channel){case"memberLeft":{l&&console.log("Received web socket message on 'memberLeft' channel");let c=null;for(let a of e.players)if(!(a.name!==i.userName||a===e.mainPlayer)){c=a;break}c!==null&&(c.removeFromBoard(),D(`Player ${c.name} left the room`))}break;case"reassignHost":e.isHost=!0,D("You are now the host");break;case"state":{l&&console.log(`Received web socket message on 'state' channel. Remote state originated from remote user ${i.userName}`);let c=!1;for(let a of e.players)if(!(a.name!==i.userName||a===e.mainPlayer)){c=!0,a.xPos=b(i.playerXPos)*s.width,a.yPos=b(i.playerYPos)*s.height,a.xVel=b(i.playerXVel)*s.width,a.yVel=b(i.playerYVel)*s.height,i.isHost&&(e.puck.xPos=b(i.puckXPos)*s.width,e.puck.yPos=b(i.puckYPos)*s.height,e.puck.xVel=b(i.puckXVel)*s.width,e.puck.yVel=b(i.puckYVel)*s.height,ve(F,i.leftScore),ve(q,i.rightScore));break}if(!c&&i.userName!==e.userName){if(e.players.length===C){console.error(`Server is trying to add a new player when room is full; current room count is ${C}`);return}new x(i.userName,i.striker,i.team,"remote").addToBoard(),D(`Player ${i.userName} joined`)}}break;default:l&&console.error(`Received web socket message from invalid channel named '${i.channel}'`)}},e.webSocketConn.onerror=r=>{l&&console.error("Error during web socket communication. Reason: ",r),e.webSocketConn.close(1002)},e.webSocketConn.onclose=()=>{l&&console.log("Web socket connection closed"),X()},Se()}async function Tt(o,t,n,r){let i=V.querySelector(".error-msg"),c=l?"http":"https",a=null;if(o===""){i.textContent="Room name cannot be empty";return}else if(Me<o.length){i.textContent=`Room name cannot be more than ${Me} characters`;return}try{a=await fetch(`${c}://${z}/room`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomName:o,userName:e.userName,team:t,striker:n})})}catch(d){console.error("Error occurred while creating room. Reason: ",d),i.textContent="Can't connect to server";return}if(a!==null&&a.ok)e.isHost=!0,bt(t,n,r);else if(a!==null){let d=await a.text();i.textContent=E(d)}else i.textContent="Something went wrong"}async function ke(){let o=w.querySelector(".error-msg"),t=l?"http":"https",n=null;try{n=await fetch(`${t}://${z}/rooms`)}catch(r){console.error("Failed to fetch joinable rooms list. Reason: ",r),o.textContent="Failed to fetch rooms";return}if(n!==null&&n.ok){let r=await n.json(),i=w.querySelector(".join-room-list");if(o.textContent="",i.innerHTML="",r.length===0)i.innerHTML='<div class="no-rooms-msg">Please create a room to play</div>',i.style.justifyContent="center",o.textContent="No rooms available";else{i.style.justifyContent="start";for(let c=0;c<r.length;c++){let a=r[c],d=document.createElement("button");d.classList.add("menu-btn","join-room-item"),d.textContent=a.roomName,d.dataset.idx=c.toString(),d.dataset.name=a.roomName;let m=[];a.canJoinLeftTeam&&m.push("left"),a.canJoinRightTeam&&m.push("right"),d.dataset.teams=m.join(","),d.dataset.strikers=a.availableStrikers.join(","),d.onclick=()=>{k("buttonPress",!1),vt(d)},i.appendChild(d)}}}else o.textContent="Something went wrong"}async function Mt(o,t,n,r){let i=w.querySelector(".error-msg");i.textContent="";let c=l?"http":"https",a=null;try{a=await fetch(`${c}://${z}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomName:o,userName:e.userName,team:t,striker:n})})}catch(d){console.error("Error occurred while joining room. Reason: ",d),i.textContent="Can't connect to server";return}a!==null&&a.ok?(e.isHost=!1,bt(t,n,r)):a!==null?i.textContent=await a.text():i.textContent="Something went wrong"}function Rt(){if(e.webSocketConn===null){l&&console.error("Cannot send remote state to server as web socket connection does not exist"),X();return}else if(e.webSocketConn.readyState!==WebSocket.OPEN){l&&console.error("Cannot send remote state to server as web socket connection is not in the open state"),X();return}e.remoteState.userName=e.userName,e.remoteState.isHost=e.isHost,e.remoteState.team=e.mainPlayer.team,e.remoteState.striker=e.mainPlayer.strikerIdx,e.remoteState.playerXPos=M(e.mainPlayer.xPos/s.width),e.remoteState.playerYPos=M(e.mainPlayer.yPos/s.height),e.remoteState.playerXVel=M(e.mainPlayer.xVel/s.width),e.remoteState.playerYVel=M(e.mainPlayer.yVel/s.height),e.isHost?(e.remoteState.puckXPos=M(e.puck.xPos/s.width),e.remoteState.puckYPos=M(e.puck.yPos/s.height),e.remoteState.puckXVel=M(e.puck.xVel/s.width),e.remoteState.puckYVel=M(e.puck.yVel/s.height),e.remoteState.leftScore=we(F),e.remoteState.rightScore=we(q)):(e.remoteState.puckXPos=void 0,e.remoteState.puckYPos=void 0,e.remoteState.puckXVel=void 0,e.remoteState.puckYVel=void 0,e.remoteState.leftScore=void 0,e.remoteState.rightScore=void 0),e.webSocketConn.send(JSON.stringify(e.remoteState))}function $t(){e.connTimeoutMetrics.prevMsgTimestamp=window.performance.now(),e.connTimeoutMetrics.intervalId=setInterval(Vt,be/2)}function Vt(){if(!e.isOnlineGame||e.webSocketConn===null)return;let o=window.performance.now()-e.connTimeoutMetrics.prevMsgTimestamp;be<o&&e.webSocketConn.close($.serverInactivity.code,$.serverInactivity.reason)}function Lt(){clearInterval(e.connTimeoutMetrics.intervalId),e.connTimeoutMetrics.intervalId=-1,e.connTimeoutMetrics.prevMsgTimestamp=1/0}function L(){Lt(),e.webSocketConn=null,e.userName=null,e.mainPlayer.name="You",e.mainPlayer.team="left",e.mainPlayer.strikerIdx=0,e.isOnlineGame=!1,e.isHost=!1}function Le(){Be(),e.fpsMetrics.prevFrameTimestamp=window.performance.now(),requestAnimationFrame(It)}function It(){let o=!e.isGameOver&&(e.isOnlineGame||!e.isPaused);if(!o)return;let t=1e3/e.fps,n=window.performance.now(),r=n-e.fpsMetrics.prevFrameTimestamp;if(t<=r){if(e.fpsMetrics.prevFrameTimestamp=n-r%t,e.context.clearRect(0,0,s.width,s.height),e.players.length===1)De("Waiting for other players to join");else{e.puck.update();for(let i of e.players)i.update()}e.isOnlineGame&&Rt(),l&&e.fpsMetrics.canvasFpsCounter++}e.isGoal||qt(),Bt(),o=!e.isGameOver&&(e.isOnlineGame||!e.isPaused),o&&requestAnimationFrame(It)}function Nt(){e.isOnlineGame=!1,e.isPaused=!1,e.fps=60,Y(),u(s),u(J),u(Q),document.addEventListener("keypress",i=>ie(i)),document.addEventListener("dblclick",re),e.mainPlayer.team=oe.getValue(),e.mainPlayer.reset();let o=oe.getValue(),t=o==="left"?"right":"left",n=ye.getValue(),r=rt.getValue();if(r==="one"){let i=new x("Tom",1,t,"ai");i.reset(),i.addToBoard(),i.intelligence=n}else if(r==="two"){let i=new x("Tom",1,o,"ai");i.reset(),i.addToBoard();let c=new x("Laura",2,t,"ai");c.reset(),c.addToBoard();let a=new x("Sophie",3,t,"ai");a.reset(),a.addToBoard(),n==="easy"?(i.intelligence="medium",c.intelligence="easy",a.intelligence="medium"):n==="medium"?(i.intelligence="easy",c.intelligence="easy",a.intelligence="medium"):n==="hard"&&(i.intelligence="easy",c.intelligence="medium",a.intelligence="hard")}Se()}function Se(){e.isGameOver=!0,e.puck.reset();for(let o of e.players)o.reset();e.isGameOver=!1,e.isGoal=!1,Le()}function Bt(){Gt(),!e.isGoal&&(Dt(),Ut())}function Dt(){let o=T*s.width+e.puck.radius,t=s.width*(1-T)-e.puck.radius,n=I*s.height+e.puck.radius,r=s.height*(1-I)-e.puck.radius,i=Xe*s.height+2*e.puck.radius,c=He*s.height-2*e.puck.radius;if((e.puck.xPos<o||t<e.puck.xPos)&&i<e.puck.yPos&&e.puck.yPos<c||isNaN(e.puck.xPos)){Ft();return}let a=!1;(e.puck.xPos<=o||t<=e.puck.xPos)&&(e.puck.xVel*=-1,a=!0),(e.puck.yPos<=n||r<=e.puck.yPos)&&(e.puck.yVel*=-1,a=!0),a&&k("boardHit",!1),e.puck.xPos<o&&(e.puck.xPos=o+1),t<e.puck.xPos&&(e.puck.xPos=t-1),e.puck.yPos<n&&(e.puck.yPos=n+1),r<e.puck.yPos&&(e.puck.yPos=r-1)}function Gt(){for(let o of e.players){if(o.type!=="ai")continue;let t=s.width/2+o.radius,n=s.width*(1-T)-o.radius;o.team==="left"&&(t=s.width*T+o.radius,n=s.width/2-o.radius);let r=I*s.height+o.radius,i=s.height*(1-I)-o.radius;(o.xPos<=t||n<=o.xPos)&&(o.xVel=0,o.xPos=o.xPos<=t?t+1:n-1),(o.yPos<=r||i<=o.yPos)&&(o.yVel=0,o.yPos=o.yPos<=r?r+1:i-1)}}function Ut(){let o=!1;for(let t of e.players){let n=e.puck.xPos-t.xPos,r=e.puck.yPos-t.yPos,i=Math.sqrt(n*n+r*r),c=e.puck.radius+t.radius,a=i<=c,m=window.performance.now()-t.prevCollisionTimestamp<Ze;if(!a||m)continue;o=!0,t.prevCollisionTimestamp=window.performance.now();let h=n/i,P=r/i;e.puck.xVel=2*(t.xVel*h+t.yVel*P)*h-(e.puck.xVel*h+e.puck.yVel*P)*h,e.puck.yVel=2*(t.xVel*h+t.yVel*P)*P-(e.puck.xVel*h+e.puck.yVel*P)*P,e.puck.xPos=t.xPos+n*c/i,e.puck.yPos=t.yPos+r*c/i}o&&k("playerHit",!1)}function Ft(){let o=7*e.fps/60;e.puck.xVel=Math.sign(e.puck.xVel)*Math.max(o,e.puck.xVel),e.puck.yVel=0,e.isGoal=!0,k("goal",!1),e.puck.xPos<s.width/2?Ce(q):Ce(F),setTimeout(Se,2e3)}function qt(){let o=e.stuckPuckMetrics.prevCheckTimestamp-e.stuckPuckMetrics.startTimestamp,t=e.stuckPuckMetrics.secondsCounter<=Math.floor(o/1e3),n=e.puck.xPos<s.width/2;e.puck.xPos===s.width/2||e.stuckPuckMetrics.wasPuckOnLeftSide!==n?e.stuckPuckMetrics.stuckDuration=0:t&&e.stuckPuckMetrics.stuckDuration++,t&&e.stuckPuckMetrics.secondsCounter++,e.stuckPuckMetrics.prevCheckTimestamp=window.performance.now(),e.stuckPuckMetrics.wasPuckOnLeftSide=n}function Be(){e.stuckPuckMetrics.startTimestamp=window.performance.now(),e.stuckPuckMetrics.prevCheckTimestamp=window.performance.now(),e.stuckPuckMetrics.secondsCounter=0,e.stuckPuckMetrics.stuckDuration=0,e.stuckPuckMetrics.wasPuckOnLeftSide=!1}function Pe(){let o=window.visualViewport.width/window.visualViewport.height,t=window.visualViewport.height/window.visualViewport.width,n=16/9;if(Math.abs(o-n)<=.1||Math.abs(t-n)<.1)s.width=window.visualViewport.width,s.height=window.visualViewport.height;else if(Math.abs(o-n)>.1){let r=window.visualViewport.height*16/9;s.width=r,s.height=window.visualViewport.height}else s.width=window.visualViewport.height,s.height=window.visualViewport.width;e.context=s.getContext("2d"),e.puck.adaptToScreen();for(let r of e.players)r.adaptToScreen();e.prevCanvasDim.width=s.width,e.prevCanvasDim.height=s.height}function X(){e.isOnlineGame&&(D("Disconnected"),L()),K(y),e.isPaused=!1,e.isGameOver=!0,e.fps=60,e.players=[e.mainPlayer],e.mainPlayer.name="You",e.mainPlayer.type="human",document.removeEventListener("keypress",ie),document.removeEventListener("dblclick",re),F.textContent="0",q.textContent="0",p(s),p(J),p(Q),Y(),u(v)}var ae=class{#o;#t;#s;#e;#n;#r;#i;constructor(t,n){this.reset(),this.#t=We,this.xVel=t,this.yVel=n,this.#i=ze}get radius(){return this.#o}get xPos(){return this.#s}set xPos(t){isNaN(t)||(this.#s=f(-s.width-2*this.#o,t,s.width+2*this.#o))}get yPos(){return this.#e}set yPos(t){isNaN(t)||(this.#e=f(-s.height-2*this.#o,t,s.height+2*this.#o))}get xVel(){return this.#n}set xVel(t){if(isNaN(t))return;let n=Math.abs(t);n<Z&&(t=Math.sign(t)*Z);let r=3*e.fps/60;this.#n=Math.sign(t)*Math.min(n,e.fps/r)}get yVel(){return this.#r}set yVel(t){if(isNaN(t))return;let n=Math.abs(t);n<Z&&(t=Math.sign(t)*Z);let r=3*e.fps/60;this.#r=Math.sign(t)*Math.min(n,e.fps/r)}resetRadius(){this.#o=Ye*s.width}adaptToScreen(){this.xPos=s.width*this.xPos/e.prevCanvasDim.width,this.yPos=s.height*this.yPos/e.prevCanvasDim.height,this.resetRadius()}reset(){this.resetRadius(),this.xPos=s.width/2,this.yPos=s.height/2,this.xVel=0,this.yVel=0}draw(){let t=e.context;t.beginPath(),t.arc(this.#s,this.#e,this.#o,0,2*Math.PI,!1),t.fillStyle=this.#t,t.fill(),t.closePath()}update(){(!e.isOnlineGame||e.isOnlineGame&&e.isHost)&&(this.xVel*=this.#i,this.yVel*=this.#i,this.xPos+=this.xVel,this.yPos+=this.yVel,Qe<=e.stuckPuckMetrics.stuckDuration&&(this.reset(),Be())),this.draw()}};jt();function jt(){ut(),Ee(),Yt(),Ht(),e.mainPlayer=new x("You",0,oe.getValue(),"human"),e.mainPlayer.reset(),e.mainPlayer.addToBoard(),e.puck=new ae(0,0),qe?s.addEventListener("touchmove",o=>wt(o)):s.addEventListener("mousemove",o=>St(o)),window.addEventListener("resize",Ct),Pe(),l&&Xt()}function Xt(){u(Re),setInterval(()=>{Re.textContent=e.fpsMetrics.canvasFpsCounter.toString(),e.fpsMetrics.canvasFpsCounter=0},1e3)}function Ht(){R.value=ee*100,de.value=fe*100,me.value=ge*100}function Yt(){window.screen.orientation.addEventListener("change",t=>Ee(t)),document.addEventListener("click",Ae),document.querySelectorAll("button").forEach(t=>t.addEventListener("click",()=>{k("buttonPress",!1)})),v.querySelector(".online-game-btn").onclick=dt,v.querySelector(".offline-game-btn").onclick=mt;for(let t of he)t.onclick=ht;window.addEventListener("keydown",t=>{t.key==="F11"&&(t.preventDefault(),_e())});for(let t of pe)t.onclick=_e;let o=document.querySelector(".settings-btn");o.onclick=pt;for(let t of document.querySelectorAll(".menu .home-btn"))t.onclick=n=>ft(n.target);R.oninput=()=>xe(R),de.oninput=()=>xe(de),me.oninput=()=>xe(me),ue.querySelector(".start-offline-game-btn").onclick=Nt,g.querySelector(".host-menu-btn").onclick=gt,g.querySelector(".join-menu-btn").onclick=yt,V.querySelector(".create-room-btn").onclick=xt,w.querySelector(".join-room-btn").onclick=kt,w.querySelector(".refresh-btn").onclick=async()=>{O(),await ke(),A()},y.querySelector(".resume-btn").onclick=$e,y.querySelector(".exit-btn").onclick=Pt}})();
