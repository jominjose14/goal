(()=>{function $e(o){let t=e.context,n=.03*i.height,s=.05*i.height,r=t.measureText(o).width,a=1.25*s,c=(i.width-r)/2,p=(i.height+a-n)/2,d=(i.width-r)/2-n,m=(i.height-a)/2-n,P=r+2*n,ce=a+2*n,H=.03*i.height;t.fillStyle="hsla(0, 0%, 20%, 0.95)",t.beginPath(),t.moveTo(d+H,m),t.arcTo(d+P,m,d+P,m+ce,H),t.arcTo(d+P,m+ce,d,m+ce,H),t.arcTo(d,m+ce,d,m,H),t.arcTo(d,m,d+P,m,H),t.closePath(),t.fill(),t.beginPath(),t.font=`${s}px "Protest Riot", "Trebuchet MS", sans-serif`,t.textAlign="start",t.textBaseline="alphabetic",t.fillStyle="hsla(0, 0%, 100%, 0.25)",t.fillText(o,c,p),t.closePath()}function g(o,t,n){return Math.max(o,Math.min(t,n))}function Be(){let o=navigator.userAgent;return/Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/.test(o)}function u(o){o.classList.remove("hidden")}function h(o){o.classList.add("hidden")}function W(){for(let o of document.querySelectorAll(".menu"))h(o)}function b(){u(B),B.showModal(),B.blur()}function R(){h(B),B.close()}function U(o){clearTimeout(e.toastTimeoutId),h(N),N.querySelector(".toast-msg").textContent=o,N.style.right-=N.width,u(N),e.toastTimeoutId=setTimeout(()=>h(N),qe)}function w(o){return o[0].toUpperCase()+o.substring(1)}function v(o){return o=Math.floor(o*ve),o}function I(o){return o/ve}function Se(o){return isNaN(o.textContent)?0:g(0,parseInt(o.textContent),999)}function we(o){let t=o.textContent;isNaN(t)&&(t=-1),o.textContent=(parseInt(t)+1).toString(),Ue(o)}function Ce(o,t){let n=o.textContent;isNaN(n)&&(n=0),o.textContent=t.toString(),parseInt(n)!==t&&Ue(o)}function Ue(o){o.classList.remove("strobing-score"),o.offsetWidth,o.classList.add("strobing-score")}function Me(o){o.textContent=o.dataset.values.split(",").at(-1),o.click()}function Te(o){o.dataset.value=o.dataset.values.split(",").at(-1),o.click()}function Ge(o){o.dataset.values=G.join(","),Me(o)}function Fe(o){o.dataset.values=z.join(","),Te(o)}function J(o){o.closest("dialog").close()}var l=!0,je=Be(),Q=new URL(window.location.href).host,F=10,Ie=10,O=4;var _e=6e4,Lt=3,ve=Math.pow(10,Lt),L={serverInactivity:{code:3001,reason:"Server inactivity timeout"},wrongChannel:{code:3002,reason:"Wrong channel"},rejectedUsername:{code:3003,reason:"Username rejected by server"}},C=document.querySelector(".menu.home"),Ke=document.querySelector(".menu.settings"),le=document.querySelector(".menu.offline"),y=document.querySelector(".menu.online"),V=document.querySelector(".menu.host"),S=document.querySelector(".menu.join"),q=document.querySelector(".menu.rotate-screen"),_=document.getElementById("master-volume-slider"),ue=document.getElementById("music-volume-slider"),de=document.getElementById("sfx-volume-slider"),x=document.querySelector(".menu.pause"),Z=document.querySelector(".message"),ee=document.querySelector(".scores"),j=document.getElementById("left-score"),K=document.getElementById("right-score"),me=[document.querySelector(".menu.home .mute-toggle-btn"),document.querySelector(".menu.pause .mute-toggle-btn")],he=[document.querySelector(".menu.home .fullscreen-toggle-btn"),document.querySelector(".menu.pause .fullscreen-toggle-btn")],Ae=document.querySelector(".fps-display"),B=document.querySelector(".loading-spinner"),N=document.querySelector(".toast"),i=document.getElementById("board"),M=.008,A=.014,Xe=320/900,Ye=580/900,He=.015,We=.0225,Je="hsla(0, 0%, 100%, 1)",f=60,Ee=1e3/f,eo=3*(f/60)*16,to=3*(f/60)*9,te=1,ze=.999,Qe=.999;var D=1.5;var Ze=10,et=200,qe=3e3;var oe=1,fe=.9,pe=.8;var G=["left","right"],ge=["easy","medium","hard"],tt=["one","two"],ot=["main","ai","remote"],z=[];for(let o=0;o<O;o++)z.push(o);var nt=["images/striker-0.svg","images/striker-1.svg","images/striker-2.svg","images/striker-3.svg"],st=[{name:"G",color:"hsla(190, 100%, 50%, 1)"},{name:"O",color:"hsla(120, 100%, 50%, 1)"},{name:"A",color:"hsla(53, 100%, 50%, 1)"},{name:"L",color:"hsla(35, 100%, 50%, 1)"}],e={remoteState:{channel:"state",userName:"",isHost:!1,team:"",striker:0,playerXPos:0,playerYPos:0,playerXVel:0,playerYVel:0,puckXPos:0,puckYPos:0,puckXVel:0,puckYVel:0,leftScore:0,rightScore:0},connTimeoutMetrics:{prevMsgTimestamp:0,intervalId:-1},webSocketConn:null,userName:null,isOnlineGame:!1,isHost:!1,context:i.getContext("2d"),prevCanvasDim:{width:i.width,height:i.height},fpsMetrics:{canvasFpsCounter:0,prevFrameTimestamp:0},stuckPuckMetrics:{startTimestamp:0,prevCheckTimestamp:0,secondsCounter:0,stuckDuration:0,wasPuckOnLeftSide:!1},isGoal:!0,isPaused:!1,isGameOver:!0,mainPlayer:null,allPlayers:[],nonMainPlayers:[],puck:null,pointingDevice:{x:0,y:0},pressedKeys:{ArrowUp:!1,ArrowRight:!1,ArrowDown:!1,ArrowLeft:!1},strikerIdx:"0",offlineTeam:"left",difficulty:"medium",playersPerTeam:"two",prevMasterGainValue:oe,toastTimeoutId:-1};var k=class{#o;#t;#s;#e;#i;#r;#n;#a;#l=0;#u=0;#c;#d=null;prevCollisionTimestamp=0;constructor(t,n,s,r){this.#o=t,this.resetRadius(),this.#s=n,this.#e=s,this.#i=r,this.#r=e.difficulty,this.#c=Qe}get name(){return this.#o}set name(t){if(F<t.length){l&&console.error(`Cannot set player ${this.name}'s name to invalid value ${t}. Min length is 1 and max length is ${F}`);return}this.#o=t}get radius(){return this.#t}get strikerIdx(){return this.#s}set strikerIdx(t){if(t<0||O<=t){l&&console.error(`Cannot set player ${this.name}'s strikerId to invalid value ${t}. Min value is 0 and max value is ${O-1}`);return}this.#s=t}get team(){return this.#e}set team(t){if(t=t.toLowerCase(),!G.includes(t)){l&&console.error(`Cannot set player ${this.name}'s team to invalid value ${t}`);return}this.#e=t}get type(){return this.#i}set type(t){if(t=t.toLowerCase(),!ot.includes(t)){l&&console.error(`Cannot set player ${this.name}'s type to invalid value ${t}`);return}this.#i=t}get intelligence(){return this.#r}set intelligence(t){if(t=t.toLowerCase(),!ge.includes(t)){l&&console.error(`Cannot set player ${this.name}'s intelligence to invalid value ${t}`);return}this.#r=t}get xPos(){return this.#n}set xPos(t){if(!isNaN(t))if(this.#e==="left"){let n=M*i.width+this.#t,s=i.width/2-this.#t;this.#n=g(n,t,s)}else{let n=i.width/2+this.#t,s=i.width*(1-M)-this.#t;this.#n=g(n,t,s)}}get yPos(){return this.#a}set yPos(t){if(isNaN(t))return;let n=A*i.height+this.#t,s=i.height*(1-A)-this.#t;this.#a=g(n,t,s)}get xVel(){return this.#l}set xVel(t){if(isNaN(t))return;let n=Math.abs(t);this.#l=Math.sign(t)*Math.min(n,f/2)}get yVel(){return this.#u}set yVel(t){if(isNaN(t))return;let n=Math.abs(t);this.#u=Math.sign(t)*Math.min(n,f/2)}addToBoard(){e.allPlayers.push(this),this.#i!=="main"&&e.nonMainPlayers.push(this)}removeFromBoard(){let t=e.nonMainPlayers.indexOf(this);t>-1&&e.nonMainPlayers.splice(t,1),t=e.allPlayers.indexOf(this),t>-1&&e.allPlayers.splice(t,1)}resetRadius(){this.#t=We*i.width}adaptToScreen(){this.xPos=i.width*this.xPos/e.prevCanvasDim.width,this.yPos=i.height*this.yPos/e.prevCanvasDim.height,this.resetRadius()}reset(){this.resetRadius(),this.#e==="left"?this.xPos=.05*i.width:this.xPos=.95*i.width,this.yPos=i.height/2,this.xVel=0,this.yVel=0}updatePosByAcceleratingTo(t,n){let s=t-this.xPos,r=n-this.yPos,a=.35;this.xVel=a*s,this.yVel=a*r,this.xPos+=this.xVel,this.yPos+=this.yVel}updatePosUsingKeys(){for(let t of Object.keys(e.pressedKeys))if(e.pressedKeys[t])switch(t){case"ArrowUp":this.yVel=Math.min(0,this.yVel-D);break;case"ArrowRight":this.xVel=Math.max(0,this.xVel+D);break;case"ArrowDown":this.yVel=Math.max(0,this.yVel+D);break;case"ArrowLeft":this.xVel=Math.min(0,this.xVel-D);break;default:console.error("Invalid arrow key")}this.xPos+=this.xVel,this.yPos+=this.yVel}updateVelUsingJoyStick(t,n){let s=D*t,r=D*n;this.xVel+=s,this.yVel+=r}easyAiUpdate(){if(e.puck.xPos===i.width/2&&e.puck.yPos===i.height/2)return;if(this.#e==="right"&&e.puck.xPos+e.puck.radius<i.width/2||this.#e==="left"&&i.width/2<e.puck.xPos+e.puck.radius){this.xVel*=.99,this.yVel*=.99;return}if(this.#e==="right"&&-1<Math.sign(e.puck.xVel)||this.#e==="left"&&Math.sign(e.puck.xVel)<1){let r=e.puck.yPos-this.yPos;Math.abs(r)<=.8*(this.radius+e.puck.radius)?this.yVel*=.99:this.yVel=.2*r}this.xPos=this.#e==="right"?.9*i.width:.1*i.width,this.yPos+=this.yVel;let s=10*60/f;this.xVel=(this.team==="right"?-1:1)*Math.max(s,Math.abs(this.xVel))}mediumAiUpdate(){if(e.puck.xPos===i.width/2&&e.puck.yPos===i.height/2)return;let t=this.#e==="right"&&e.puck.xPos+e.puck.radius<i.width/2||this.#e==="left"&&i.width/2<e.puck.xPos+e.puck.radius,n=this.#e==="right"&&this.xPos<e.puck.xPos||this.#e==="left"&&e.puck.xPos<this.xPos,s=this.#e==="right"&&Math.sign(e.puck.xVel)===-1||this.#e==="left"&&Math.sign(e.puck.xVel)===1,r=10*f/60;if(t||n){let a=t?.05:.1;if(this.#e==="right"){let c=i.width*(1-M)-this.radius-this.xPos;this.xVel=a*c}else if(this.#e==="left"){let c=i.width*M+this.radius-this.xPos;this.xVel=a*c}this.yVel=a*(i.height/2-this.yPos)}else if(s&&r<Math.abs(e.puck.xVel))this.xVel*=.99,this.yVel*=.99;else{let a=e.puck.xPos-this.xPos,c=e.puck.yPos-this.yPos,p=.0075,d,m=Math.random();m<.5?d=.35:.5<=m&&m<=.8?d=.2:d=.1,this.xVel+=p*a,this.yVel=d*c}this.xPos+=this.xVel,this.yPos+=this.yVel}hardAiUpdate(){if(e.isGoal)return;let t=this.team==="right"?.9*i.width:.1*i.width,n=i.height/2-e.puck.yPos,s=(i.height*(1-2*A)-2*this.radius)/2,r=e.puck.yPos+e.puck.radius*n/s;this.updatePosByAcceleratingTo(t,r),this.xVel=(this.team==="right"?-1:1)*Math.max(10*60/f,Math.abs(this.xVel)),this.yVel=(e.puck.yPos<this.yPos?-1:1)*Math.max(10*60/f,Math.abs(this.yVel))}update(){if(this.type==="ai")switch(this.intelligence){case"easy":this.easyAiUpdate();break;case"medium":this.mediumAiUpdate();break;case"hard":this.hardAiUpdate()}else this.type==="main"&&(this.xVel*=this.#c,this.yVel*=this.#c,this.updatePosByAcceleratingTo(e.pointingDevice.x,e.pointingDevice.y));this.draw()}draw(){let t=e.context;t.beginPath(),t.arc(this.#n,this.#a,this.#t,0,2*Math.PI,!1),t.fillStyle="hsla(0, 0%, 100%, 1)",t.fill(),t.closePath(),t.beginPath(),t.arc(this.#n,this.#a,.8*this.#t,0,2*Math.PI,!1),t.fillStyle=st[this.#s].color,t.fill(),t.closePath()}};var X=new(window.AudioContext||window.webkitAudioContext),E=X.createGain(),ne=X.createGain(),se=X.createGain(),it={bgm:"audio/bgm.mp3",buttonPress:"audio/button-press.mp3",boardHit:"audio/board-hit.mp3",playerHit:"audio/player-hit.mp3",goal:"audio/goal.mp3"};ne.gain.value=fe;se.gain.value=pe;E.gain.value=oe;ne.connect(E);se.connect(E);E.connect(X.destination);var rt=new Map;function Vt(o,t){fetch(t).then(n=>n.arrayBuffer()).then(n=>X.decodeAudioData(n)).then(n=>{rt.set(o,n)}).catch(n=>console.error(`Error loading sound ${o}. Reason: `,n))}function at(){for(let o of Object.keys(it))Vt(o,it[o])}function T(o,t){let n=X.createBufferSource();return n.buffer=rt.get(o),n.buffer===null?!1:(o==="bgm"?n.connect(ne):n.connect(se),n.loop=t,n.start(0),!0)}function ct(){h(C),y.querySelector(".error-msg").textContent="",u(y),document.getElementById("user-name").focus()}function lt(){h(C),u(le)}function be(){T("bgm",!0)&&document.removeEventListener("click",be)}function ut(){for(let t of me){let n=t.querySelector("img");n.src.includes("unmuted")?(n.src=n.src.replace("unmuted.svg","muted.svg"),_.disabled=!0,_.style.cursor="not-allowed"):(n.src=n.src.replace("muted.svg","unmuted.svg"),_.disabled=!1,_.style.cursor="grab")}let o=E.gain.value;E.gain.value=E.gain.value===0?e.prevMasterGainValue:0,e.prevMasterGainValue=o}function Re(){for(let o of he){let t=o.querySelector("img");document.fullscreenElement?document.exitFullscreen&&(t.src=t.src.replace("windowed.svg","fullscreen.svg")):t.src=t.src.replace("fullscreen.svg","windowed.svg")}document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}function dt(){h(C),u(Ke)}function mt(o){e.webSocketConn!==null&&(e.webSocketConn.close(),$());let t=o.closest(".menu");h(t),u(C)}function ht(o){let t=o.dataset.values.split(","),n=o.textContent.trim().toLowerCase();for(let s=0;s<t.length;s++)if(t[s]===n){o.textContent=w(t[(s+1)%t.length]);break}}function ft(o){let t=o.dataset.values.split(","),n=o.dataset.value;for(let s=0;s<t.length;s++)if(t[s]===n){o.dataset.value=t[(s+1)%t.length];break}}function Ne(o){o===void 0&&window.innerWidth<window.innerHeight||o!==void 0&&o.target.type.includes("portrait")?(u(q),q.showModal(),q.blur()):(o===void 0&&window.innerHeight<window.innerWidth||o!==void 0&&o.target.type.includes("landscape"))&&(h(q),J(q))}function pt(){e.offlineTeam=document.getElementById("offline-team-selector").textContent.toLowerCase()}function gt(){e.difficulty=document.getElementById("difficulty-selector").textContent.toLowerCase()}function yt(){e.playersPerTeam=document.getElementById("players-per-team-selector").textContent.toLowerCase()}function xt(){e.theme=document.getElementById("theme-selector").textContent.toLowerCase()}function ye(o){o.id==="master-volume-slider"?E.gain.value=g(0,o.value/100,1):o.id==="music-volume-slider"?ne.gain.value=g(0,o.value/100,1):o.id==="sfx-volume-slider"&&(se.gain.value=g(0,o.value/100,1))}function kt(o){let t=o.querySelector("img");t.src=nt[parseInt(o.dataset.value)]}async function Pt(){y.querySelector(".error-msg").textContent="",b(),await Le(),R(),e.webSocketConn!==null&&(h(y),u(V),document.getElementById("create-room-name").focus())}async function St(){y.querySelector(".error-msg").textContent="",b(),await Le(),R(),e.webSocketConn!==null&&(h(y),S.querySelector(".error-msg").textContent="",u(S),b(),await xe(),R())}async function wt(){let o=V.querySelector(".error-msg");o.textContent="";let n=document.getElementById("create-room-name").value.trim(),r=document.getElementById("create-room-team-selector").textContent.toLowerCase(),a=document.getElementById("create-room-striker-selector"),c=parseInt(a.dataset.value);b(),await At(n,r,c),R()}async function Ct(){let o=S.querySelector(".error-msg");o.textContent="";let t=document.querySelector(".join-room-list > .join-room-item.selected");if(t===null){o.textContent="Please select a room";return}let n=t.textContent.trim(),r=document.getElementById("join-room-team-selector").textContent.toLowerCase(),a=document.getElementById("join-room-striker-selector"),c=parseInt(a.dataset.value);b(),await Et(n,r,c),R()}function ie(o){o.key!=="p"&&o.key!=="P"||(e.isPaused?Oe({target:x}):(T("buttonPress",!1),e.isPaused=!0,u(x),x.showModal(),document.activeElement.blur()))}function re(){T("buttonPress",!1),e.isPaused=!0,u(x),x.showModal(),document.activeElement.blur()}function Oe(o){J(o.target),h(x),e.isPaused=!1,Ve()}function Mt(){e.isOnlineGame?e.webSocketConn.close():Y()}function Tt(o){let t=o.offsetX!==void 0?o.offsetX:o.layerX,n=o.offsetY!==void 0?o.offsetY:o.layerY;e.pointingDevice.x=t,e.pointingDevice.y=n}function vt(o){let t=o.targetTouches[0].clientX-o.target.getBoundingClientRect().left,n=o.targetTouches[0].clientY-o.target.getBoundingClientRect().top;e.pointingDevice.x=t,e.pointingDevice.y=n}function It(){requestAnimationFrame(ke)}function _t(o){let t=document.querySelector(".join-room-list > .join-room-item.selected"),n=document.getElementById("join-room-team-selector"),s=document.getElementById("join-room-striker-selector");t!==null&&t.classList.remove("selected"),o.classList.add("selected"),n.dataset.values=o.dataset.teams,Me(n),s.dataset.values=o.dataset.strikers,Te(s)}function Le(){return new Promise(o=>{if(e.webSocketConn!==null){o();return}let t=document.getElementById("user-name"),n=y.querySelector(".error-msg");if(n.textContent="",t.value===""){n.textContent="User name cannot be empty",$(),o();return}else if(F<t.value.length){n.textContent=`User name cannot be more than ${F} characters`,$(),o();return}e.webSocketConn=new WebSocket(`ws://${Q}/user`),e.webSocketConn.onopen=()=>{l&&console.log("Web socket connection established"),e.webSocketConn.send(JSON.stringify({channel:"handshake",userName:t.value.trim()})),l&&console.log("Sent web socket message on 'handshake' channel")},e.webSocketConn.onmessage=s=>{l&&console.log("Received web socket message during handshake");let r=JSON.parse(s.data);if(r.channel!=="handshake"){l&&console.error("Received web socket message from invalid channel during handshake"),e.webSocketConn.close(L.wrongChannel.code,L.wrongChannel.reason);return}if(l&&console.log("Received web socket message on 'handshake' channel"),r.isSuccess){e.userName=t.value.trim(),e.webSocketConn.onmessage=null,o();return}else{n.textContent=w(r.message),e.webSocketConn.close(L.rejectedUsername.code,L.rejectedUsername.reason);return}},e.webSocketConn!==null&&(e.webSocketConn.onerror=()=>{l&&console.error("Error during web socket communication"),n.textContent="Error while communicating with server",e.webSocketConn.close(1002)}),e.webSocketConn!==null&&(e.webSocketConn.onclose=()=>{e.userName===null?(l&&console.log("Web socket connection closed"),n.textContent===""&&(n.textContent="Can't connect to server"),$(),o()):l&&console.log("Web socket connection closed due to user clicking home button")})})}function bt(o,t){e.isOnlineGame=!0,e.isPaused=!1,Dt(),W(),u(i),u(Z),u(ee),document.addEventListener("keypress",n=>ie(n)),document.addEventListener("dblclick",re),e.mainPlayer.name=e.userName,e.mainPlayer.team=o,e.mainPlayer.strikerIdx=t,e.webSocketConn.onmessage=n=>{e.connTimeoutMetrics.prevMsgTimestamp=window.performance.now();let s=JSON.parse(n.data);switch(s.channel){case"memberLeft":{l&&console.log("Received web socket message on 'memberLeft' channel");let r=null;for(let a of e.nonMainPlayers)if(a.name===s.userName){r=a;break}r!==null&&(r.removeFromBoard(),U(`Player ${r.name} left the room`))}break;case"reassignHost":e.isHost=!0,U("You are now the host");break;case"state":{l&&console.log(`Received web socket message on 'state' channel. Remote state originated from remote user ${s.userName}`);let r=!1;for(let a of e.nonMainPlayers)if(a.name===s.userName){r=!0,a.xPos=I(s.playerXPos)*i.width,a.yPos=I(s.playerYPos)*i.height,a.xVel=I(s.playerXVel)*i.width,a.yVel=I(s.playerYVel)*i.height,s.isHost&&(e.puck.xPos=I(s.puckXPos)*i.width,e.puck.yPos=I(s.puckYPos)*i.height,e.puck.xVel=I(s.puckXVel)*i.width,e.puck.yVel=I(s.puckYVel)*i.height,Ce(j,s.leftScore),Ce(K,s.rightScore));break}if(!r&&s.userName!==e.userName){if(e.allPlayers.length===O){console.error(`Server is trying to add a new player when room is full; current room count is ${O}`);return}new k(s.userName,s.striker,s.team,"remote").addToBoard(),U(`Player ${s.userName} joined`)}}break;default:l&&console.error(`Received web socket message from invalid channel named '${s.channel}'`)}},e.webSocketConn.onerror=n=>{l&&console.error("Error during web socket communication. Reason: ",n),e.webSocketConn.close(1002)},e.webSocketConn.onclose=()=>{l&&console.log("Web socket connection closed"),Y()},Pe()}async function At(o,t,n){let s=V.querySelector(".error-msg"),r=l?"http":"https",a=null;if(o===""){s.textContent="Room name cannot be empty";return}else if(Ie<o.length){s.textContent=`Room name cannot be more than ${Ie} characters`;return}try{a=await fetch(`${r}://${Q}/room`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomName:o,userName:e.userName,team:t,striker:n})})}catch(c){console.error("Error occurred while creating room. Reason: ",c),s.textContent="Can't connect to server";return}if(a!==null&&a.ok)e.isHost=!0,bt(t,n);else if(a!==null){let c=await a.text();s.textContent=w(c)}else s.textContent="Something went wrong"}async function xe(){let o=S.querySelector(".error-msg"),t=l?"http":"https",n=null;try{n=await fetch(`${t}://${Q}/rooms`)}catch(s){console.error("Failed to fetch joinable rooms list. Reason: ",s),o.textContent="Failed to fetch rooms";return}if(n!==null&&n.ok){let s=await n.json(),r=S.querySelector(".join-room-list");if(o.textContent="",r.innerHTML="",s.length===0)r.innerHTML='<div class="no-rooms-msg">Please create a room to play</div>',r.style.justifyContent="center",o.textContent="No rooms available";else{r.style.justifyContent="start";for(let a=0;a<s.length;a++){let c=s[a],p=document.createElement("button");p.classList.add("menu-btn","join-room-item"),p.textContent=c.roomName,p.dataset.idx=a.toString(),p.dataset.name=c.roomName;let d=[];c.canJoinLeftTeam&&d.push("left"),c.canJoinRightTeam&&d.push("right"),p.dataset.teams=d.join(","),p.dataset.strikers=c.availableStrikers.join(","),p.onclick=()=>_t(p),r.appendChild(p)}}}else o.textContent="Something went wrong";Ge(document.getElementById("join-room-team-selector")),Fe(document.getElementById("join-room-striker-selector"))}async function Et(o,t,n){let s=S.querySelector(".error-msg");s.textContent="";let r=l?"http":"https",a=null;try{a=await fetch(`${r}://${Q}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomName:o,userName:e.userName,team:t,striker:n})})}catch(c){console.error("Error occurred while joining room. Reason: ",c),s.textContent="Can't connect to server";return}a!==null&&a.ok?(e.isHost=!1,bt(t,n)):a!==null?s.textContent=await a.text():s.textContent="Something went wrong"}function Rt(){if(e.webSocketConn===null){l&&console.error("Cannot send remote state to server as web socket connection does not exist"),Y();return}else if(e.webSocketConn.readyState!==WebSocket.OPEN){l&&console.error("Cannot send remote state to server as web socket connection is not in the open state"),Y();return}e.remoteState.userName=e.userName,e.remoteState.isHost=e.isHost,e.remoteState.team=e.mainPlayer.team,e.remoteState.striker=e.mainPlayer.strikerIdx,e.remoteState.playerXPos=v(e.mainPlayer.xPos/i.width),e.remoteState.playerYPos=v(e.mainPlayer.yPos/i.height),e.remoteState.playerXVel=v(e.mainPlayer.xVel/i.width),e.remoteState.playerYVel=v(e.mainPlayer.yVel/i.height),e.isHost?(e.remoteState.puckXPos=v(e.puck.xPos/i.width),e.remoteState.puckYPos=v(e.puck.yPos/i.height),e.remoteState.puckXVel=v(e.puck.xVel/i.width),e.remoteState.puckYVel=v(e.puck.yVel/i.height),e.remoteState.leftScore=Se(j),e.remoteState.rightScore=Se(K)):(e.remoteState.puckXPos=void 0,e.remoteState.puckYPos=void 0,e.remoteState.puckXVel=void 0,e.remoteState.puckYVel=void 0,e.remoteState.leftScore=void 0,e.remoteState.rightScore=void 0),e.webSocketConn.send(JSON.stringify(e.remoteState))}function Dt(){e.connTimeoutMetrics.prevMsgTimestamp=window.performance.now(),e.connTimeoutMetrics.intervalId=setInterval($t,_e/2)}function $t(){if(!e.isOnlineGame||e.webSocketConn===null)return;let o=window.performance.now()-e.connTimeoutMetrics.prevMsgTimestamp;_e<o&&e.webSocketConn.close(L.serverInactivity.code,L.serverInactivity.reason)}function Bt(){clearInterval(e.connTimeoutMetrics.intervalId),e.connTimeoutMetrics.intervalId=-1,e.connTimeoutMetrics.prevMsgTimestamp=1/0}function $(){Bt(),e.webSocketConn=null,e.userName=null,e.mainPlayer.name="You",e.mainPlayer.team="left",e.mainPlayer.strikerIdx=0,e.isOnlineGame=!1,e.isHost=!1}function Ve(){De(),e.fpsMetrics.prevFrameTimestamp=window.performance.now(),requestAnimationFrame(Nt)}function Nt(){let o=!e.isGameOver&&(e.isOnlineGame||!e.isPaused);if(!o)return;let t=window.performance.now(),n=t-e.fpsMetrics.prevFrameTimestamp;if(Ee<=n){if(e.fpsMetrics.prevFrameTimestamp=t-n%Ee,e.context.clearRect(0,0,i.width,i.height),e.nonMainPlayers.length===0)$e("Waiting for other players to join");else{e.puck.update();for(let s of e.allPlayers)s.update()}e.isOnlineGame&&Rt(),l&&e.fpsMetrics.canvasFpsCounter++}e.isGoal||Kt(),Ut(),o=!e.isGameOver&&(e.isOnlineGame||!e.isPaused),o&&requestAnimationFrame(Nt)}function Ot(){e.isOnlineGame=!1,e.isPaused=!1,W(),u(i),u(Z),u(ee),document.addEventListener("keypress",n=>ie(n)),document.addEventListener("dblclick",re),e.mainPlayer.team=e.offlineTeam.toLowerCase(),e.mainPlayer.reset();let o=e.offlineTeam.toLowerCase(),t=o==="left"?"right":"left";if(e.playersPerTeam==="one"){let n=new k("Tom",1,t,"ai");n.reset(),n.addToBoard(),n.intelligence=e.difficulty}else if(e.playersPerTeam==="two"){let n=new k("Tom",1,o,"ai");n.reset(),n.addToBoard();let s=new k("Laura",2,t,"ai");s.reset(),s.addToBoard();let r=new k("Sophie",3,t,"ai");r.reset(),r.addToBoard(),e.difficulty==="easy"?(n.intelligence="medium",s.intelligence="easy",r.intelligence="medium"):e.difficulty==="medium"?(n.intelligence="easy",s.intelligence="easy",r.intelligence="medium"):e.difficulty==="hard"&&(n.intelligence="easy",s.intelligence="medium",r.intelligence="hard")}Pe()}function Pe(){e.isGameOver=!0,e.puck.reset();for(let o of e.allPlayers)o.reset();e.isGameOver=!1,e.isGoal=!1,Ve()}function Ut(){Ft(),!e.isGoal&&(Gt(),qt())}function Gt(){let o=M*i.width+e.puck.radius,t=i.width*(1-M)-e.puck.radius,n=A*i.height+e.puck.radius,s=i.height*(1-A)-e.puck.radius,r=Xe*i.height+2*e.puck.radius,a=Ye*i.height-2*e.puck.radius;if((e.puck.xPos<o||t<e.puck.xPos)&&r<e.puck.yPos&&e.puck.yPos<a||isNaN(e.puck.xPos)){jt();return}let c=!1;(e.puck.xPos<=o||t<=e.puck.xPos)&&(e.puck.xVel*=-1,c=!0),(e.puck.yPos<=n||s<=e.puck.yPos)&&(e.puck.yVel*=-1,c=!0),c&&T("boardHit",!1),e.puck.xPos<o&&(e.puck.xPos=o+1),t<e.puck.xPos&&(e.puck.xPos=t-1),e.puck.yPos<n&&(e.puck.yPos=n+1),s<e.puck.yPos&&(e.puck.yPos=s-1)}function Ft(){for(let o of e.allPlayers){if(o.type!=="ai")continue;let t=i.width/2+o.radius,n=i.width*(1-M)-o.radius;o.team==="left"&&(t=i.width*M+o.radius,n=i.width/2-o.radius);let s=A*i.height+o.radius,r=i.height*(1-A)-o.radius;(o.xPos<=t||n<=o.xPos)&&(o.xVel=0,o.xPos=o.xPos<=t?t+1:n-1),(o.yPos<=s||r<=o.yPos)&&(o.yVel=0,o.yPos=o.yPos<=s?s+1:r-1)}}function qt(){let o=!1;for(let t of e.allPlayers){let n=e.puck.xPos-t.xPos,s=e.puck.yPos-t.yPos,r=Math.sqrt(n*n+s*s),a=e.puck.radius+t.radius,c=r<=a,d=window.performance.now()-t.prevCollisionTimestamp<et;if(!c||d)continue;o=!0,t.prevCollisionTimestamp=window.performance.now();let m=n/r,P=s/r;e.puck.xVel=2*(t.xVel*m+t.yVel*P)*m-(e.puck.xVel*m+e.puck.yVel*P)*m,e.puck.yVel=2*(t.xVel*m+t.yVel*P)*P-(e.puck.xVel*m+e.puck.yVel*P)*P,e.puck.xPos=t.xPos+n*a/r,e.puck.yPos=t.yPos+s*a/r}o&&T("playerHit",!1)}function jt(){let o=7*f/60;e.puck.xVel=Math.sign(e.puck.xVel)*Math.max(o,e.puck.xVel),e.puck.yVel=0,e.isGoal=!0,T("goal",!1),e.puck.xPos<i.width/2?we(K):we(j),setTimeout(Pe,2e3)}function Kt(){let o=e.stuckPuckMetrics.prevCheckTimestamp-e.stuckPuckMetrics.startTimestamp,t=e.stuckPuckMetrics.secondsCounter<=Math.floor(o/1e3),n=e.puck.xPos<i.width/2;e.puck.xPos===i.width/2||e.stuckPuckMetrics.wasPuckOnLeftSide!==n?e.stuckPuckMetrics.stuckDuration=0:t&&e.stuckPuckMetrics.stuckDuration++,t&&e.stuckPuckMetrics.secondsCounter++,e.stuckPuckMetrics.prevCheckTimestamp=window.performance.now(),e.stuckPuckMetrics.wasPuckOnLeftSide=n}function De(){e.stuckPuckMetrics.startTimestamp=window.performance.now(),e.stuckPuckMetrics.prevCheckTimestamp=window.performance.now(),e.stuckPuckMetrics.secondsCounter=0,e.stuckPuckMetrics.stuckDuration=0,e.stuckPuckMetrics.wasPuckOnLeftSide=!1}function ke(){let o=window.visualViewport.width/window.visualViewport.height,t=window.visualViewport.height/window.visualViewport.width,n=16/9;if(Math.abs(o-n)<=.1||Math.abs(t-n)<.1)i.width=window.visualViewport.width,i.height=window.visualViewport.height;else if(Math.abs(o-n)>.1){let s=window.visualViewport.height*16/9;i.width=s,i.height=window.visualViewport.height}else i.width=window.visualViewport.height,i.height=window.visualViewport.width;e.context=i.getContext("2d"),e.puck.adaptToScreen();for(let s of e.allPlayers)s.adaptToScreen();e.prevCanvasDim.width=i.width,e.prevCanvasDim.height=i.height}function Y(){e.isOnlineGame&&(U("Disconnected"),$()),J(x),e.isPaused=!1,e.isGameOver=!0,e.allPlayers=[e.mainPlayer],e.nonMainPlayers=[],e.mainPlayer.name="You",document.removeEventListener("keypress",ie),document.removeEventListener("dblclick",re),j.textContent="0",K.textContent="0",h(i),h(Z),h(ee),W(),u(C)}var ae=class{#o;#t;#s;#e;#i;#r;#n;constructor(t,n){this.reset(),this.#t=Je,this.xVel=t,this.yVel=n,this.#n=ze}get radius(){return this.#o}get xPos(){return this.#s}set xPos(t){isNaN(t)||(this.#s=g(-i.width-2*this.#o,t,i.width+2*this.#o))}get yPos(){return this.#e}set yPos(t){isNaN(t)||(this.#e=g(-i.height-2*this.#o,t,i.height+2*this.#o))}get xVel(){return this.#i}set xVel(t){if(isNaN(t))return;let n=Math.abs(t);n<te&&(t=Math.sign(t)*te),this.#i=Math.sign(t)*Math.min(n,f/3)}get yVel(){return this.#r}set yVel(t){if(isNaN(t))return;let n=Math.abs(t);n<te&&(t=Math.sign(t)*te),this.#r=Math.sign(t)*Math.min(n,f/3)}resetRadius(){this.#o=He*i.width}adaptToScreen(){this.xPos=i.width*this.xPos/e.prevCanvasDim.width,this.yPos=i.height*this.yPos/e.prevCanvasDim.height,this.resetRadius()}reset(){this.resetRadius(),this.xPos=i.width/2,this.yPos=i.height/2,this.xVel=0,this.yVel=0}draw(){let t=e.context;t.beginPath(),t.arc(this.#s,this.#e,this.#o,0,2*Math.PI,!1),t.fillStyle=this.#t,t.fill(),t.closePath()}update(){(!e.isOnlineGame||e.isOnlineGame&&e.isHost)&&(this.xVel*=this.#n,this.yVel*=this.#n,this.xPos+=this.xVel,this.yPos+=this.yVel,Ze<=e.stuckPuckMetrics.stuckDuration&&(this.reset(),De())),this.draw()}};Xt();function Xt(){at(),Ne(),Wt(),Ht(),e.mainPlayer=new k("You",0,e.offlineTeam,"main"),e.mainPlayer.reset(),e.mainPlayer.addToBoard(),e.puck=new ae(0,0),je?i.addEventListener("touchmove",o=>vt(o)):i.addEventListener("mousemove",o=>Tt(o)),window.addEventListener("resize",It),ke(),l&&Yt()}function Yt(){u(Ae),setInterval(()=>{Ae.textContent=e.fpsMetrics.canvasFpsCounter.toString(),e.fpsMetrics.canvasFpsCounter=0},1e3)}function Ht(){for(let o of document.querySelectorAll(".team-selector"))o.textContent=w(e.offlineTeam),o.dataset.values=G.join(",");for(let o of document.querySelectorAll(".difficulty-selector"))o.textContent=w(e.difficulty),o.dataset.values=ge.join(",");for(let o of document.querySelectorAll(".striker-selector"))o.dataset.value=e.strikerIdx,o.dataset.values=z.join(",");for(let o of document.querySelectorAll(".players-per-team-selector"))o.textContent=w(e.playersPerTeam),o.dataset.values=tt.join(",");_.value=oe*100,ue.value=fe*100,de.value=pe*100}function Wt(){window.screen.orientation.addEventListener("change",t=>Ne(t)),document.addEventListener("click",be),document.querySelectorAll("button").forEach(t=>t.addEventListener("click",()=>{T("buttonPress",!1)})),C.querySelector(".online-game-btn").onclick=ct,C.querySelector(".offline-game-btn").onclick=lt;for(let t of me)t.onclick=ut;window.addEventListener("keydown",t=>{t.key==="F11"&&(t.preventDefault(),Re())});for(let t of he)t.onclick=Re;let o=document.querySelector(".settings-btn");o.onclick=dt;for(let t of document.querySelectorAll(".menu .home-btn"))t.onclick=n=>mt(n.target);for(let t of document.querySelectorAll(".menu .selector"))t.addEventListener("click",n=>{ht(n.target),n.target.id==="offline-team-selector"?pt():n.target.id==="difficulty-selector"?gt():n.target.id==="players-per-team-selector"?yt():n.target.id==="theme-selector"&&xt(),n.target.textContent=w(n.target.textContent)});for(let t of document.querySelectorAll(".img-selector"))t.addEventListener("click",n=>{let s=n.target.closest(".img-selector");ft(s),(s.id==="create-room-striker-selector"||s.id==="join-room-striker-selector")&&kt(s)});_.oninput=()=>ye(_),ue.oninput=()=>ye(ue),de.oninput=()=>ye(de),le.querySelector(".start-offline-game-btn").onclick=Ot,y.querySelector(".host-menu-btn").onclick=Pt,y.querySelector(".join-menu-btn").onclick=St,V.querySelector(".create-room-btn").onclick=wt,S.querySelector(".join-room-btn").onclick=Ct,S.querySelector(".refresh-btn").onclick=async()=>{b(),await xe(),R()},x.querySelector(".resume-btn").onclick=Oe,x.querySelector(".exit-btn").onclick=Mt}})();
