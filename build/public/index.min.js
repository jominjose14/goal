(()=>{function De(o){let t=e.context,n=.03*s.height,r=.05*s.height,i=t.measureText(o).width,c=1.25*r,a=(s.width-i)/2,d=(s.height+c-n)/2,u=(s.width-i)/2-n,h=(s.height-c)/2-n,P=i+2*n,ce=c+2*n,H=.03*s.height;t.fillStyle="hsla(0, 0%, 20%, 0.95)",t.beginPath(),t.moveTo(u+H,h),t.arcTo(u+P,h,u+P,h+ce,H),t.arcTo(u+P,h+ce,u,h+ce,H),t.arcTo(u,h+ce,u,h,H),t.arcTo(u,h,u+P,h,H),t.closePath(),t.fill(),t.beginPath(),t.font=`${r}px "Protest Riot", "Trebuchet MS", sans-serif`,t.textAlign="start",t.textBaseline="alphabetic",t.fillStyle="hsla(0, 0%, 100%, 0.25)",t.fillText(o,a,d),t.closePath()}function g(o,t,n){return Math.max(o,Math.min(t,n))}function Be(){let o=navigator.userAgent;return/Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/.test(o)}function m(o){o.classList.remove("hidden")}function p(o){o.classList.add("hidden")}function W(){for(let o of document.querySelectorAll(".menu"))p(o)}function b(){m(B),B.showModal(),B.blur()}function R(){p(B),B.close()}function U(o){clearTimeout(e.toastTimeoutId),p(N),N.querySelector(".toast-msg").textContent=o,N.style.right-=N.width,m(N),e.toastTimeoutId=setTimeout(()=>p(N),qe)}function y(o){return o[0].toUpperCase()+o.substring(1)}function v(o){return o=Math.floor(o*ve),o}function I(o){return o/ve}function Pe(o){return isNaN(o.textContent)?0:g(0,parseInt(o.textContent),999)}function we(o){let t=o.textContent;isNaN(t)&&(t=-1),o.textContent=(parseInt(t)+1).toString(),Ue(o)}function Ce(o,t){let n=o.textContent;isNaN(n)&&(n=0),o.textContent=t.toString(),parseInt(n)!==t&&Ue(o)}function Ue(o){o.classList.remove("strobing-score"),o.offsetWidth,o.classList.add("strobing-score")}function Te(o){o.textContent=o.dataset.values.split(",").at(-1),o.click()}function Me(o){o.dataset.value=o.dataset.values.split(",").at(-1),o.click()}function Ge(o){o.dataset.values=G.join(","),Te(o)}function Fe(o){o.dataset.values=z.join(","),Me(o)}function J(o){o.closest("dialog").close()}var l=!0,je=Be(),Q=new URL(window.location.href).host,F=10,Ie=10,O=4;var _e=6e4,Vt=3,ve=Math.pow(10,Vt),L={serverInactivity:{code:3001,reason:"Server inactivity timeout"},wrongChannel:{code:3002,reason:"Wrong channel"},rejectedUsername:{code:3003,reason:"Username rejected by server"}},C=document.querySelector(".menu.home"),Xe=document.querySelector(".menu.settings"),le=document.querySelector(".menu.offline"),x=document.querySelector(".menu.online"),V=document.querySelector(".menu.host"),w=document.querySelector(".menu.join"),q=document.querySelector(".menu.rotate-screen"),_=document.getElementById("master-volume-slider"),ue=document.getElementById("music-volume-slider"),me=document.getElementById("sfx-volume-slider"),k=document.querySelector(".menu.pause"),Z=document.querySelector(".message"),ee=document.querySelector(".scores"),j=document.getElementById("left-score"),X=document.getElementById("right-score"),de=[document.querySelector(".menu.home .mute-toggle-btn"),document.querySelector(".menu.pause .mute-toggle-btn")],he=[document.querySelector(".menu.home .fullscreen-toggle-btn"),document.querySelector(".menu.pause .fullscreen-toggle-btn")],Ee=document.querySelector(".fps-display"),B=document.querySelector(".loading-spinner"),N=document.querySelector(".toast"),s=document.getElementById("board"),T=.008,E=.014,Ye=320/900,Ke=580/900,He=.015,We=.0225,Je="hsla(0, 0%, 100%, 1)",f=60,Ae=1e3/f,to=3*(f/60)*16,oo=3*(f/60)*9,te=1,ze=.999,Qe=.999;var $=1.5;var Ze=10,et=200,qe=3e3;var oe=1,pe=.9,fe=.8;var G=["left","right"],ge=["easy","medium","hard"],tt=["one","two"],ot=["human","ai","remote"],nt=["human","ai"],z=[];for(let o=0;o<O;o++)z.push(o);var st=["images/striker-0.svg","images/striker-1.svg","images/striker-2.svg","images/striker-3.svg"],rt=[{name:"G",color:"hsla(190, 100%, 50%, 1)"},{name:"O",color:"hsla(120, 100%, 50%, 1)"},{name:"A",color:"hsla(53, 100%, 50%, 1)"},{name:"L",color:"hsla(35, 100%, 50%, 1)"}],e={remoteState:{channel:"state",userName:"",isHost:!1,team:"",striker:0,playerXPos:0,playerYPos:0,playerXVel:0,playerYVel:0,puckXPos:0,puckYPos:0,puckXVel:0,puckYVel:0,leftScore:0,rightScore:0},connTimeoutMetrics:{prevMsgTimestamp:0,intervalId:-1},webSocketConn:null,userName:null,isOnlineGame:!1,isHost:!1,context:s.getContext("2d"),prevCanvasDim:{width:s.width,height:s.height},fpsMetrics:{canvasFpsCounter:0,prevFrameTimestamp:0},stuckPuckMetrics:{startTimestamp:0,prevCheckTimestamp:0,secondsCounter:0,stuckDuration:0,wasPuckOnLeftSide:!1},isGoal:!0,isPaused:!1,isGameOver:!0,mainPlayer:null,players:[],puck:null,pointingDevice:{x:0,y:0},pressedKeys:{ArrowUp:!1,ArrowRight:!1,ArrowDown:!1,ArrowLeft:!1},strikerIdx:"0",playerType:"human",offlineTeam:"left",difficulty:"medium",playersPerTeam:"two",prevMasterGainValue:oe,toastTimeoutId:-1};var S=class{#o;#t;#s;#e;#r;#i;#n;#a;#l=0;#u=0;#c;#m=null;prevCollisionTimestamp=0;constructor(t,n,r,i){this.#o=t,this.resetRadius(),this.#s=n,this.#e=r,this.#r=i,this.#i=e.difficulty,this.#c=Qe}get name(){return this.#o}set name(t){if(F<t.length){l&&console.error(`Cannot set player ${this.name}'s name to invalid value ${t}. Min length is 1 and max length is ${F}`);return}this.#o=t}get radius(){return this.#t}get strikerIdx(){return this.#s}set strikerIdx(t){if(t<0||O<=t){l&&console.error(`Cannot set player ${this.name}'s strikerId to invalid value ${t}. Min value is 0 and max value is ${O-1}`);return}this.#s=t}get team(){return this.#e}set team(t){if(t=t.toLowerCase(),!G.includes(t)){l&&console.error(`Cannot set player ${this.name}'s team to invalid value ${t}`);return}this.#e=t}get type(){return this.#r}set type(t){if(t=t.toLowerCase(),!ot.includes(t)){l&&console.error(`Cannot set player ${this.name}'s type to invalid value ${t}`);return}this.#r=t}get intelligence(){return this.#i}set intelligence(t){if(t=t.toLowerCase(),!ge.includes(t)){l&&console.error(`Cannot set player ${this.name}'s intelligence to invalid value ${t}`);return}this.#i=t}get xPos(){return this.#n}set xPos(t){if(!isNaN(t))if(this.#e==="left"){let n=T*s.width+this.#t,r=s.width/2-this.#t;this.#n=g(n,t,r)}else{let n=s.width/2+this.#t,r=s.width*(1-T)-this.#t;this.#n=g(n,t,r)}}get yPos(){return this.#a}set yPos(t){if(isNaN(t))return;let n=E*s.height+this.#t,r=s.height*(1-E)-this.#t;this.#a=g(n,t,r)}get xVel(){return this.#l}set xVel(t){if(isNaN(t))return;let n=Math.abs(t);this.#l=Math.sign(t)*Math.min(n,f/2)}get yVel(){return this.#u}set yVel(t){if(isNaN(t))return;let n=Math.abs(t);this.#u=Math.sign(t)*Math.min(n,f/2)}addToBoard(){e.players.push(this)}removeFromBoard(){let t=e.players.indexOf(this);t>-1&&e.players.splice(t,1)}resetRadius(){this.#t=We*s.width}adaptToScreen(){this.xPos=s.width*this.xPos/e.prevCanvasDim.width,this.yPos=s.height*this.yPos/e.prevCanvasDim.height,this.resetRadius()}reset(){this.resetRadius(),this.#e==="left"?this.xPos=.05*s.width:this.xPos=.95*s.width,this.yPos=s.height/2,this.xVel=0,this.yVel=0}updatePosByAcceleratingTo(t,n){let r=t-this.xPos,i=n-this.yPos,c=.35;this.xVel=c*r,this.yVel=c*i,this.xPos+=this.xVel,this.yPos+=this.yVel}updatePosUsingKeys(){for(let t of Object.keys(e.pressedKeys))if(e.pressedKeys[t])switch(t){case"ArrowUp":this.yVel=Math.min(0,this.yVel-$);break;case"ArrowRight":this.xVel=Math.max(0,this.xVel+$);break;case"ArrowDown":this.yVel=Math.max(0,this.yVel+$);break;case"ArrowLeft":this.xVel=Math.min(0,this.xVel-$);break;default:console.error("Invalid arrow key")}this.xPos+=this.xVel,this.yPos+=this.yVel}updateVelUsingJoyStick(t,n){let r=$*t,i=$*n;this.xVel+=r,this.yVel+=i}easyAiUpdate(){if(e.puck.xPos===s.width/2&&e.puck.yPos===s.height/2)return;if(this.#e==="right"&&e.puck.xPos+e.puck.radius<s.width/2||this.#e==="left"&&s.width/2<e.puck.xPos+e.puck.radius){this.xVel*=.99,this.yVel*=.99;return}if(this.#e==="right"&&-1<Math.sign(e.puck.xVel)||this.#e==="left"&&Math.sign(e.puck.xVel)<1){let i=e.puck.yPos-this.yPos;Math.abs(i)<=.8*(this.radius+e.puck.radius)?this.yVel*=.99:this.yVel=.2*i}this.xPos=this.#e==="right"?.9*s.width:.1*s.width,this.yPos+=this.yVel;let r=10*60/f;this.xVel=(this.team==="right"?-1:1)*Math.max(r,Math.abs(this.xVel))}mediumAiUpdate(){if(e.puck.xPos===s.width/2&&e.puck.yPos===s.height/2)return;let t=this.#e==="right"&&e.puck.xPos+e.puck.radius<s.width/2||this.#e==="left"&&s.width/2<e.puck.xPos+e.puck.radius,n=this.#e==="right"&&this.xPos<e.puck.xPos||this.#e==="left"&&e.puck.xPos<this.xPos,r=this.#e==="right"&&Math.sign(e.puck.xVel)===-1||this.#e==="left"&&Math.sign(e.puck.xVel)===1,i=10*f/60;if(t||n){let c=t?.05:.1;if(this.#e==="right"){let a=s.width*(1-T)-this.radius-this.xPos;this.xVel=c*a}else if(this.#e==="left"){let a=s.width*T+this.radius-this.xPos;this.xVel=c*a}this.yVel=c*(s.height/2-this.yPos)}else if(r&&i<Math.abs(e.puck.xVel))this.xVel*=.99,this.yVel*=.99;else{let c=e.puck.xPos-this.xPos,a=e.puck.yPos-this.yPos,d=.0075,u,h=Math.random();h<.5?u=.35:.5<=h&&h<=.8?u=.2:u=.1,this.xVel+=d*c,this.yVel=u*a}this.xPos+=this.xVel,this.yPos+=this.yVel}hardAiUpdate(){if(e.isGoal)return;let t=this.team==="right"?.9*s.width:.1*s.width,n=s.height/2-e.puck.yPos,r=(s.height*(1-2*E)-2*this.radius)/2,i=e.puck.yPos+e.puck.radius*n/r;this.updatePosByAcceleratingTo(t,i),this.xVel=(this.team==="right"?-1:1)*Math.max(10*60/f,Math.abs(this.xVel)),this.yVel=(e.puck.yPos<this.yPos?-1:1)*Math.max(10*60/f,Math.abs(this.yVel))}update(){if(this.type==="ai")switch(this.intelligence){case"easy":this.easyAiUpdate();break;case"medium":this.mediumAiUpdate();break;case"hard":this.hardAiUpdate()}else this.type==="human"&&(this.xVel*=this.#c,this.yVel*=this.#c,this.updatePosByAcceleratingTo(e.pointingDevice.x,e.pointingDevice.y));this.draw()}draw(){let t=e.context;t.beginPath(),t.arc(this.#n,this.#a,this.#t,0,2*Math.PI,!1),t.fillStyle="hsla(0, 0%, 100%, 1)",t.fill(),t.closePath(),t.beginPath(),t.arc(this.#n,this.#a,.8*this.#t,0,2*Math.PI,!1),t.fillStyle=rt[this.#s].color,t.fill(),t.closePath()}};var Y=new(window.AudioContext||window.webkitAudioContext),A=Y.createGain(),ne=Y.createGain(),se=Y.createGain(),it={bgm:"audio/bgm.mp3",buttonPress:"audio/button-press.mp3",boardHit:"audio/board-hit.mp3",playerHit:"audio/player-hit.mp3",goal:"audio/goal.mp3"};ne.gain.value=pe;se.gain.value=fe;A.gain.value=oe;ne.connect(A);se.connect(A);A.connect(Y.destination);var at=new Map;function $t(o,t){fetch(t).then(n=>n.arrayBuffer()).then(n=>Y.decodeAudioData(n)).then(n=>{at.set(o,n)}).catch(n=>console.error(`Error loading sound ${o}. Reason: `,n))}function ct(){for(let o of Object.keys(it))$t(o,it[o])}function M(o,t){let n=Y.createBufferSource();return n.buffer=at.get(o),n.buffer===null?!1:(o==="bgm"?n.connect(ne):n.connect(se),n.loop=t,n.start(0),!0)}function lt(){p(C),x.querySelector(".error-msg").textContent="",m(x),document.getElementById("user-name").focus()}function ut(){p(C),m(le)}function be(){M("bgm",!0)&&document.removeEventListener("click",be)}function mt(){for(let t of de){let n=t.querySelector("img");n.src.includes("unmuted")?(n.src=n.src.replace("unmuted.svg","muted.svg"),_.disabled=!0,_.style.cursor="not-allowed"):(n.src=n.src.replace("muted.svg","unmuted.svg"),_.disabled=!1,_.style.cursor="grab")}let o=A.gain.value;A.gain.value=A.gain.value===0?e.prevMasterGainValue:0,e.prevMasterGainValue=o}function Re(){for(let o of he){let t=o.querySelector("img");document.fullscreenElement?document.exitFullscreen&&(t.src=t.src.replace("windowed.svg","fullscreen.svg")):t.src=t.src.replace("fullscreen.svg","windowed.svg")}document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}function dt(){p(C),m(Xe)}function ht(o){e.webSocketConn!==null&&(e.webSocketConn.close(),D());let t=o.closest(".menu");p(t),m(C)}function pt(o){let t=o.dataset.values.split(","),n=o.textContent.trim().toLowerCase();for(let r=0;r<t.length;r++)if(t[r]===n){o.textContent=y(t[(r+1)%t.length]);break}}function ft(o){let t=o.dataset.values.split(","),n=o.dataset.value;for(let r=0;r<t.length;r++)if(t[r]===n){o.dataset.value=t[(r+1)%t.length];break}}function Ne(o){o===void 0&&window.innerWidth<window.innerHeight||o!==void 0&&o.target.type.includes("portrait")?(m(q),q.showModal(),q.blur()):(o===void 0&&window.innerHeight<window.innerWidth||o!==void 0&&o.target.type.includes("landscape"))&&(p(q),J(q))}function gt(){e.offlineTeam=document.getElementById("offline-team-selector").textContent.toLowerCase()}function yt(o){for(let t of document.querySelectorAll(".difficulty-selector"))t.textContent=y(o.textContent.toLowerCase());e.difficulty=o.textContent.toLowerCase()}function xt(){e.playersPerTeam=document.getElementById("players-per-team-selector").textContent.toLowerCase()}function kt(){e.theme=document.getElementById("theme-selector").textContent.toLowerCase()}function ye(o){o.id==="master-volume-slider"?A.gain.value=g(0,o.value/100,1):o.id==="music-volume-slider"?ne.gain.value=g(0,o.value/100,1):o.id==="sfx-volume-slider"&&(se.gain.value=g(0,o.value/100,1))}function St(o){let t=o.querySelector("img");t.src=st[parseInt(o.dataset.value)]}async function Pt(){x.querySelector(".error-msg").textContent="",b(),await Le(),R(),e.webSocketConn!==null&&(p(x),m(V),document.getElementById("create-room-name").focus())}async function wt(){x.querySelector(".error-msg").textContent="",b(),await Le(),R(),e.webSocketConn!==null&&(p(x),w.querySelector(".error-msg").textContent="",m(w),b(),await xe(),R())}async function Ct(){let o=V.querySelector(".error-msg");o.textContent="";let n=document.getElementById("create-room-name").value.trim(),i=document.getElementById("create-room-team-selector").textContent.toLowerCase(),c=document.getElementById("create-room-striker-selector"),a=parseInt(c.dataset.value),u=document.getElementById("create-room-player-type-selector").textContent.toLowerCase();b(),await At(n,i,a,u),R()}async function Tt(){let o=w.querySelector(".error-msg");o.textContent="";let t=document.querySelector(".join-room-list > .join-room-item.selected");if(t===null){o.textContent="Please select a room";return}let n=t.textContent.trim(),i=document.getElementById("join-room-team-selector").textContent.toLowerCase(),c=document.getElementById("join-room-striker-selector"),a=parseInt(c.dataset.value),u=document.getElementById("join-room-player-type-selector").textContent.toLowerCase();b(),await bt(n,i,a,u),R()}function re(o){o.key!=="p"&&o.key!=="P"||(e.isPaused?Oe({target:k}):(M("buttonPress",!1),e.isPaused=!0,m(k),k.showModal(),document.activeElement.blur()))}function ie(){M("buttonPress",!1),e.isPaused=!0,m(k),k.showModal(),document.activeElement.blur()}function Oe(o){J(o.target),p(k),e.isPaused=!1,Ve()}function Mt(){e.isOnlineGame?e.webSocketConn.close():K()}function vt(o){let t=o.offsetX!==void 0?o.offsetX:o.layerX,n=o.offsetY!==void 0?o.offsetY:o.layerY;e.pointingDevice.x=t,e.pointingDevice.y=n}function It(o){let t=o.targetTouches[0].clientX-o.target.getBoundingClientRect().left,n=o.targetTouches[0].clientY-o.target.getBoundingClientRect().top;e.pointingDevice.x=t,e.pointingDevice.y=n}function _t(){requestAnimationFrame(ke)}function Et(o){let t=document.querySelector(".join-room-list > .join-room-item.selected"),n=document.getElementById("join-room-team-selector"),r=document.getElementById("join-room-striker-selector");t!==null&&t.classList.remove("selected"),o.classList.add("selected"),n.dataset.values=o.dataset.teams,Te(n),r.dataset.values=o.dataset.strikers,Me(r)}function Le(){return new Promise(o=>{if(e.webSocketConn!==null){o();return}let t=document.getElementById("user-name"),n=x.querySelector(".error-msg");if(n.textContent="",t.value===""){n.textContent="User name cannot be empty",D(),o();return}else if(F<t.value.length){n.textContent=`User name cannot be more than ${F} characters`,D(),o();return}e.webSocketConn=new WebSocket(`ws://${Q}/user`),e.webSocketConn.onopen=()=>{l&&console.log("Web socket connection established"),e.webSocketConn.send(JSON.stringify({channel:"handshake",userName:t.value.trim()})),l&&console.log("Sent web socket message on 'handshake' channel")},e.webSocketConn.onmessage=r=>{l&&console.log("Received web socket message during handshake");let i=JSON.parse(r.data);if(i.channel!=="handshake"){l&&console.error("Received web socket message from invalid channel during handshake"),e.webSocketConn.close(L.wrongChannel.code,L.wrongChannel.reason);return}if(l&&console.log("Received web socket message on 'handshake' channel"),i.isSuccess){e.userName=t.value.trim(),e.webSocketConn.onmessage=null,o();return}else{n.textContent=y(i.message),e.webSocketConn.close(L.rejectedUsername.code,L.rejectedUsername.reason);return}},e.webSocketConn!==null&&(e.webSocketConn.onerror=()=>{l&&console.error("Error during web socket communication"),n.textContent="Error while communicating with server",e.webSocketConn.close(1002)}),e.webSocketConn!==null&&(e.webSocketConn.onclose=()=>{e.userName===null?(l&&console.log("Web socket connection closed"),n.textContent===""&&(n.textContent="Can't connect to server"),D(),o()):l&&console.log("Web socket connection closed due to user clicking home button")})})}function Rt(o,t,n){e.isOnlineGame=!0,e.isPaused=!1,Dt(),W(),m(s),m(Z),m(ee),document.addEventListener("keypress",r=>re(r)),document.addEventListener("dblclick",ie),e.mainPlayer.name=e.userName,e.mainPlayer.team=o,e.mainPlayer.strikerIdx=t,e.mainPlayer.type=n,e.webSocketConn.onmessage=r=>{e.connTimeoutMetrics.prevMsgTimestamp=window.performance.now();let i=JSON.parse(r.data);switch(i.channel){case"memberLeft":{l&&console.log("Received web socket message on 'memberLeft' channel");let c=null;for(let a of e.players)if(!(a.name!==i.userName||a===e.mainPlayer)){c=a;break}c!==null&&(c.removeFromBoard(),U(`Player ${c.name} left the room`))}break;case"reassignHost":e.isHost=!0,U("You are now the host");break;case"state":{l&&console.log(`Received web socket message on 'state' channel. Remote state originated from remote user ${i.userName}`);let c=!1;for(let a of e.players)if(!(a.name!==i.userName||a===e.mainPlayer)){c=!0,a.xPos=I(i.playerXPos)*s.width,a.yPos=I(i.playerYPos)*s.height,a.xVel=I(i.playerXVel)*s.width,a.yVel=I(i.playerYVel)*s.height,i.isHost&&(e.puck.xPos=I(i.puckXPos)*s.width,e.puck.yPos=I(i.puckYPos)*s.height,e.puck.xVel=I(i.puckXVel)*s.width,e.puck.yVel=I(i.puckYVel)*s.height,Ce(j,i.leftScore),Ce(X,i.rightScore));break}if(!c&&i.userName!==e.userName){if(e.players.length===O){console.error(`Server is trying to add a new player when room is full; current room count is ${O}`);return}new S(i.userName,i.striker,i.team,"remote").addToBoard(),U(`Player ${i.userName} joined`)}}break;default:l&&console.error(`Received web socket message from invalid channel named '${i.channel}'`)}},e.webSocketConn.onerror=r=>{l&&console.error("Error during web socket communication. Reason: ",r),e.webSocketConn.close(1002)},e.webSocketConn.onclose=()=>{l&&console.log("Web socket connection closed"),K()},Se()}async function At(o,t,n,r){let i=V.querySelector(".error-msg"),c=l?"http":"https",a=null;if(o===""){i.textContent="Room name cannot be empty";return}else if(Ie<o.length){i.textContent=`Room name cannot be more than ${Ie} characters`;return}try{a=await fetch(`${c}://${Q}/room`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomName:o,userName:e.userName,team:t,striker:n})})}catch(d){console.error("Error occurred while creating room. Reason: ",d),i.textContent="Can't connect to server";return}if(a!==null&&a.ok)e.isHost=!0,Rt(t,n,r);else if(a!==null){let d=await a.text();i.textContent=y(d)}else i.textContent="Something went wrong"}async function xe(){let o=w.querySelector(".error-msg"),t=l?"http":"https",n=null;try{n=await fetch(`${t}://${Q}/rooms`)}catch(r){console.error("Failed to fetch joinable rooms list. Reason: ",r),o.textContent="Failed to fetch rooms";return}if(n!==null&&n.ok){let r=await n.json(),i=w.querySelector(".join-room-list");if(o.textContent="",i.innerHTML="",r.length===0)i.innerHTML='<div class="no-rooms-msg">Please create a room to play</div>',i.style.justifyContent="center",o.textContent="No rooms available";else{i.style.justifyContent="start";for(let c=0;c<r.length;c++){let a=r[c],d=document.createElement("button");d.classList.add("menu-btn","join-room-item"),d.textContent=a.roomName,d.dataset.idx=c.toString(),d.dataset.name=a.roomName;let u=[];a.canJoinLeftTeam&&u.push("left"),a.canJoinRightTeam&&u.push("right"),d.dataset.teams=u.join(","),d.dataset.strikers=a.availableStrikers.join(","),d.onclick=()=>Et(d),i.appendChild(d)}}}else o.textContent="Something went wrong";Ge(document.getElementById("join-room-team-selector")),Fe(document.getElementById("join-room-striker-selector"))}async function bt(o,t,n,r){let i=w.querySelector(".error-msg");i.textContent="";let c=l?"http":"https",a=null;try{a=await fetch(`${c}://${Q}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomName:o,userName:e.userName,team:t,striker:n})})}catch(d){console.error("Error occurred while joining room. Reason: ",d),i.textContent="Can't connect to server";return}a!==null&&a.ok?(e.isHost=!1,Rt(t,n,r)):a!==null?i.textContent=await a.text():i.textContent="Something went wrong"}function Nt(){if(e.webSocketConn===null){l&&console.error("Cannot send remote state to server as web socket connection does not exist"),K();return}else if(e.webSocketConn.readyState!==WebSocket.OPEN){l&&console.error("Cannot send remote state to server as web socket connection is not in the open state"),K();return}e.remoteState.userName=e.userName,e.remoteState.isHost=e.isHost,e.remoteState.team=e.mainPlayer.team,e.remoteState.striker=e.mainPlayer.strikerIdx,e.remoteState.playerXPos=v(e.mainPlayer.xPos/s.width),e.remoteState.playerYPos=v(e.mainPlayer.yPos/s.height),e.remoteState.playerXVel=v(e.mainPlayer.xVel/s.width),e.remoteState.playerYVel=v(e.mainPlayer.yVel/s.height),e.isHost?(e.remoteState.puckXPos=v(e.puck.xPos/s.width),e.remoteState.puckYPos=v(e.puck.yPos/s.height),e.remoteState.puckXVel=v(e.puck.xVel/s.width),e.remoteState.puckYVel=v(e.puck.yVel/s.height),e.remoteState.leftScore=Pe(j),e.remoteState.rightScore=Pe(X)):(e.remoteState.puckXPos=void 0,e.remoteState.puckYPos=void 0,e.remoteState.puckXVel=void 0,e.remoteState.puckYVel=void 0,e.remoteState.leftScore=void 0,e.remoteState.rightScore=void 0),e.webSocketConn.send(JSON.stringify(e.remoteState))}function Dt(){e.connTimeoutMetrics.prevMsgTimestamp=window.performance.now(),e.connTimeoutMetrics.intervalId=setInterval(Bt,_e/2)}function Bt(){if(!e.isOnlineGame||e.webSocketConn===null)return;let o=window.performance.now()-e.connTimeoutMetrics.prevMsgTimestamp;_e<o&&e.webSocketConn.close(L.serverInactivity.code,L.serverInactivity.reason)}function Ut(){clearInterval(e.connTimeoutMetrics.intervalId),e.connTimeoutMetrics.intervalId=-1,e.connTimeoutMetrics.prevMsgTimestamp=1/0}function D(){Ut(),e.webSocketConn=null,e.userName=null,e.mainPlayer.name="You",e.mainPlayer.team="left",e.mainPlayer.strikerIdx=0,e.isOnlineGame=!1,e.isHost=!1}function Ve(){$e(),e.fpsMetrics.prevFrameTimestamp=window.performance.now(),requestAnimationFrame(Ot)}function Ot(){let o=!e.isGameOver&&(e.isOnlineGame||!e.isPaused);if(!o)return;let t=window.performance.now(),n=t-e.fpsMetrics.prevFrameTimestamp;if(Ae<=n){if(e.fpsMetrics.prevFrameTimestamp=t-n%Ae,e.context.clearRect(0,0,s.width,s.height),e.players.length===1)De("Waiting for other players to join");else{e.puck.update();for(let r of e.players)r.update()}e.isOnlineGame&&Nt(),l&&e.fpsMetrics.canvasFpsCounter++}e.isGoal||Yt(),Gt(),o=!e.isGameOver&&(e.isOnlineGame||!e.isPaused),o&&requestAnimationFrame(Ot)}function Lt(){e.isOnlineGame=!1,e.isPaused=!1,W(),m(s),m(Z),m(ee),document.addEventListener("keypress",n=>re(n)),document.addEventListener("dblclick",ie),e.mainPlayer.team=e.offlineTeam.toLowerCase(),e.mainPlayer.reset();let o=e.offlineTeam.toLowerCase(),t=o==="left"?"right":"left";if(e.playersPerTeam==="one"){let n=new S("Tom",1,t,"ai");n.reset(),n.addToBoard(),n.intelligence=e.difficulty}else if(e.playersPerTeam==="two"){let n=new S("Tom",1,o,"ai");n.reset(),n.addToBoard();let r=new S("Laura",2,t,"ai");r.reset(),r.addToBoard();let i=new S("Sophie",3,t,"ai");i.reset(),i.addToBoard(),e.difficulty==="easy"?(n.intelligence="medium",r.intelligence="easy",i.intelligence="medium"):e.difficulty==="medium"?(n.intelligence="easy",r.intelligence="easy",i.intelligence="medium"):e.difficulty==="hard"&&(n.intelligence="easy",r.intelligence="medium",i.intelligence="hard")}Se()}function Se(){e.isGameOver=!0,e.puck.reset();for(let o of e.players)o.reset();e.isGameOver=!1,e.isGoal=!1,Ve()}function Gt(){qt(),!e.isGoal&&(Ft(),jt())}function Ft(){let o=T*s.width+e.puck.radius,t=s.width*(1-T)-e.puck.radius,n=E*s.height+e.puck.radius,r=s.height*(1-E)-e.puck.radius,i=Ye*s.height+2*e.puck.radius,c=Ke*s.height-2*e.puck.radius;if((e.puck.xPos<o||t<e.puck.xPos)&&i<e.puck.yPos&&e.puck.yPos<c||isNaN(e.puck.xPos)){Xt();return}let a=!1;(e.puck.xPos<=o||t<=e.puck.xPos)&&(e.puck.xVel*=-1,a=!0),(e.puck.yPos<=n||r<=e.puck.yPos)&&(e.puck.yVel*=-1,a=!0),a&&M("boardHit",!1),e.puck.xPos<o&&(e.puck.xPos=o+1),t<e.puck.xPos&&(e.puck.xPos=t-1),e.puck.yPos<n&&(e.puck.yPos=n+1),r<e.puck.yPos&&(e.puck.yPos=r-1)}function qt(){for(let o of e.players){if(o.type!=="ai")continue;let t=s.width/2+o.radius,n=s.width*(1-T)-o.radius;o.team==="left"&&(t=s.width*T+o.radius,n=s.width/2-o.radius);let r=E*s.height+o.radius,i=s.height*(1-E)-o.radius;(o.xPos<=t||n<=o.xPos)&&(o.xVel=0,o.xPos=o.xPos<=t?t+1:n-1),(o.yPos<=r||i<=o.yPos)&&(o.yVel=0,o.yPos=o.yPos<=r?r+1:i-1)}}function jt(){let o=!1;for(let t of e.players){let n=e.puck.xPos-t.xPos,r=e.puck.yPos-t.yPos,i=Math.sqrt(n*n+r*r),c=e.puck.radius+t.radius,a=i<=c,u=window.performance.now()-t.prevCollisionTimestamp<et;if(!a||u)continue;o=!0,t.prevCollisionTimestamp=window.performance.now();let h=n/i,P=r/i;e.puck.xVel=2*(t.xVel*h+t.yVel*P)*h-(e.puck.xVel*h+e.puck.yVel*P)*h,e.puck.yVel=2*(t.xVel*h+t.yVel*P)*P-(e.puck.xVel*h+e.puck.yVel*P)*P,e.puck.xPos=t.xPos+n*c/i,e.puck.yPos=t.yPos+r*c/i}o&&M("playerHit",!1)}function Xt(){let o=7*f/60;e.puck.xVel=Math.sign(e.puck.xVel)*Math.max(o,e.puck.xVel),e.puck.yVel=0,e.isGoal=!0,M("goal",!1),e.puck.xPos<s.width/2?we(X):we(j),setTimeout(Se,2e3)}function Yt(){let o=e.stuckPuckMetrics.prevCheckTimestamp-e.stuckPuckMetrics.startTimestamp,t=e.stuckPuckMetrics.secondsCounter<=Math.floor(o/1e3),n=e.puck.xPos<s.width/2;e.puck.xPos===s.width/2||e.stuckPuckMetrics.wasPuckOnLeftSide!==n?e.stuckPuckMetrics.stuckDuration=0:t&&e.stuckPuckMetrics.stuckDuration++,t&&e.stuckPuckMetrics.secondsCounter++,e.stuckPuckMetrics.prevCheckTimestamp=window.performance.now(),e.stuckPuckMetrics.wasPuckOnLeftSide=n}function $e(){e.stuckPuckMetrics.startTimestamp=window.performance.now(),e.stuckPuckMetrics.prevCheckTimestamp=window.performance.now(),e.stuckPuckMetrics.secondsCounter=0,e.stuckPuckMetrics.stuckDuration=0,e.stuckPuckMetrics.wasPuckOnLeftSide=!1}function ke(){let o=window.visualViewport.width/window.visualViewport.height,t=window.visualViewport.height/window.visualViewport.width,n=16/9;if(Math.abs(o-n)<=.1||Math.abs(t-n)<.1)s.width=window.visualViewport.width,s.height=window.visualViewport.height;else if(Math.abs(o-n)>.1){let r=window.visualViewport.height*16/9;s.width=r,s.height=window.visualViewport.height}else s.width=window.visualViewport.height,s.height=window.visualViewport.width;e.context=s.getContext("2d"),e.puck.adaptToScreen();for(let r of e.players)r.adaptToScreen();e.prevCanvasDim.width=s.width,e.prevCanvasDim.height=s.height}function K(){e.isOnlineGame&&(U("Disconnected"),D()),J(k),e.isPaused=!1,e.isGameOver=!0,e.players=[e.mainPlayer],e.mainPlayer.name="You",e.mainPlayer.type="human",document.removeEventListener("keypress",re),document.removeEventListener("dblclick",ie),j.textContent="0",X.textContent="0",p(s),p(Z),p(ee),W(),m(C)}var ae=class{#o;#t;#s;#e;#r;#i;#n;constructor(t,n){this.reset(),this.#t=Je,this.xVel=t,this.yVel=n,this.#n=ze}get radius(){return this.#o}get xPos(){return this.#s}set xPos(t){isNaN(t)||(this.#s=g(-s.width-2*this.#o,t,s.width+2*this.#o))}get yPos(){return this.#e}set yPos(t){isNaN(t)||(this.#e=g(-s.height-2*this.#o,t,s.height+2*this.#o))}get xVel(){return this.#r}set xVel(t){if(isNaN(t))return;let n=Math.abs(t);n<te&&(t=Math.sign(t)*te),this.#r=Math.sign(t)*Math.min(n,f/3)}get yVel(){return this.#i}set yVel(t){if(isNaN(t))return;let n=Math.abs(t);n<te&&(t=Math.sign(t)*te),this.#i=Math.sign(t)*Math.min(n,f/3)}resetRadius(){this.#o=He*s.width}adaptToScreen(){this.xPos=s.width*this.xPos/e.prevCanvasDim.width,this.yPos=s.height*this.yPos/e.prevCanvasDim.height,this.resetRadius()}reset(){this.resetRadius(),this.xPos=s.width/2,this.yPos=s.height/2,this.xVel=0,this.yVel=0}draw(){let t=e.context;t.beginPath(),t.arc(this.#s,this.#e,this.#o,0,2*Math.PI,!1),t.fillStyle=this.#t,t.fill(),t.closePath()}update(){(!e.isOnlineGame||e.isOnlineGame&&e.isHost)&&(this.xVel*=this.#n,this.yVel*=this.#n,this.xPos+=this.xVel,this.yPos+=this.yVel,Ze<=e.stuckPuckMetrics.stuckDuration&&(this.reset(),$e())),this.draw()}};Kt();function Kt(){ct(),Ne(),Jt(),Wt(),e.mainPlayer=new S("You",0,e.offlineTeam,"main"),e.mainPlayer.reset(),e.mainPlayer.addToBoard(),e.puck=new ae(0,0),je?s.addEventListener("touchmove",o=>It(o)):s.addEventListener("mousemove",o=>vt(o)),window.addEventListener("resize",_t),ke(),l&&Ht()}function Ht(){m(Ee),setInterval(()=>{Ee.textContent=e.fpsMetrics.canvasFpsCounter.toString(),e.fpsMetrics.canvasFpsCounter=0},1e3)}function Wt(){for(let o of document.querySelectorAll(".team-selector"))o.textContent=y(e.offlineTeam),o.dataset.values=G.join(",");for(let o of document.querySelectorAll(".difficulty-selector"))o.textContent=y(e.difficulty),o.dataset.values=ge.join(",");for(let o of document.querySelectorAll(".striker-selector"))o.dataset.value=e.strikerIdx,o.dataset.values=z.join(",");for(let o of document.querySelectorAll(".players-per-team-selector"))o.textContent=y(e.playersPerTeam),o.dataset.values=tt.join(",");for(let o of document.querySelectorAll(".player-type-selector"))o.textContent=y(e.playerType),o.dataset.values=nt.join(",");_.value=oe*100,ue.value=pe*100,me.value=fe*100}function Jt(){window.screen.orientation.addEventListener("change",t=>Ne(t)),document.addEventListener("click",be),document.querySelectorAll("button").forEach(t=>t.addEventListener("click",()=>{M("buttonPress",!1)})),C.querySelector(".online-game-btn").onclick=lt,C.querySelector(".offline-game-btn").onclick=ut;for(let t of de)t.onclick=mt;window.addEventListener("keydown",t=>{t.key==="F11"&&(t.preventDefault(),Re())});for(let t of he)t.onclick=Re;let o=document.querySelector(".settings-btn");o.onclick=dt;for(let t of document.querySelectorAll(".menu .home-btn"))t.onclick=n=>ht(n.target);for(let t of document.querySelectorAll(".menu .selector"))t.addEventListener("click",n=>{pt(n.target),n.target.id==="offline-team-selector"?gt():n.target.classList.contains("difficulty-selector")?yt(n.target):n.target.id==="players-per-team-selector"?xt():n.target.id==="theme-selector"&&kt(),n.target.textContent=y(n.target.textContent)});for(let t of document.querySelectorAll(".img-selector"))t.addEventListener("click",n=>{let r=n.target.closest(".img-selector");ft(r),(r.id==="create-room-striker-selector"||r.id==="join-room-striker-selector")&&St(r)});_.oninput=()=>ye(_),ue.oninput=()=>ye(ue),me.oninput=()=>ye(me),le.querySelector(".start-offline-game-btn").onclick=Lt,x.querySelector(".host-menu-btn").onclick=Pt,x.querySelector(".join-menu-btn").onclick=wt,V.querySelector(".create-room-btn").onclick=Ct,w.querySelector(".join-room-btn").onclick=Tt,w.querySelector(".refresh-btn").onclick=async()=>{b(),await xe(),R()},k.querySelector(".resume-btn").onclick=Oe,k.querySelector(".exit-btn").onclick=Mt}})();
