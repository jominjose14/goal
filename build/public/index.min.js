(()=>{var X=new URL(window.location.href).host,fe=10,pe=10,B=4;var ge=6e4,vt=3,xe=Math.pow(10,vt),T=document.querySelector(".menu.home"),Be=document.querySelector(".menu.settings"),oe=document.querySelector(".menu.offline"),y=document.querySelector(".menu.online"),O=document.querySelector(".menu.host"),w=document.querySelector(".menu.join"),L=document.querySelector(".menu.rotate-screen"),v=document.getElementById("master-volume-slider"),ne=document.getElementById("music-volume-slider"),se=document.getElementById("sfx-volume-slider"),P=document.querySelector(".menu.pause"),j=document.querySelector(".message"),H=document.querySelector(".scores"),$=document.getElementById("left-score"),D=document.getElementById("right-score"),ie=[document.querySelector(".menu.home .mute-toggle-btn"),document.querySelector(".menu.pause .mute-toggle-btn")],re=[document.querySelector(".menu.home .fullscreen-toggle-btn"),document.querySelector(".menu.pause .fullscreen-toggle-btn")],Bt=document.querySelector(".fps-display"),U=document.querySelector(".loading-spinner"),A=document.querySelector(".toast"),s=document.getElementById("board"),x=.008,C=.014,Le=.015,$e=.0225,I=60,ye=1e3/I,Pe=3*(I/60)*16,ke=3*(I/60)*9,Y=1;var Se=2.5;var De=10,Ue=250,Ge=3e3,K=1,ae=.9,ce=.8,Fe=["Left","Right"],we=[];for(let o=0;o<B;o++)we.push(o);var qe=["images/striker-0.svg","images/striker-1.svg","images/striker-2.svg","images/striker-3.svg"],Xe=[{name:"G",color:"hsla(190, 100%, 50%, 1)"},{name:"O",color:"hsla(120, 100%, 50%, 1)"},{name:"A",color:"hsla(53, 100%, 50%, 1)"},{name:"L",color:"hsla(35, 100%, 50%, 1)"}],e={remoteState:{channel:"state",userName:"",isHost:!1,team:"",striker:0,playerXPos:0,playerYPos:0,playerXVel:0,playerYVel:0,puckXPos:0,puckYPos:0,puckXVel:0,puckYVel:0,leftScore:0,rightScore:0},connTimeoutMetrics:{prevMsgTimestamp:0,intervalId:-1},webSocketConn:null,userName:null,isOnlineGame:!1,isHost:!1,context:s.getContext("2d"),prevCanvasDim:{width:s.width,height:s.height},fpsMetrics:{canvasFpsCounter:0,prevFrameTimestamp:0},stuckPuckMetrics:{startTimestamp:0,prevCheckTimestamp:0,secondsCounter:0,stuckDuration:0,wasPuckOnLeftSide:!1},isGoal:!0,isPaused:!1,isGameOver:!0,mainPlayer:null,allPlayers:[],nonMainPlayers:[],puck:null,offlineTeam:"Left",difficulty:"Medium",playersPerTeam:"Two",prevMasterGainValue:K,toastTimeoutId:-1};function je(o){let t=e.context,n=.03*s.height,i=.05*s.height,r=t.measureText(o).width,a=1.25*i,c=(s.width-r)/2,l=(s.height+a-n)/2,u=(s.width-r)/2-n,h=(s.height-a)/2-n,g=r+2*n,S=a+2*n,q=.03*s.height;t.fillStyle="hsla(0, 0%, 20%, 0.95)",t.beginPath(),t.moveTo(u+q,h),t.arcTo(u+g,h,u+g,h+S,q),t.arcTo(u+g,h+S,u,h+S,q),t.arcTo(u,h+S,u,h,q),t.arcTo(u,h,u+g,h,q),t.closePath(),t.fill(),t.beginPath(),t.font=`${i}px "Protest Riot", "Trebuchet MS", sans-serif`,t.textAlign="start",t.textBaseline="alphabetic",t.fillStyle="hsla(0, 0%, 100%, 0.25)",t.fillText(o,c,l),t.closePath()}function f(o,t,n){return Math.max(o,Math.min(t,n))}function He(){let o=navigator.userAgent;return/Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/.test(o)}function m(o){o.classList.remove("hidden")}function p(o){o.classList.add("hidden")}function W(){for(let o of document.querySelectorAll(".menu"))p(o)}function _(){m(U),U.showModal(),U.blur()}function N(){p(U),U.close()}function G(o){clearTimeout(e.toastTimeoutId),p(A),A.querySelector(".toast-msg").textContent=o,A.style.right-=A.width,m(A),e.toastTimeoutId=setTimeout(()=>p(A),Ge)}function Ce(o){return o[0].toUpperCase()+o.substring(1)}function E(o){return o=Math.floor(o*xe),o}function b(o){return o/xe}function Me(o){return isNaN(o.textContent)?0:f(0,parseInt(o.textContent),999)}function Te(o){let t=o.textContent;isNaN(t)&&(t=-1),o.textContent=(parseInt(t)+1).toString(),Ye(o)}function Ie(o,t){let n=o.textContent;isNaN(n)&&(n=0),o.textContent=t.toString(),parseInt(n)!==t&&Ye(o)}function Ye(o){o.classList.remove("strobing-score"),o.offsetWidth,o.classList.add("strobing-score")}function ve(o){o.textContent=o.dataset.values.split(",").at(-1),o.click()}function Ee(o){o.dataset.value=o.dataset.values.split(",").at(-1),o.click()}function Ke(o){o.dataset.values=Fe.join(","),ve(o)}function We(o){o.dataset.values=we.join(","),Ee(o)}function J(o){o.closest("dialog").close()}var k=class{#s;#e;#i;#t;#o;#r;#n;#a;#c=null;#l=0;#u=0;prevCollisionTimestamp=0;constructor(t,n,i,r){this.#s=t,this.#i=n,this.#t=i,this.#o=r,this.#r=e.difficulty,this.resetRadius()}get xPos(){return this.#n}get yPos(){return this.#a}get xVel(){return this.#l}get yVel(){return this.#u}get name(){return this.#s}get radius(){return this.#e}get strikerIdx(){return this.#i}get team(){return this.#t}get intelligence(){return this.#r}set name(t){this.#s=t}set strikerIdx(t){t<0||B<=t||(this.#i=t)}set team(t){this.#t=t}set intelligence(t){t!=="Easy"&&t!=="Medium"&&t!=="Hard"||(this.#r=t)}set xPos(t){if(!isNaN(t))if(this.#t==="left"){let n=x*s.width+this.#e,i=s.width/2-this.#e;this.#n=f(n,t,i)}else{let n=s.width/2+this.#e,i=s.width*(1-x)-this.#e;this.#n=f(n,t,i)}}set yPos(t){if(isNaN(t))return;let n=C*s.height+this.#e,i=s.height*(1-C)-this.#e;this.#a=f(n,t,i)}set xVel(t){isNaN(t)||(this.#l=f(-s.width,t,s.width))}set yVel(t){isNaN(t)||(this.#u=f(-s.height,t,s.height))}addToBoard(){e.allPlayers.push(this),this.#o!=="main"&&e.nonMainPlayers.push(this)}removeFromBoard(){let t=e.nonMainPlayers.indexOf(this);t>-1&&e.nonMainPlayers.splice(t,1),t=e.allPlayers.indexOf(this),t>-1&&e.allPlayers.splice(t,1)}resetRadius(){this.#e=$e*s.width}adaptToScreen(){this.xPos=s.width*this.xPos/e.prevCanvasDim.width,this.yPos=s.height*this.yPos/e.prevCanvasDim.height,this.resetRadius()}reset(){this.resetRadius(),this.#t==="left"?this.xPos=.05*s.width:this.xPos=.95*s.width,this.yPos=s.height/2,this.xVel=0,this.yVel=0}updatePosViaUserInput(t,n){if(this.#t==="left"){let h=x*s.width+this.#e,g=s.width/2-this.#e;t=f(h,t,g)}else{let h=s.width/2+this.#e,g=s.width*(1-x)-this.#e;t=f(h,t,g)}let i=C*s.height+this.#e,r=s.height*(1-C)-this.#e;n=f(i,n,r),this.#c==null&&(this.#c=window.performance.now(),this.xPos=t,this.yPos=n);let a=window.performance.now(),c=Math.max(1,a-this.#c),l=t-this.xPos,u=n-this.yPos;this.xVel=Se*l/c,this.yVel=Se*u/c,this.#c=Date.now(),this.xPos=t,this.yPos=n}onAiCollideWithBounds(){let t=s.width/2+this.#e,n=s.width*(1-x)-this.#e;this.#t==="left"&&(t=s.width*x+this.#e,n=s.width/2-this.#e);let i=C*s.height+this.#e,r=s.height*(1-C)-this.#e;(this.xPos<=t||n<=this.xPos)&&(this.xVel=0,this.xPos=this.xPos<=t?t+1:n-1),(this.yPos<=i||r<=this.yPos)&&(this.yVel=0,this.yPos=this.yPos<=i?i+1:r-1)}easyAiUpdate(){if(e.puck.xPos===s.width/2&&e.puck.yPos===s.height/2)return;if(this.#t==="right"&&e.puck.xPos+e.puck.radius<s.width/2||this.#t==="left"&&s.width/2<e.puck.xPos+e.puck.radius){this.xVel*=.99,this.yVel*=.99;return}if(this.#t==="right"&&-1<Math.sign(e.puck.xVel)||this.#t==="left"&&Math.sign(e.puck.xVel)<1){let r=e.puck.yPos-this.yPos;Math.abs(r)<=.8*(this.radius+e.puck.radius)?this.yVel*=.99:this.yVel=.2*r}this.xPos=this.#t==="right"?.9*s.width:.1*s.width,this.yPos+=this.yVel;let i=10*60/I;this.xVel=(this.team==="right"?-1:1)*Math.max(i,Math.abs(this.xVel))}mediumAiUpdate(){if(e.puck.xPos===s.width/2&&e.puck.yPos===s.height/2)return;let t=this.#t==="right"&&e.puck.xPos+e.puck.radius<s.width/2||this.#t==="left"&&s.width/2<e.puck.xPos+e.puck.radius,n=this.#t==="right"&&this.xPos<e.puck.xPos||this.#t==="left"&&e.puck.xPos<this.xPos,i=this.#t==="right"&&Math.sign(e.puck.xVel)===-1||this.#t==="left"&&Math.sign(e.puck.xVel)===1,r=10*I/60;if(t||n){let a=t?.05:.1;if(this.#t==="right"){let c=s.width*(1-x)-this.radius-this.xPos;this.xVel=a*c}else if(this.#t==="left"){let c=s.width*x+this.radius-this.xPos;this.xVel=a*c}this.yVel=a*(s.height/2-this.yPos)}else if(i&&r<Math.abs(e.puck.xVel))this.xVel*=.99,this.yVel*=.99;else{let a=e.puck.xPos-this.xPos,c=e.puck.yPos-this.yPos,l=.0075,u,h=Math.random();h<.5?u=.35:.5<=h&&h<=.8?u=.2:u=.1,this.xVel+=l*a,this.yVel=u*c}this.xPos+=this.xVel,this.yPos+=this.yVel}hardAiUpdate(){if(e.isGoal)return;let t=this.team==="right"?.9*s.width:.1*s.width,n=s.height/2-e.puck.yPos,i=(s.height*(1-2*C)-2*this.radius)/2,r=e.puck.yPos+e.puck.radius*n/i;this.updatePosViaUserInput(t,r),this.xVel=(this.team==="right"?-1:1)*Math.max(10*60/I,Math.abs(this.xVel)),this.yVel=(e.puck.yPos<this.yPos?-1:1)*Math.max(10*60/I,Math.abs(this.yVel))}update(){if(this.#o==="ai")switch(this.onAiCollideWithBounds(),this.#r){case"Easy":this.easyAiUpdate();break;case"Medium":this.mediumAiUpdate();break;case"Hard":this.hardAiUpdate()}this.draw()}draw(){let t=e.context;t.beginPath(),t.arc(this.#n,this.#a,this.#e,0,2*Math.PI,!1),t.fillStyle="hsla(0, 0%, 100%, 1)",t.fill(),t.closePath(),t.beginPath(),t.arc(this.#n,this.#a,.8*this.#e,0,2*Math.PI,!1),t.fillStyle=Xe[this.#i].color,t.fill(),t.closePath()}};var F=new(window.AudioContext||window.webkitAudioContext),R=F.createGain(),z=F.createGain(),Q=F.createGain(),Je={bgm:"audio/bgm.mp3",buttonPress:"audio/button-press.mp3",boardHit:"audio/board-hit.mp3",playerHit:"audio/player-hit.mp3",goal:"audio/goal.mp3"};z.gain.value=ae;Q.gain.value=ce;R.gain.value=K;z.connect(R);Q.connect(R);R.connect(F.destination);var ze=new Map;function Et(o,t){fetch(t).then(n=>n.arrayBuffer()).then(n=>F.decodeAudioData(n)).then(n=>{ze.set(o,n)}).catch(n=>console.error(`Error loading sound ${o}. Reason: `,n))}function Qe(){for(let o of Object.keys(Je))Et(o,Je[o])}function M(o,t){let n=F.createBufferSource();return n.buffer=ze.get(o),n.buffer===null?!1:(o==="bgm"?n.connect(z):n.connect(Q),n.loop=t,n.start(0),!0)}function Ze(){p(T),y.querySelector(".error-msg").textContent="",m(y),document.getElementById("user-name").focus()}function et(){p(T),m(oe)}function be(){M("bgm",!0)&&document.removeEventListener("click",be)}function tt(){for(let t of ie){let n=t.querySelector("img");n.src.includes("unmuted")?(n.src=n.src.replace("unmuted.svg","muted.svg"),v.disabled=!0,v.style.cursor="not-allowed"):(n.src=n.src.replace("muted.svg","unmuted.svg"),v.disabled=!1,v.style.cursor="grab")}let o=R.gain.value;R.gain.value=R.gain.value===0?e.prevMasterGainValue:0,e.prevMasterGainValue=o}function Re(){for(let o of re){let t=o.querySelector("img");document.fullscreenElement?document.exitFullscreen&&(t.src=t.src.replace("windowed.svg","fullscreen.svg")):t.src=t.src.replace("fullscreen.svg","windowed.svg")}document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}function ot(){p(T),m(Be)}function nt(o){e.webSocketConn!==null&&(e.webSocketConn.close(),V());let t=o.closest(".menu");p(t),m(T)}function st(o){let t=o.dataset.values.split(","),n=o.textContent.trim();for(let i=0;i<t.length;i++)if(t[i]===n){o.textContent=t[(i+1)%t.length];break}}function it(o){let t=o.dataset.values.split(","),n=o.dataset.value;for(let i=0;i<t.length;i++)if(t[i]===n){o.dataset.value=t[(i+1)%t.length];break}}function _e(o){o===void 0&&window.innerWidth<window.innerHeight||o!==void 0&&o.target.type.includes("portrait")?(m(L),L.showModal(),L.blur()):(o===void 0&&window.innerHeight<window.innerWidth||o!==void 0&&o.target.type.includes("landscape"))&&(p(L),J(L))}function rt(){e.offlineTeam=document.getElementById("offline-team-selector").textContent}function at(){e.difficulty=document.getElementById("difficulty-selector").textContent}function ct(){e.playersPerTeam=document.getElementById("players-per-team-selector").textContent}function lt(){e.theme=document.getElementById("theme-selector").textContent}function le(o){o.id==="master-volume-slider"?R.gain.value=f(0,o.value/100,1):o.id==="music-volume-slider"?z.gain.value=f(0,o.value/100,1):o.id==="sfx-volume-slider"&&(Q.gain.value=f(0,o.value/100,1))}function ut(o){let t=o.querySelector("img");t.src=qe[parseInt(o.dataset.value)]}async function mt(){y.querySelector(".error-msg").textContent="",_(),await Oe(),N(),e.webSocketConn!==null&&(p(y),m(O),document.getElementById("create-room-name").focus())}async function dt(){y.querySelector(".error-msg").textContent="",_(),await Oe(),N(),e.webSocketConn!==null&&(p(y),w.querySelector(".error-msg").textContent="",m(w),_(),await ue(),N())}async function ht(){let o=O.querySelector(".error-msg");o.textContent="";let n=document.getElementById("create-room-name").value.trim(),r=document.getElementById("create-room-team-selector").textContent.toLowerCase(),a=document.getElementById("create-room-striker-selector"),c=parseInt(a.dataset.value);_(),await kt(n,r,c),N()}async function ft(){let o=w.querySelector(".error-msg");o.textContent="";let t=document.querySelector(".join-room-list > .join-room-item.selected");if(t===null){o.textContent="Please select a room";return}let n=t.textContent.trim(),r=document.getElementById("join-room-team-selector").textContent.toLowerCase(),a=document.getElementById("join-room-striker-selector"),c=parseInt(a.dataset.value);_(),await St(n,r,c),N()}function Z(o){o.key!=="p"&&o.key!=="P"||(e.isPaused?Ne({target:P}):(M("buttonPress",!1),e.isPaused=!0,m(P),P.showModal(),document.activeElement.blur()))}function ee(){M("buttonPress",!1),e.isPaused=!0,m(P),P.showModal(),document.activeElement.blur()}function Ne(o){J(o.target),p(P),e.isPaused=!1,Ae()}function pt(){e.isOnlineGame?e.webSocketConn.close():de()}function gt(o){let t=o.offsetX!==void 0?o.offsetX:o.layerX,n=o.offsetY!==void 0?o.offsetY:o.layerY;requestAnimationFrame(()=>e.mainPlayer.updatePosViaUserInput(t,n))}function xt(o){let t=o.targetTouches[0].clientX-o.target.getBoundingClientRect().left,n=o.targetTouches[0].clientY-o.target.getBoundingClientRect().top;requestAnimationFrame(()=>e.mainPlayer.updatePosViaUserInput(t,n))}function yt(){requestAnimationFrame(me)}function Pt(o){let t=document.querySelector(".join-room-list > .join-room-item.selected"),n=document.getElementById("join-room-team-selector"),i=document.getElementById("join-room-striker-selector");t!==null&&t.classList.remove("selected"),o.classList.add("selected"),n.dataset.values=o.dataset.teams,ve(n),i.dataset.values=o.dataset.strikers,Ee(i)}function Oe(){return new Promise(o=>{if(e.webSocketConn!==null){o();return}let t=document.getElementById("user-name"),n=y.querySelector(".error-msg");if(n.textContent="",t.value===""){n.textContent="User name cannot be empty",V(),o();return}else if(fe<t.value.length){n.textContent=`User name cannot be more than ${fe} characters`,V(),o();return}e.webSocketConn=new WebSocket(`ws://${X}/user`),e.webSocketConn.onopen=()=>{console.log("Web socket connection established"),e.webSocketConn.send(JSON.stringify({channel:"handshake",userName:t.value.trim()})),console.log("Sent web socket message on 'handshake' channel")},e.webSocketConn.onmessage=i=>{console.log("Received web socket message during handshake");let r=JSON.parse(i.data);if(r.channel!=="handshake"){console.error("Received web socket message from invalid channel during handshake"),e.webSocketConn.close();return}if(console.log("Received web socket message on 'handshake' channel"),r.isSuccess){e.userName=t.value.trim(),e.webSocketConn.onmessage=null,o();return}else{n.textContent=Ce(r.message),e.webSocketConn.close();return}},e.webSocketConn!==null&&(e.webSocketConn.onerror=()=>{console.error("Error during web socket communication"),n.textContent="Error while communicating with server",e.webSocketConn.close()}),e.webSocketConn!==null&&(e.webSocketConn.onclose=()=>{e.userName===null?(console.log("Web socket connection closed"),n.textContent===""&&(n.textContent="Can't connect to server"),V(),o()):console.log("Web socket connection closed due to user clicking home button")})})}function wt(o,t){e.isOnlineGame=!0,e.isPaused=!1,bt(),W(),m(s),m(j),m(H),document.addEventListener("keypress",n=>Z(n)),document.addEventListener("dblclick",ee),e.mainPlayer.name=e.userName,e.mainPlayer.team=o,e.mainPlayer.strikerIdx=t,e.webSocketConn.onmessage=n=>{e.connTimeoutMetrics.prevMsgTimestamp=window.performance.now();let i=JSON.parse(n.data);switch(i.channel){case"memberLeft":{console.log("Received web socket message on 'memberLeft' channel");let r=null;for(let a of e.nonMainPlayers)if(a.name===i.userName){r=a;break}r!==null&&(r.removeFromBoard(),G(`Player ${r.name} left the room`))}break;case"reassignHost":e.isHost=!0,G("You are now the host");break;case"state":{console.log(`Received web socket message on 'state' channel. Remote state originated from remote user ${i.userName}`);let r=!1;for(let a of e.nonMainPlayers)if(a.name===i.userName){r=!0,a.xPos=b(i.playerXPos)*s.width,a.yPos=b(i.playerYPos)*s.height,a.xVel=b(i.playerXVel)*s.width,a.yVel=b(i.playerYVel)*s.height,i.isHost&&(e.puck.xPos=b(i.puckXPos)*s.width,e.puck.yPos=b(i.puckYPos)*s.height,e.puck.xVel=b(i.puckXVel)*s.width,e.puck.yVel=b(i.puckYVel)*s.height,Ie($,i.leftScore),Ie(D,i.rightScore));break}if(!r&&i.userName!==e.userName){if(e.allPlayers.length===B){console.error(`Server is trying to add a new player when room is full; current room count is ${B}`);return}new k(i.userName,i.striker,i.team,"remote").addToBoard(),G(`Player ${i.userName} joined`)}}break;default:console.error(`Received web socket message from invalid channel named '${i.channel}'`)}},e.webSocketConn.onerror=n=>{console.error("Error during web socket communication. Reason: ",n),e.webSocketConn.close()},e.webSocketConn.onclose=()=>{console.log("Web socket connection closed"),de()},he()}async function kt(o,t,n){let i=O.querySelector(".error-msg"),r="http",a=null;if(o===""){i.textContent="Room name cannot be empty";return}else if(pe<o.length){i.textContent=`Room name cannot be more than ${pe} characters`;return}try{a=await fetch(`${r}://${X}/room`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomName:o,userName:e.userName,team:t,striker:n})})}catch(c){console.error("Error occurred while creating room. Reason: ",c),i.textContent="Can't connect to server";return}if(a!==null&&a.ok)e.isHost=!0,wt(t,n);else if(a!==null){let c=await a.text();i.textContent=Ce(c)}else i.textContent="Something went wrong"}async function ue(){let o=w.querySelector(".error-msg"),t="http",n=null;try{n=await fetch(`${t}://${X}/rooms`)}catch(i){console.error("Failed to fetch joinable rooms list. Reason: ",i),o.textContent="Failed to fetch rooms";return}if(n!==null&&n.ok){let i=await n.json(),r=w.querySelector(".join-room-list");if(o.textContent="",r.innerHTML="",i.length===0)r.innerHTML='<div class="no-rooms-msg">Please create a room to play</div>',r.style.justifyContent="center",o.textContent="No rooms available";else{r.style.justifyContent="start";for(let a=0;a<i.length;a++){let c=i[a],l=document.createElement("button");l.classList.add("menu-btn","join-room-item"),l.textContent=c.roomName,l.dataset.idx=a,l.dataset.name=c.roomName;let u=[];c.canJoinLeftTeam&&u.push("Left"),c.canJoinRightTeam&&u.push("Right"),l.dataset.teams=u.join(","),l.dataset.strikers=c.availableStrikers.join(","),l.onclick=()=>Pt(l),r.appendChild(l)}}}else o.textContent="Something went wrong";Ke(document.getElementById("join-room-team-selector")),We(document.getElementById("join-room-striker-selector"))}async function St(o,t,n){let i=w.querySelector(".error-msg");i.textContent="";let r="http",a=null;try{a=await fetch(`${r}://${X}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomName:o,userName:e.userName,team:t,striker:n})})}catch(c){console.error("Error occurred while joining room. Reason: ",c),i.textContent="Can't connect to server";return}a!==null&&a.ok?(e.isHost=!1,wt(t,n)):a!==null?i.textContent=await a.text():i.textContent="Something went wrong"}function Ct(){if(e.webSocketConn===null){console.error("Cannot send remote state to server as web socket connection does not exist");return}e.remoteState.userName=e.userName,e.remoteState.isHost=e.isHost,e.remoteState.team=e.mainPlayer.team,e.remoteState.striker=e.mainPlayer.strikerIdx,e.remoteState.playerXPos=E(e.mainPlayer.xPos/s.width),e.remoteState.playerYPos=E(e.mainPlayer.yPos/s.height),e.remoteState.playerXVel=E(e.mainPlayer.xVel/s.width),e.remoteState.playerYVel=E(e.mainPlayer.yVel/s.height),e.isHost?(e.remoteState.puckXPos=E(e.puck.xPos/s.width),e.remoteState.puckYPos=E(e.puck.yPos/s.height),e.remoteState.puckXVel=E(e.puck.xVel/s.width),e.remoteState.puckYVel=E(e.puck.yVel/s.height),e.remoteState.leftScore=Me($),e.remoteState.rightScore=Me(D)):(e.remoteState.puckXPos=void 0,e.remoteState.puckYPos=void 0,e.remoteState.puckXVel=void 0,e.remoteState.puckYVel=void 0,e.remoteState.leftScore=void 0,e.remoteState.rightScore=void 0),e.webSocketConn.send(JSON.stringify(e.remoteState))}function bt(){e.connTimeoutMetrics.prevMsgTimestamp=window.performance.now(),e.connTimeoutMetrics.intervalId=setInterval(Rt,ge/2)}function Rt(){if(!e.isOnlineGame||e.webSocketConn===null)return;let o=window.performance.now()-e.connTimeoutMetrics.prevMsgTimestamp;ge<o&&e.webSocketConn.close()}function _t(){clearInterval(e.connTimeoutMetrics.intervalId),e.connTimeoutMetrics.intervalId=-1,e.connTimeoutMetrics.prevMsgTimestamp=1/0}function V(){_t(),e.webSocketConn=null,e.userName=null,e.mainPlayer.name="You",e.mainPlayer.team="left",e.mainPlayer.strikerIdx=0,e.isOnlineGame=!1,e.isHost=!1}function Ae(){Ve(),e.fpsMetrics.prevFrameTimestamp=window.performance.now(),requestAnimationFrame(Mt)}function Mt(){!e.isGameOver&&(e.isOnlineGame||!e.isPaused)&&requestAnimationFrame(Mt),e.isGoal||Nt();let o=window.performance.now(),t=o-e.fpsMetrics.prevFrameTimestamp;if(!(t<ye)){if(e.fpsMetrics.prevFrameTimestamp=o-t%ye,e.isOnlineGame&&Ct(),e.context.clearRect(0,0,s.width,s.height),e.nonMainPlayers.length===0){je("Waiting for other players to join");return}e.puck.update();for(let n of e.allPlayers)n.update();e.fpsMetrics.canvasFpsCounter++}}function Tt(){e.isOnlineGame=!1,e.isPaused=!1,W(),m(s),m(j),m(H),document.addEventListener("keypress",n=>Z(n)),document.addEventListener("dblclick",ee),e.mainPlayer.team=e.offlineTeam.toLowerCase(),e.mainPlayer.reset();let o=e.offlineTeam.toLowerCase(),t=o==="left"?"right":"left";if(e.playersPerTeam==="One"){let n=new k("Tom",1,t,"ai");n.reset(),n.addToBoard(),n.intelligence=e.difficulty}else if(e.playersPerTeam==="Two"){let n=new k("Tom",1,o,"ai");n.reset(),n.addToBoard();let i=new k("Laura",2,t,"ai");i.reset(),i.addToBoard();let r=new k("Sophie",3,t,"ai");r.reset(),r.addToBoard(),e.difficulty==="Easy"?(n.intelligence="Medium",i.intelligence="Easy",r.intelligence="Medium"):e.difficulty==="Medium"?(n.intelligence="Easy",i.intelligence="Easy",r.intelligence="Medium"):e.difficulty==="Hard"&&(n.intelligence="Easy",i.intelligence="Medium",r.intelligence="Hard")}he()}function he(){e.isGameOver=!0,e.puck.reset();for(let o of e.allPlayers)o.reset();e.isGameOver=!1,e.isGoal=!1,Ae()}function It(){let o=7*I/60;e.puck.xVel=Math.sign(e.puck.xVel)*Math.max(o,e.puck.xVel),e.puck.yVel=0,e.isGoal=!0,M("goal",!1),e.puck.xPos<s.width/2?Te(D):Te($),setTimeout(he,2e3)}function Nt(){let o=e.stuckPuckMetrics.prevCheckTimestamp-e.stuckPuckMetrics.startTimestamp,t=e.stuckPuckMetrics.secondsCounter<=Math.floor(o/1e3),n=e.puck.xPos<s.width/2;e.puck.xPos===s.width/2||e.stuckPuckMetrics.wasPuckOnLeftSide!==n?e.stuckPuckMetrics.stuckDuration=0:t&&e.stuckPuckMetrics.stuckDuration++,t&&e.stuckPuckMetrics.secondsCounter++,e.stuckPuckMetrics.prevCheckTimestamp=window.performance.now(),e.stuckPuckMetrics.wasPuckOnLeftSide=n}function Ve(){e.stuckPuckMetrics.startTimestamp=window.performance.now(),e.stuckPuckMetrics.prevCheckTimestamp=window.performance.now(),e.stuckPuckMetrics.secondsCounter=0,e.stuckPuckMetrics.stuckDuration=0,e.stuckPuckMetrics.wasPuckOnLeftSide=!1}function me(){let o=window.visualViewport.width/window.visualViewport.height,t=window.visualViewport.height/window.visualViewport.width,n=16/9;if(Math.abs(o-n)<=.1||Math.abs(t-n)<.1)s.width=window.visualViewport.width,s.height=window.visualViewport.height;else if(Math.abs(o-n)>.1){let i=window.visualViewport.height*16/9;s.width=i,s.height=window.visualViewport.height}else s.width=window.visualViewport.height,s.height=window.visualViewport.width;e.context=s.getContext("2d"),e.puck.adaptToScreen();for(let i of e.allPlayers)i.adaptToScreen();e.prevCanvasDim.width=s.width,e.prevCanvasDim.height=s.height}function de(){e.isOnlineGame&&(G("Disconnected"),V()),J(P),e.isPaused=!1,e.isGameOver=!0,e.allPlayers=[e.mainPlayer],e.nonMainPlayers=[],e.mainPlayer.name="You",document.removeEventListener("keypress",Z),document.removeEventListener("dblclick",ee),$.textContent="0",D.textContent="0",p(s),p(j),p(H),W(),m(T)}var te=class{#s;#e;#i;#t;#o;#r;#n=.999;constructor(t,n,i,r){this.xVel=t,this.yVel=n,this.#o=i,this.#r=r}get xPos(){return this.#s}get yPos(){return this.#e}get xVel(){return this.#i}get yVel(){return this.#t}get radius(){return this.#o}set xPos(t){isNaN(t)||(this.#s=f(-s.width-2*this.#o,t,s.width+2*this.#o))}set yPos(t){isNaN(t)||(this.#e=f(-s.height-2*this.#o,t,s.height+2*this.#o))}set xVel(t){isNaN(t)||(Math.abs(t)<Y&&(t=Math.sign(t)*Y),this.#i=f(-s.width/Pe,t,s.width/Pe))}set yVel(t){isNaN(t)||(Math.abs(t)<Y&&(t=Math.sign(t)*Y),this.#t=f(-s.height/ke,t,s.height/ke))}resetRadius(){this.#o=Le*s.width}adaptToScreen(){this.xPos=s.width*this.xPos/e.prevCanvasDim.width,this.yPos=s.height*this.yPos/e.prevCanvasDim.height,this.resetRadius()}reset(){this.resetRadius(),this.xPos=s.width/2,this.yPos=s.height/2,this.xVel=0,this.yVel=0}draw(){let t=e.context;t.beginPath(),t.arc(this.#s,this.#e,this.#o,0,2*Math.PI,!1),t.fillStyle=this.#r,t.fill(),t.closePath()}update(){(!e.isOnlineGame||e.isOnlineGame&&e.isHost)&&(this.xVel*=this.#n,this.yVel*=this.#n,e.isGoal||this.reactToCollisions(),this.xPos+=this.xVel,this.yPos+=this.yVel,De<=e.stuckPuckMetrics.stuckDuration&&(this.reset(),Ve())),this.draw()}reactToCollisions(){this.handleBoardCollisions(),this.handlePlayerCollisions()}handleBoardCollisions(){let t=x*s.width+this.#o,n=s.width*(1-x)-this.#o,i=C*s.height+this.#o,r=s.height*(1-C)-this.#o,a=320/900*s.height+2*this.#o,c=580/900*s.height-2*this.#o;if((this.xPos<t||n<this.xPos)&&a<this.yPos&&this.yPos<c||isNaN(this.xPos)){It();return}let l=!1;(this.xPos<=t||n<=this.xPos)&&(this.xVel*=-1,l=!0),(this.yPos<=i||r<=this.yPos)&&(this.yVel*=-1,l=!0),l&&M("boardHit",!1),this.xPos<t&&(this.xPos=t+1),n<this.xPos&&(this.xPos=n-1),this.yPos<i&&(this.yPos=i+1),r<this.yPos&&(this.yPos=r-1)}handlePlayerCollisions(){let t=!1;for(let n of e.allPlayers){let i=this.xPos-n.xPos,r=this.yPos-n.yPos,a=Math.sqrt(i*i+r*r),c=this.radius+n.radius,l=a<=c,h=window.performance.now()-n.prevCollisionTimestamp<Ue;if(!l||h)continue;t=!0,n.prevCollisionTimestamp=window.performance.now();let g=i/a,S=r/a;this.xVel=2*(n.xVel*g+n.yVel*S)*g-(this.xVel*g+this.yVel*S)*g,this.yVel=2*(n.xVel*g+n.yVel*S)*S-(this.xVel*g+this.yVel*S)*S,this.xPos=n.xPos+i*c/a,this.yPos=n.yPos+r*c/a}t&&M("playerHit",!1)}};Ot();function Ot(){Qe(),_e(),Vt(),At(),e.mainPlayer=new k("You",0,e.offlineTeam,"main"),e.mainPlayer.reset(),e.mainPlayer.addToBoard(),e.puck=new te(0,0,20,"hsla(0, 0%, 100%, 1)"),He()?s.addEventListener("touchmove",o=>xt(o)):s.addEventListener("mousemove",o=>gt(o)),window.addEventListener("resize",yt),me()}function At(){document.getElementById("offline-team-selector").textContent=e.offlineTeam,document.getElementById("difficulty-selector").textContent=e.difficulty,document.getElementById("players-per-team-selector").textContent=e.playersPerTeam,v.value=K*100,ne.value=ae*100,se.value=ce*100}function Vt(){window.screen.orientation.addEventListener("change",t=>_e(t)),document.addEventListener("click",be),document.querySelectorAll("button").forEach(t=>t.addEventListener("click",()=>{M("buttonPress",!1)})),T.querySelector(".online-game-btn").onclick=Ze,T.querySelector(".offline-game-btn").onclick=et;for(let t of ie)t.onclick=tt;window.addEventListener("keydown",t=>{t.key==="F11"&&(t.preventDefault(),Re())});for(let t of re)t.onclick=Re;let o=document.querySelector(".settings-btn");o.onclick=ot;for(let t of document.querySelectorAll(".menu .home-btn"))t.onclick=n=>nt(n.target);for(let t of document.querySelectorAll(".menu .selector"))t.addEventListener("click",n=>{st(n.target),n.target.id==="offline-team-selector"?rt():n.target.id==="difficulty-selector"?at():n.target.id==="players-per-team-selector"?ct():n.target.id==="theme-selector"&&lt()});for(let t of document.querySelectorAll(".img-selector"))t.addEventListener("click",n=>{let i=n.target.closest(".img-selector");it(i),(i.id==="create-room-striker-selector"||i.id==="join-room-striker-selector")&&ut(i)});v.oninput=()=>le(v),ne.oninput=()=>le(ne),se.oninput=()=>le(se),oe.querySelector(".start-offline-game-btn").onclick=Tt,y.querySelector(".host-menu-btn").onclick=mt,y.querySelector(".join-menu-btn").onclick=dt,O.querySelector(".create-room-btn").onclick=ht,w.querySelector(".join-room-btn").onclick=ft,w.querySelector(".refresh-btn").onclick=async()=>{_(),await ue(),N()},P.querySelector(".resume-btn").onclick=Ne,P.querySelector(".exit-btn").onclick=pt}})();
